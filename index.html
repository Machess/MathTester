<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pok√©mon Math Challenge</title>
    <style>
        /* ===== MODERN POK√âMON DESIGN SYSTEM ===== */
        :root {
            /* Official Pok√©mon Colors */
            --pokemon-red: #EE1515;
            --pokemon-blue: #3B4CCA;
            --pokemon-yellow: #FFCB05;
            --pokemon-white: #FFFFFF;
            
            /* UI Colors */
            --primary: #3B4CCA;
            --primary-dark: #2D3A9F;
            --primary-light: #5B6FE8;
            --secondary: #FFCB05;
            --secondary-dark: #E0B000;
            --accent: #EE1515;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            
            /* Neutral Colors */
            --bg-light: #F5F7FA;
            --bg-white: #FFFFFF;
            --text-dark: #2C3E50;
            --text-medium: #546E7A;
            --text-light: #90A4AE;
            
            /* Design System */
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
            --shadow-xl: 0 12px 32px rgba(0, 0, 0, 0.18);
            
            --border-width: 2px;
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-blue: linear-gradient(135deg, #4A90E2 0%, #3B4CCA 100%);
            --gradient-red: linear-gradient(135deg, #FF6B6B 0%, #EE1515 100%);
            --gradient-yellow: linear-gradient(135deg, #FFD93D 0%, #FFCB05 100%);
            --gradient-card: linear-gradient(135deg, #FFFFFF 0%, #F8F9FA 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
            color: var(--text-dark);
        }

        /* Page Routing */
        .page {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .page.active {
            display: block;
        }

        /* Modern Navigation Bar */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            border-bottom: var(--border-width) solid rgba(59, 76, 202, 0.1);
        }

        .nav-bar.hidden {
            display: none;
        }

        .nav-brand {
            color: var(--primary);
            font-size: 1.5em;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .nav-buttons {
            display: flex;
            gap: var(--spacing-sm);
        }

        .nav-btn {
            background: var(--bg-white);
            border: var(--border-width) solid var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }

        .nav-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .page-content {
            margin-top: 80px;
        }

        /* Modern Start Screen */
        .start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            gap: var(--spacing-xl);
        }

        .game-logo {
            background: linear-gradient(135deg, #ffcb05 0%, #ffd700 100%);
            border: 5px solid #3b4cca;
            border-radius: 30px;
            padding: 40px 60px;
            margin-bottom: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .game-logo h1 {
            font-size: 4em;
            color: #3b4cca;
            text-shadow: 3px 3px 0px #fff;
            margin-bottom: 10px;
        }

        .game-logo .subtitle {
            font-size: 1.5em;
            color: #3b4cca;
            font-weight: bold;
        }

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Modern Button System */
        .start-btn, .settings-btn {
            background: var(--gradient-blue);
            color: white;
            border: none;
            padding: var(--spacing-lg) var(--spacing-xl);
            font-size: 1.3em;
            font-weight: 600;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .start-btn::before, .settings-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .start-btn:hover::before, .settings-btn:hover::before {
            left: 100%;
        }

        .start-btn:hover, .settings-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .start-btn:active, .settings-btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .settings-btn {
            background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
            font-size: 1.1em;
        }

        .reset-game-btn {
            background: var(--gradient-red);
        }

        .reset-game-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            width: 100%;
            max-width: 400px;
        }

        /* Modern Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(4px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .settings-modal.active {
            display: flex;
        }

        /* Modern Settings Content */
        .settings-content {
            background: var(--bg-white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: var(--border-width) solid rgba(59, 76, 202, 0.1);
        }

        .settings-content h2 {
            color: var(--primary);
            margin-bottom: var(--spacing-xl);
            text-align: center;
            font-size: 2em;
            font-weight: 700;
        }

        .setting-group {
            margin-bottom: var(--spacing-lg);
            background: var(--bg-light);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: var(--border-width) solid rgba(0,0,0,0.05);
        }

        .setting-group label {
            display: block;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: var(--spacing-sm);
            font-size: 1.1em;
        }

        .setting-group select,
        .setting-group input {
            width: 100%;
            padding: var(--spacing-sm);
            border: var(--border-width) solid #E5E7EB;
            border-radius: var(--radius-sm);
            font-size: 1em;
            background: white;
            transition: all 0.2s;
        }

        .setting-group select:focus,
        .setting-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 76, 202, 0.1);
        }

        .operation-settings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .operation-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm);
            background: white;
            border-radius: var(--radius-sm);
            border: var(--border-width) solid #E5E7EB;
            cursor: pointer;
            transition: all 0.2s;
        }

        .operation-checkbox:hover {
            border-color: var(--primary);
            background: #F8F9FA;
        }

        .operation-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .save-settings-btn {
            width: 100%;
            background: var(--gradient-blue);
            color: white;
            border: none;
            padding: var(--spacing-md);
            font-size: 1.2em;
            font-weight: 600;
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-top: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .save-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Modern Bush Selection Screen */
        .bush-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            gap: var(--spacing-xl);
        }

        .bush-screen h2 {
            color: white;
            font-size: 2.5em;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 4px 12px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #FFFFFF 0%, #F0F0F0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .bushes-container {
            display: flex;
            gap: var(--spacing-xl);
            justify-content: center;
            flex-wrap: wrap;
            padding: var(--spacing-lg);
        }

        .bush {
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            padding: var(--spacing-lg);
            border-radius: var(--radius-xl);
            backdrop-filter: blur(10px);
            border: var(--border-width) solid rgba(255, 255, 255, 0.2);
        }

        .bush:hover {
            transform: translateY(-10px) scale(1.08);
            box-shadow: 0 12px 32px rgba(59, 76, 202, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }

        .bush.checked {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.2);
        }

        .bush.checked:hover {
            transform: none;
            box-shadow: none;
        }

        .bush.checked .bush-image {
            filter: grayscale(1) drop-shadow(0 4px 12px rgba(0,0,0,0.2));
        }

        .bush.checked .bush-label {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .bush-image {
            width: 150px;
            height: 150px;
            font-size: 8em;
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.2));
            transition: all 0.3s;
        }

        .bush:hover .bush-image {
            transform: scale(1.1);
            filter: drop-shadow(0 12px 24px rgba(59, 76, 202, 0.4));
        }

        .bush-label {
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            margin-top: var(--spacing-sm);
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .empty-bush-message {
            display: none;
        }

        /* Modern Game Screen */
        .game-screen {
            min-height: 100vh;
        }

        .pokedex-header {
            text-align: center;
            color: white;
            margin-bottom: var(--spacing-xl);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: var(--spacing-lg);
            border-radius: var(--radius-xl);
            border: var(--border-width) solid rgba(255, 255, 255, 0.2);
        }

        .pokedex-title {
            font-size: 3em;
            font-weight: 800;
            text-shadow: 0 4px 16px rgba(0,0,0,0.3);
            margin-bottom: var(--spacing-md);
            background: linear-gradient(135deg, #FFFFFF 0%, #FFCB05 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pokedex-title-logo {
            max-width: 400px;
            width: 80%;
            height: auto;
            margin: 0 auto var(--spacing-md) auto;
            display: block;
            filter: drop-shadow(0 4px 16px rgba(0,0,0,0.2));
        }

        .pokedex-controls {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }

        .pokedex-controls .reset-button,
        .pokedex-controls .mute-button {
            position: relative;
            top: auto;
            right: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: var(--spacing-xl);
        }

        /* Modern Control Buttons */
        .mute-button {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            border: var(--border-width) solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
        }

        .mute-button:hover {
            background: white;
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-lg);
        }

        .mute-button.muted {
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border-color: var(--danger);
        }

        .reset-button {
            position: absolute;
            top: 0;
            right: 70px;
            background: rgba(255,0,0,0.3);
            border: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
        }

        .reset-button:hover {
            background: rgba(255,0,0,0.5);
            transform: scale(1.1);
        }

        h1 {
            font-size: 3em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .stats {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            display: inline-block;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Force dark text in stat boxes */
        .stat-box.stats,
        .stat-box.stats .stat-label,
        .stat-box.stats .stat-value {
            color: var(--text-dark) !important;
        }

        /* Modern Stats Container */
        .stats-container {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            min-width: 150px;
            border: var(--border-width) solid rgba(255, 255, 255, 0.5);
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .stat-label {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-dark);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Modern Badges Button */
        .badges-button {
            background: var(--gradient-yellow);
            border: var(--border-width) solid var(--secondary-dark);
            color: var(--text-dark);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-md);
            min-width: 150px;
        }

        .badges-button:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .badge-notification {
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .badge-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--gradient-red);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 700;
            border: 3px solid white;
            box-shadow: var(--shadow-sm);
        }

        /* Modern Badge Modal */
        .badge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        .badge-modal.active {
            display: flex;
        }

        .badge-modal-content {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-xl);
            border: var(--border-width) solid rgba(59, 76, 202, 0.1);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .badge-modal-content h2 {
            color: var(--primary);
            margin-bottom: var(--spacing-sm);
            text-align: center;
            font-size: 2em;
        }

        .badge-modal-content .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .badge-item {
            background: #f3f4f6;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .badge-item.unlocked {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #ffcb05;
            box-shadow: 0 4px 15px rgba(255, 203, 5, 0.3);
        }

        .badge-item.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .badge-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .badge-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .badge-description {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .badge-progress {
            font-size: 0.8em;
            color: #3b4cca;
            font-weight: bold;
        }

        .stats-section {
            background: #f3f4f6;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .stats-section h3 {
            color: #3b4cca;
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-item-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-item-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #3b4cca;
        }

        /* New Badge Popup */
        .new-badge-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            z-index: 3000;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: badgePopIn 0.5s ease;
        }

        @keyframes badgePopIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .new-badge-popup h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .new-badge-popup .badge-icon {
            font-size: 4em;
            margin: 20px 0;
        }

        .new-badge-popup .badge-name {
            font-size: 1.5em;
            color: #ffcb05;
        }

        /* Pokemon Info Modal */
        .pokemon-info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            animation: modal-fade-in 0.3s ease-out;
        }

        @keyframes modal-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .pokemon-info-modal.active {
            display: flex;
        }

        /* POK√âDEX DEVICE CONTAINER */
        .pokemon-info-content {
            background: linear-gradient(135deg, #CC0000 0%, #AA0000 100%);
            border: 8px solid #8B0000;
            border-radius: 25px;
            padding: 0;
            max-width: 650px;
            width: 92%;
            max-height: 92vh;
            overflow: hidden;
            position: relative;
            box-shadow: 
                0 0 0 3px #000,
                0 20px 60px rgba(0,0,0,0.6),
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -2px 4px rgba(0,0,0,0.3);
            animation: pokedex-open 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes pokedex-open {
            0% {
                transform: scale(0.3) rotateX(90deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotateX(0deg);
                opacity: 1;
            }
        }

        /* POK√âDEX TOP BAR (iconic lights and buttons) */
        .pokemon-info-content::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #4DD0E1 0%, #00ACC1 100%);
            border: 5px solid #fff;
            border-radius: 50%;
            box-shadow: 
                0 0 20px rgba(77, 208, 225, 0.8),
                inset 0 -3px 10px rgba(0,0,0,0.3),
                inset 0 3px 10px rgba(255,255,255,0.5);
            z-index: 10;
        }

        /* Small indicator lights */
        .pokemon-info-content::after {
            content: '';
            position: absolute;
            top: 30px;
            left: 100px;
            width: 150px;
            height: 20px;
            display: flex;
            gap: 12px;
            z-index: 10;
            background: 
                radial-gradient(circle at 10px center, #EF5350 0%, #C62828 100%) 0 0 / 20px 20px no-repeat,
                radial-gradient(circle at 42px center, #FFEB3B 0%, #F9A825 100%) 30px 0 / 20px 20px no-repeat,
                radial-gradient(circle at 74px center, #66BB6A 0%, #388E3C 100%) 60px 0 / 20px 20px no-repeat;
            box-shadow: 
                0 2px 8px rgba(0,0,0,0.4);
        }

        /* POK√âDEX SCREEN */
        .pokemon-info-header {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 6px solid #1B5E20;
            border-radius: 12px;
            margin: 90px 25px 20px 25px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 
                inset 0 0 30px rgba(0,0,0,0.1),
                inset 0 4px 8px rgba(255,255,255,0.3),
                0 4px 12px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Screen scanlines effect */
        .pokemon-info-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.03) 2px,
                rgba(0,0,0,0.03) 4px
            );
            pointer-events: none;
            border-radius: 6px;
        }

        /* Small screen indicators */
        .pokemon-info-header::after {
            content: '‚óè  ‚óè';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            color: #C62828;
            font-size: 8px;
            letter-spacing: 6px;
        }

        .pokemon-info-sprite {
            width: 120px;
            height: 120px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .pokemon-info-title {
            flex: 1;
        }

        .pokemon-info-title h2 {
            color: #1B5E20;
            font-size: 2em;
            margin: 0 0 5px 0;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pokemon-info-number {
            color: #558B2F;
            font-size: 1.1em;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* POK√âDEX DATA PANELS */
        .pokemon-info-section {
            background: rgba(0,0,0,0.15);
            border: 3px solid rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px 20px;
            margin: 0 25px 15px 25px;
        }

        .pokemon-info-section h3 {
            color: #FFFFFF;
            font-size: 1.2em;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .pokemon-types {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .type-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            color: white;
        }

        /* Type colors */
        .type-normal { background: #A8A878; }
        .type-fire { background: #F08030; }
        .type-water { background: #6890F0; }
        .type-electric { background: #F8D030; color: #333; }
        .type-grass { background: #78C850; }
        .type-ice { background: #98D8D8; }
        .type-fighting { background: #C03028; }
        .type-poison { background: #A040A0; }
        .type-ground { background: #E0C068; }
        .type-flying { background: #A890F0; }
        .type-psychic { background: #F85888; }
        .type-bug { background: #A8B820; }
        .type-rock { background: #B8A038; }
        .type-ghost { background: #705898; }
        .type-dragon { background: #7038F8; }
        .type-dark { background: #705848; }
        .type-steel { background: #B8B8D0; }
        .type-fairy { background: #EE99AC; }

        .pokemon-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .stat-label {
            color: #FFEB3B;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .stat-value {
            color: #fff;
            font-size: 1.2em;
            font-weight: 700;
        }

        .pokemon-story {
            color: #fff;
            line-height: 1.7;
            font-size: 1em;
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #FFEB3B;
        }

        /* CLOSE BUTTON - Pok√©dex style */
        .pokemon-info-content .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #1B5E20 0%, #2E7D32 100%);
            color: #FFEB3B;
            border: 4px solid #000;
            border-radius: 50%;
            font-size: 2em;
            line-height: 42px;
            cursor: pointer;
            z-index: 20;
            transition: all 0.2s;
            box-shadow: 
                0 0 0 2px #fff,
                0 4px 12px rgba(0,0,0,0.5),
                inset 0 2px 4px rgba(255,255,255,0.3);
        }

        .pokemon-info-content .close-btn:hover {
            background: linear-gradient(135deg, #2E7D32 0%, #43A047 100%);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 
                0 0 0 2px #fff,
                0 6px 20px rgba(0,0,0,0.6),
                inset 0 2px 4px rgba(255,255,255,0.4);
        }

        /* SCROLLABLE CONTENT AREA */
        #pokemonInfoDisplay {
            max-height: calc(92vh - 120px);
            overflow-y: auto;
            padding-bottom: 25px;
        }

        /* Custom scrollbar for Pok√©dex */
        #pokemonInfoDisplay::-webkit-scrollbar {
            width: 12px;
        }

        #pokemonInfoDisplay::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin: 10px;
        }

        #pokemonInfoDisplay::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #FFEB3B 0%, #F9A825 100%);
            border-radius: 6px;
            border: 2px solid rgba(0,0,0,0.3);
        }

        #pokemonInfoDisplay::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #FFF176 0%, #FFB300 100%);
        }

        .loading-spinner {
            color: #FFEB3B;
            font-size: 2em;
            text-align: center;
            padding: 60px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }

        /* ===== POKEBALL CATCH ANIMATION SYSTEM ===== */
        .pokeball-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .pokeball-container.active {
            display: block;
        }

        .pokeball {
            width: 60px;
            height: 60px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="%23ff0000" stroke="%23000" stroke-width="2"/><rect x="0" y="48" width="100" height="4" fill="%23000"/><circle cx="50" cy="50" r="15" fill="%23fff" stroke="%23000" stroke-width="2"/><circle cx="50" cy="50" r="8" fill="%23fff" stroke="%23000" stroke-width="2"/></svg>') center/contain no-repeat;
        }

        .pokeball.throwing {
            animation: pokeball-throw 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes pokeball-throw {
            0% { 
                transform: translateY(300px) scale(0.3) rotate(0deg);
                opacity: 0;
            }
            30% { 
                transform: translateY(-50px) scale(1) rotate(360deg);
                opacity: 1;
            }
            100% { 
                transform: translateY(0) scale(1) rotate(720deg);
            }
        }

        .pokeball.shaking {
            animation: pokeball-shake 0.8s ease-in-out 3;
        }

        @keyframes pokeball-shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-12px) rotate(-8deg); }
            20%, 40%, 60%, 80% { transform: translateX(12px) rotate(8deg); }
        }

        .pokeball.opening {
            animation: pokeball-open 0.5s ease-out forwards;
        }

        @keyframes pokeball-open {
            0% { transform: scale(1); filter: brightness(1); }
            50% { 
                transform: scale(1.3);
                filter: brightness(2) drop-shadow(0 0 30px gold);
            }
            100% { 
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Particle system */
        .particle {
            position: absolute;
            pointer-events: none;
        }

        .confetti-particle {
            width: 8px;
            height: 12px;
            animation: confetti-burst 1s ease-out forwards;
        }

        @keyframes confetti-burst {
            0% { 
                transform: translate(0, 0) rotate(0deg) scale(0);
                opacity: 1;
            }
            100% { 
                transform: translate(var(--x), var(--y)) rotate(720deg) scale(1);
                opacity: 0;
            }
        }

        .star-particle {
            font-size: 20px;
            animation: star-burst 1.2s ease-out forwards;
        }

        @keyframes star-burst {
            0% { 
                transform: translate(0, 0) scale(0) rotate(0deg);
                opacity: 1;
            }
            100% { 
                transform: translate(var(--x), var(--y)) scale(1.5) rotate(180deg);
                opacity: 0;
            }
        }

        .sparkle-particle {
            font-size: 16px;
            animation: sparkle-float 1.5s ease-out forwards;
        }

        @keyframes sparkle-float {
            0% { 
                transform: translate(0, 0) scale(0);
                opacity: 1;
            }
            100% { 
                transform: translate(var(--x), var(--y)) scale(1);
                opacity: 0;
            }
        }

        .energy-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 4px solid;
            border-radius: 50%;
            opacity: 0.8;
            animation: energy-expand 0.8s ease-out forwards;
            pointer-events: none;
        }

        @keyframes energy-expand {
            0% { 
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }

        .flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 999;
        }

        .flash-overlay.active {
            animation: screen-flash 0.3s ease-out;
        }

        @keyframes screen-flash {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }
        /* ===== END POKEBALL ANIMATION ===== */

        /* ===== BATTLE ATTACK ANIMATIONS ===== */
        
        /* Charge-up glow effect */
        .battle-pokemon-sprite.charging {
            animation: charge-attack 0.3s ease-out forwards;
        }

        @keyframes charge-attack {
            0% { 
                filter: brightness(1) drop-shadow(0 0 0 transparent);
                transform: scale(1);
            }
            100% { 
                filter: brightness(1.5) drop-shadow(0 0 30px var(--attack-color));
                transform: scale(1.05);
            }
        }

        /* Attack projectile/beam */
        .attack-projectile {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }

        .attack-beam {
            width: 40px;
            height: 200px;
            background: linear-gradient(90deg, transparent 0%, var(--attack-color) 50%, transparent 100%);
            filter: blur(3px);
            opacity: 0.9;
        }

        .attack-beam.launching {
            animation: beam-travel 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes beam-travel {
            0% { 
                transform: translateX(0) scaleX(0.1);
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            100% { 
                transform: translateX(var(--beam-distance)) scaleX(1);
                opacity: 0.8;
            }
        }

        /* Impact explosion */
        .impact-burst {
            position: absolute;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--attack-color) 0%, transparent 70%);
            pointer-events: none;
            z-index: 99;
        }

        .impact-burst.exploding {
            animation: impact-explode 0.4s ease-out forwards;
        }

        @keyframes impact-explode {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                opacity: 0.9;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* Attack particles */
        .attack-particle {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
        }

        .attack-particle.burst {
            animation: particle-burst 0.8s ease-out forwards;
        }

        @keyframes particle-burst {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(var(--px), var(--py)) scale(0.3) rotate(720deg);
                opacity: 0;
            }
        }

        /* Screen shake effect */
        .battle-field.screen-shake {
            animation: screen-shake 0.3s ease-in-out;
        }

        @keyframes screen-shake {
            0%, 100% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 2px); }
            20%, 40%, 60%, 80% { transform: translate(5px, -2px); }
        }

        /* Screen flash effect */
        .battle-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--flash-color);
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .battle-flash.active {
            animation: screen-flash 0.3s ease-out;
        }

        @keyframes screen-flash {
            0% { opacity: 0; }
            50% { opacity: 0.6; }
            100% { opacity: 0; }
        }

        /* Damage number */
        .damage-number {
            position: absolute;
            font-size: 3em;
            font-weight: bold;
            color: var(--damage-color);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 101;
        }

        .damage-number.float-up {
            animation: damage-float 1.2s ease-out forwards;
        }

        @keyframes damage-float {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            20% {
                opacity: 1;
                transform: translateY(-20px) scale(1.2);
            }
            100% {
                transform: translateY(-100px) scale(0.8);
                opacity: 0;
            }
        }

        /* Type-specific particle effects */
        .fire-particle::before {
            content: 'üî•';
        }

        .water-particle::before {
            content: 'üíß';
        }

        .electric-particle::before {
            content: '‚ö°';
        }

        .grass-particle::before {
            content: 'üçÉ';
        }

        .ice-particle::before {
            content: '‚ùÑÔ∏è';
        }

        .fighting-particle::before {
            content: 'üëä';
        }

        .poison-particle::before {
            content: '‚ò†Ô∏è';
        }

        .ground-particle::before {
            content: 'üåç';
        }

        .flying-particle::before {
            content: 'ü¶Ö';
        }

        .psychic-particle::before {
            content: 'üîÆ';
        }

        .bug-particle::before {
            content: 'üêõ';
        }

        .rock-particle::before {
            content: 'ü™®';
        }

        .ghost-particle::before {
            content: 'üëª';
        }

        .dragon-particle::before {
            content: 'üêâ';
        }

        .dark-particle::before {
            content: 'üåô';
        }

        .steel-particle::before {
            content: '‚öôÔ∏è';
        }

        .fairy-particle::before {
            content: '‚ú®';
        }

        .normal-particle::before {
            content: '‚≠ê';
        }

        /* Hit animation when taking damage */
        .battle-pokemon-sprite.hit {
            animation: sprite-hit 0.5s ease-out;
        }

        @keyframes sprite-hit {
            0%, 100% { transform: translateX(0); filter: brightness(1); }
            10%, 30%, 50%, 70%, 90% { 
                transform: translateX(-8px); 
                filter: brightness(1.5);
            }
            20%, 40%, 60%, 80% { 
                transform: translateX(8px);
                filter: brightness(0.8);
            }
        }
        /* ===== END BATTLE ATTACK ANIMATIONS ===== */


        .loading-spinner {
            text-align: center;
            padding: 40px;
            font-size: 2em;
        }

        /* Battle Mode Styles */
        .battle-screen {
            min-height: 100vh;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8D8 50%, #8B7355 100%);
            padding: 20px;
        }

        .battle-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .team-selection {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .team-selection h2 {
            color: #3b4cca;
            text-align: center;
            margin-bottom: 20px;
        }

        .available-pokemon {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .selectable-pokemon {
            background: #f3f4f6;
            border: 3px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .selectable-pokemon:hover {
            transform: translateY(-5px);
            border-color: #ffcb05;
        }

        .selectable-pokemon.selected {
            border-color: #22c55e;
            background: #d1fae5;
        }

        .selectable-pokemon.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .selected-team {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .team-slot {
            width: 100px;
            height: 120px;
            border: 3px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            background: #f9fafb;
        }

        .team-slot.filled {
            border-style: solid;
            border-color: #22c55e;
            background: white;
            flex-direction: column;
            padding: 5px;
        }

        .team-slot img {
            width: 60px;
            height: 60px;
        }

        .team-slot .slot-name {
            font-size: 0.4em;
            margin-top: 5px;
        }

        .start-battle-btn {
            width: 100%;
            padding: 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-battle-btn:hover {
            background: #dc2626;
            transform: scale(1.02);
        }

        .start-battle-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* Battle Arena */
        .battle-arena {
            display: none;
        }

        .battle-arena.active {
            display: block;
        }

        .battle-field {
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8D8 50%, #8FBC8F 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 450px;
            position: relative;
        }

        .battle-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 20px;
        }

        .trainer-side {
            flex: 1;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .trainer-side.player {
            text-align: left;
            border: 3px solid #22c55e;
        }

        .trainer-side.opponent {
            text-align: right;
            border: 3px solid #ef4444;
        }

        .trainer-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .trainer-side.player .trainer-name {
            color: #22c55e;
        }

        .trainer-side.opponent .trainer-name {
            color: #ef4444;
        }

        .battle-pokemon-display {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 350px;
            position: relative;
        }

        .battle-pokemon {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        /* Hide Pokemon by default, show only during their turn */
        .battle-pokemon.player-pokemon {
            display: none;
        }

        .battle-pokemon.opponent-pokemon {
            display: none;
        }

        /* Show Pokemon when it's their turn */
        .battle-pokemon.player-pokemon.active-turn {
            display: block;
        }

        .battle-pokemon.opponent-pokemon.active-turn {
            display: block;
        }

        .battle-pokemon-sprite {
            width: 220px;
            height: 220px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            margin: 20px auto;
        }

        .battle-pokemon-sprite.attacking {
            animation: attackMove 0.6s ease;
        }

        @keyframes attackMove {
            0%, 100% { transform: translateX(0) scale(1); }
            50% { transform: translateX(40px) scale(1.2); }
        }

        .battle-pokemon.opponent-pokemon .battle-pokemon-sprite.attacking {
            animation: attackMoveLeft 0.6s ease;
        }

        @keyframes attackMoveLeft {
            0%, 100% { transform: translateX(0) scale(1); }
            50% { transform: translateX(-40px) scale(1.2); }
        }

        .battle-pokemon-sprite.hit {
            animation: hitShake 0.5s ease;
        }

        @keyframes hitShake {
            0%, 100% { transform: translateX(0); filter: brightness(1); }
            25%, 75% { transform: translateX(-10px); filter: brightness(2); }
            50% { transform: translateX(10px); filter: brightness(0.5); }
        }

        .battle-pokemon-sprite.fainted {
            animation: faint 1s ease forwards;
        }

        @keyframes faint {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(50px) scale(0.3); }
        }

        .pokemon-name-battle {
            font-size: 1.5em;
            font-weight: bold;
            color: #1f2937;
            margin: 10px 0;
        }

        .pokemon-health-bar {
            background: #e5e7eb;
            border-radius: 10px;
            height: 25px;
            margin: 10px auto;
            overflow: hidden;
            border: 3px solid #1f2937;
            max-width: 250px;
            position: relative;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #22c55e, #16a34a);
            transition: width 0.5s ease, background 0.3s ease;
            position: relative;
        }

        .health-fill.low {
            background: linear-gradient(to right, #f59e0b, #d97706);
        }

        .health-fill.critical {
            background: linear-gradient(to right, #ef4444, #dc2626);
        }

        .pokemon-info-bar {
            margin-top: 8px;
            font-size: 1em;
            font-weight: bold;
            color: #1f2937;
        }

        .battle-log {
            background: #1f2937;
            color: white;
            border-radius: 15px;
            padding: 20px;
            min-height: 120px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            border: 3px solid #374151;
        }

        .battle-log-entry {
            margin-bottom: 8px;
            padding: 6px 10px;
            border-left: 4px solid #3b82f6;
            padding-left: 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
        }

        .battle-log-entry.damage {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .battle-log-entry.heal {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .battle-log-entry.super-effective {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            font-weight: bold;
        }

        .battle-controls {
            background: white;
            border-radius: 20px;
            padding: 30px;
        }

        .attack-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .attack-name {
            font-size: 2em;
            font-weight: bold;
            color: #3b4cca;
            margin-bottom: 10px;
        }

        .attack-type {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .team-pokemon-list {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .team-pokemon-item {
            width: 80px;
            padding: 10px;
            background: #f3f4f6;
            border: 3px solid #ddd;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .team-pokemon-item.active {
            border-color: #22c55e;
            background: #d1fae5;
        }

        .team-pokemon-item.fainted {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .team-pokemon-item img {
            width: 50px;
            height: 50px;
        }

        .battle-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .battle-result-modal.active {
            display: flex;
        }

        .battle-result-content {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
        }

        .battle-result-content h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .battle-result-content.victory h2 {
            color: #22c55e;
        }

        .battle-result-content.defeat h2 {
            color: #ef4444;
        }

        .battle-reward {
            background: #fef3c7;
            border: 3px solid #ffcb05;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .battle-reward h3 {
            color: #3b4cca;
            margin-bottom: 10px;
        }

        /* Battle Mode Styles */
        .battle-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            position: relative;
            overflow: hidden;
        }

        .battle-field {
            position: relative;
            height: 400px;
            margin: 20px auto;
            max-width: 800px;
            perspective: 1000px;
        }

        .battle-pokemon {
            position: absolute;
            text-align: center;
            transition: all 0.3s ease;
        }

        .battle-pokemon.player {
            bottom: 20px;
            left: 20px;
        }

        .battle-pokemon.opponent {
            top: 20px;
            right: 20px;
        }

        .battle-sprite {
            width: 150px;
            height: 150px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }

        .battle-sprite.attacking {
            animation: attack 0.6s ease;
        }

        @keyframes attack {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(30px) scale(1.2); }
        }

        .battle-sprite.hit {
            animation: hit 0.5s ease;
        }

        @keyframes hit {
            0%, 100% { transform: translateX(0); filter: brightness(1); }
            25%, 75% { transform: translateX(-10px); filter: brightness(2); }
            50% { transform: translateX(10px); filter: brightness(0.5); }
        }

        .battle-sprite.fainted {
            animation: faint 1s ease forwards;
        }

        @keyframes faint {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(50px) scale(0.5); }
        }

        .health-bar-container {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .pokemon-name-battle {
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
            margin-bottom: 5px;
        }

        .health-bar {
            width: 200px;
            height: 25px;
            background: #ddd;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid #333;
            position: relative;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            transition: width 0.5s ease, background 0.3s ease;
            position: relative;
        }

        .health-fill.low {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .health-fill.medium {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            z-index: 1;
        }

        .battle-controls {
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 20px;
            max-width: 800px;
            margin: 20px auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .battle-question {
            font-size: 1.8em;
            font-weight: bold;
            color: #3b4cca;
            margin-bottom: 20px;
            text-align: center;
        }

        .battle-message {
            background: #3b4cca;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1em;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attack-animation {
            position: absolute;
            font-size: 3em;
            pointer-events: none;
            z-index: 10;
        }

        .attack-animation.fire {
            animation: fireAttack 1s ease forwards;
        }

        @keyframes fireAttack {
            0% { opacity: 1; transform: scale(0.5) translate(0, 0); }
            50% { opacity: 1; transform: scale(1.5) translate(200px, -100px); }
            100% { opacity: 0; transform: scale(0.5) translate(400px, -200px); }
        }

        .attack-animation.water {
            animation: waterAttack 1s ease forwards;
        }

        @keyframes waterAttack {
            0% { opacity: 1; transform: scale(0.5) translate(0, 0); }
            50% { opacity: 1; transform: scale(1.5) translate(200px, -100px) rotate(180deg); }
            100% { opacity: 0; transform: scale(0.5) translate(400px, -200px) rotate(360deg); }
        }

        .attack-animation.electric {
            animation: electricAttack 0.6s ease forwards;
        }

        @keyframes electricAttack {
            0% { opacity: 1; transform: translate(0, 0); }
            100% { opacity: 0; transform: translate(400px, -200px); filter: brightness(3); }
        }

        .attack-animation.grass {
            animation: grassAttack 1s ease forwards;
        }

        @keyframes grassAttack {
            0% { opacity: 1; transform: scale(1) translate(0, 0); }
            50% { opacity: 1; transform: scale(1.2) translate(200px, -100px); }
            100% { opacity: 0; transform: scale(0.8) translate(400px, -200px); }
        }

        .team-selection {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 900px;
            margin: 20px auto;
        }

        .team-selection h2 {
            color: #3b4cca;
            text-align: center;
            margin-bottom: 20px;
        }

        .available-pokemon {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .selectable-pokemon {
            background: #f3f4f6;
            border: 3px solid transparent;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .selectable-pokemon:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .selectable-pokemon.selected {
            border-color: #3b4cca;
            background: #e0e7ff;
        }

        .selectable-pokemon.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .selected-team {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .selected-team h3 {
            color: #3b4cca;
            margin-bottom: 15px;
        }

        .team-display {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .battle-result {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            max-width: 600px;
            margin: 20px auto;
        }

        .battle-result h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .battle-result.victory h2 {
            color: #22c55e;
        }

        .battle-result.defeat h2 {
            color: #ef4444;
        }

        .battle-reward {
            background: #fef3c7;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 3px solid #ffcb05;
        }

        .operation-filters {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .operation-btn {
            background: rgba(255,255,255,0.3);
            border: 3px solid white;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .operation-btn:hover {
            background: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .operation-btn.active {
            background: #ffcb05;
            color: #3b4cca;
            border-color: #ffcb05;
            box-shadow: 0 4px 15px rgba(255, 203, 5, 0.4);
        }

        .grade-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 12px;
            border: 3px solid white;
        }

        .grade-selector label {
            color: white;
            font-weight: bold;
            font-size: 1em;
            white-space: nowrap;
        }

        .grade-selector select {
            background: white;
            color: #3b4cca;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            min-width: 120px;
        }

        .grade-selector select:focus {
            outline: 2px solid #ffcb05;
        }

        /* Modern Pokemon Grid */
        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: var(--spacing-md);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: var(--border-width) solid rgba(255, 255, 255, 0.5);
        }

        /* Modern Pokemon Card */
        .pokemon-card {
            background: var(--gradient-card);
            border: var(--border-width) solid var(--secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }

        .pokemon-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .pokemon-card.caught {
            background: linear-gradient(135deg, #FFFFFF 0%, #E8F5E9 100%);
            border-color: var(--success);
        }

        .pokemon-card.caught:hover {
            border-color: #2E7D32;
        }

        .pokemon-card.uncaught {
            background: linear-gradient(135deg, #F5F5F5 0%, #E0E0E0 100%);
            border-color: #BDBDBD;
            opacity: 0.7;
        }

        .pokemon-card.uncaught .pokemon-sprite {
            filter: grayscale(0.8) brightness(0.7);
        }

        .pokemon-sprite {
            width: 70px;
            height: 70px;
            margin: 0 auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pokemon-card:hover .pokemon-sprite {
            transform: scale(1.2);
            filter: brightness(1.1) drop-shadow(0 4px 12px rgba(59, 76, 202, 0.3));
        }

        .pokemon-card.caught:hover .pokemon-sprite {
            animation: wiggle 0.5s ease infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: scale(1.2) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-8deg); }
            75% { transform: scale(1.2) rotate(8deg); }
        }

        .pokemon-name {
            font-size: 0.8em;
            margin-top: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-dark);
        }

        .pokemon-number {
            font-size: 0.7em;
            color: var(--text-medium);
            font-weight: 500;
        }

        /* Modern Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            max-width: 600px;
            width: 90%;
            position: relative;
            box-shadow: var(--shadow-xl);
            border: var(--border-width) solid rgba(59, 76, 202, 0.1);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close-btn {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            font-size: 2em;
            cursor: pointer;
            color: var(--text-medium);
            background: var(--bg-light);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .pokemon-display {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 30px;
        }

        .pokemon-modal-sprite {
            width: 120px;
            height: 120px;
            animation: pokemonEntrance 0.6s ease-out;
        }

        @keyframes pokemonEntrance {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }
            60% {
                transform: scale(1.1) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .pokemon-modal-sprite.catching {
            animation: catchShake 0.8s ease-in-out;
        }

        @keyframes catchShake {
            0%, 100% { transform: translateX(0) scale(1); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px) scale(1.05); }
            20%, 40%, 60%, 80% { transform: translateX(10px) scale(0.95); }
        }

        .pokemon-modal-sprite.caught-success {
            animation: caughtSuccess 1s ease-out;
        }

        @keyframes caughtSuccess {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3) rotate(360deg); opacity: 0.8; }
            100% { transform: scale(0.5); opacity: 0; }
        }

        .pokemon-modal-sprite.run-away {
            animation: runAway 0.6s ease-in;
        }

        @keyframes runAway {
            0% { transform: translateX(0) scale(1); opacity: 1; }
            100% { transform: translateX(200px) scale(0.3); opacity: 0; }
        }

        .speech-bubble {
            background: #fff;
            border: 3px solid #333;
            border-radius: 20px;
            padding: 20px;
            position: relative;
            flex: 1;
        }

        .speech-bubble:before {
            content: '';
            position: absolute;
            left: -20px;
            top: 30px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 20px 10px 0;
            border-color: transparent #333 transparent transparent;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            left: -14px;
            top: 33px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 7px 14px 7px 0;
            border-color: transparent #fff transparent transparent;
        }

        .math-problem {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .answer-section {
            text-align: center;
        }

        .answer-input {
            font-size: 1.5em;
            padding: 15px;
            border: 3px solid #ffcb05;
            border-radius: 10px;
            width: 200px;
            text-align: center;
            margin-bottom: 20px;
        }

        .submit-btn {
            background: #3b4cca;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #2a3799;
            transform: scale(1.05);
        }

        .feedback {
            margin-top: 20px;
            font-size: 1.3em;
            font-weight: bold;
            min-height: 30px;
        }

        .feedback.correct {
            color: #22c55e;
        }

        .feedback.incorrect {
            color: #ef4444;
        }

        .celebration {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-size: 2em;
            animation: bounce 0.5s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .ran-away-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            z-index: 2000;
            display: none;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: fadeInOut 2s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        /* Confirmation Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .confirm-content h2 {
            color: #ef4444;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .confirm-content p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn.cancel {
            background: #6b7280;
            color: white;
        }

        .confirm-btn.cancel:hover {
            background: #4b5563;
        }

        .confirm-btn.confirm {
            background: #ef4444;
            color: white;
        }

        .confirm-btn.confirm:hover {
            background: #dc2626;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .page {
                padding: 10px;
            }

            .page-content {
                margin-top: 70px;
            }

            .nav-bar {
                padding: 10px 15px;
            }

            .nav-brand {
                font-size: 1.2em;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .game-logo h1 {
                font-size: 2.5em;
            }

            .game-logo .subtitle {
                font-size: 1.2em;
            }

            .game-logo {
                padding: 30px 40px;
            }

            .start-btn, .settings-btn {
                padding: 15px 40px;
                font-size: 1.2em;
            }

            .bush-screen h2 {
                font-size: 1.8em;
                margin-bottom: 30px;
            }

            .bushes-container {
                gap: 20px;
            }

            .bush-image {
                width: 100px;
                height: 100px;
                font-size: 5em;
            }

            .settings-content {
                padding: 30px 20px;
            }

            .operation-settings {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }

            .pokedex-title {
                font-size: 2em;
            }

            .pokedex-controls {
                gap: 10px;
            }

            .pokedex-controls .reset-button,
            .pokedex-controls .mute-button {
                width: 50px;
                height: 50px;
                font-size: 1.3em;
            }

            .pokedex-filters {
                padding: 15px;
            }

            .stats {
                font-size: 1em;
                padding: 10px;
            }

            .stats-container {
                gap: 10px;
            }

            .stat-box {
                padding: 10px 15px;
                min-width: 120px;
            }

            .stat-label {
                font-size: 0.75em;
            }

            .stat-value {
                font-size: 1.1em;
            }

            .badges-button {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .badge-count {
                width: 20px;
                height: 20px;
                font-size: 0.7em;
            }

            .badge-modal-content {
                padding: 20px;
            }

            .badge-modal-content h2 {
                font-size: 1.5em;
            }

            .badges-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }

            .badge-item {
                padding: 15px;
            }

            .badge-icon {
                font-size: 2.5em;
            }

            .badge-name {
                font-size: 1em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .new-badge-popup {
                padding: 30px 20px;
                width: 90%;
            }

            .new-badge-popup h3 {
                font-size: 1.4em;
            }

            .new-badge-popup .badge-icon {
                font-size: 3em;
            }

            .pokemon-info-content {
                padding: 30px 20px;
            }

            .pokemon-info-header {
                flex-direction: column;
                text-align: center;
            }

            .pokemon-info-sprite {
                width: 100px;
                height: 100px;
            }

            .pokemon-info-title h2 {
                font-size: 1.6em;
            }

            .pokemon-stats {
                grid-template-columns: 1fr;
            }

            .battle-field {
                height: auto;
                padding: 15px;
            }

            .battle-pokemon-sprite {
                width: 140px;
                height: 140px;
            }

            .battle-pokemon-display {
                flex-direction: column;
                padding: 0 10px;
                gap: 30px;
            }

            .battle-pokemon {
                max-width: 100%;
                width: 100%;
            }

            .battle-pokemon.player-pokemon,
            .battle-pokemon.opponent-pokemon {
                margin: 0;
            }

            .battle-status {
                flex-direction: column;
                gap: 10px;
            }

            .pokemon-health-bar {
                max-width: 250px;
                margin: 10px auto;
            }

            .attack-name {
                font-size: 1.3em;
            }

            .battle-controls {
                padding: 20px;
            }

            .battle-log {
                font-size: 0.85em;
                max-height: 100px;
                min-height: 80px;
            }

            .available-pokemon {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }

            .operation-filters {
                gap: 8px;
                margin-top: 15px;
            }

            .operation-btn {
                padding: 10px 16px;
                font-size: 0.9em;
                min-width: 80px;
                flex: 1 1 calc(50% - 8px);
                max-width: calc(50% - 8px);
            }

            .grade-selector {
                width: 100%;
                justify-content: center;
                padding: 10px;
            }

            .grade-selector label {
                font-size: 0.9em;
            }

            .grade-selector select {
                font-size: 0.9em;
                padding: 6px 10px;
                min-width: 100px;
            }

            .mute-button {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }

            .reset-button {
                width: 50px;
                height: 50px;
                font-size: 1.3em;
                right: 60px;
            }

            .pokemon-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 10px;
                padding: 15px;
            }

            .pokemon-card {
                padding: 8px;
            }

            .pokemon-sprite {
                width: 50px;
                height: 50px;
            }

            .pokemon-name {
                font-size: 0.65em;
            }

            .pokemon-number {
                font-size: 0.55em;
            }

            /* Mobile Modal Styles */
            .modal-content {
                padding: 20px;
                width: 95%;
                max-width: 95%;
                margin: 10px;
            }

            .close-btn {
                top: 10px;
                right: 10px;
                font-size: 1.5em;
            }

            .pokemon-display {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .pokemon-modal-sprite {
                width: 100px;
                height: 100px;
            }

            .speech-bubble {
                padding: 15px;
                width: 100%;
            }

            .speech-bubble:before,
            .speech-bubble:after {
                display: none; /* Hide speech bubble arrow on mobile for cleaner look */
            }

            .math-problem {
                font-size: 1.4em;
                margin-bottom: 15px;
            }

            .answer-input {
                font-size: 1.2em;
                padding: 12px;
                width: 100%;
                max-width: 250px;
            }

            .submit-btn {
                padding: 12px 30px;
                font-size: 1em;
                width: 100%;
                max-width: 250px;
            }

            .feedback {
                font-size: 1.1em;
            }

            .celebration {
                font-size: 1.5em;
            }

            .ran-away-notification {
                font-size: 1.3em;
                padding: 30px 40px;
                width: 90%;
            }

            .confirm-content {
                padding: 30px 20px;
            }

            .confirm-content h2 {
                font-size: 1.5em;
            }

            .confirm-content p {
                font-size: 1em;
            }

            .confirm-buttons {
                flex-direction: column;
            }

            .confirm-btn {
                width: 100%;
                padding: 12px 30px;
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }

            .operation-btn {
                padding: 8px 12px;
                font-size: 0.85em;
                min-width: 70px;
            }

            .pokemon-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
                padding: 10px;
            }

            .pokemon-sprite {
                width: 45px;
                height: 45px;
            }

            .modal-content {
                padding: 15px;
            }

            .math-problem {
                font-size: 1.2em;
            }

            .answer-input {
                font-size: 1.1em;
                padding: 10px;
            }

            .submit-btn {
                font-size: 0.9em;
                padding: 10px 25px;
            }
        }

        /* Landscape mode on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }

            .pokemon-display {
                flex-direction: row;
                gap: 10px;
            }

            .pokemon-modal-sprite {
                width: 80px;
                height: 80px;
            }

            .speech-bubble {
                padding: 10px;
            }

            .math-problem {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar (hidden on start screen) -->
    <div class="nav-bar hidden" id="navBar">
        <div class="nav-brand">POK√âMON Math</div>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="navigateTo('menu')">üè† Menu</button>
            <button class="nav-btn" onclick="navigateTo('hunt')">üå≥ Hunt</button>
            <button class="nav-btn" onclick="navigateTo('battle')">‚öîÔ∏è Battle</button>
            <button class="nav-btn" onclick="navigateTo('pokedex')">üìñ Pok√©dex</button>
        </div>
    </div>

    <!-- START MENU PAGE -->
    <div class="page active" id="menuPage">
        <div class="start-screen">
            <img src="logo.png" alt="Pok√©mon" style="max-width: 500px; width: 90%; height: auto; margin-bottom: 50px; display: block; margin-left: auto; margin-right: auto; background: transparent;">
            <div class="start-buttons">
                <button class="start-btn" onclick="startGame()">‚ñ∂ Start Game</button>
                <button class="start-btn" onclick="startBattleFromMenu()" style="background: #ef4444;">‚öîÔ∏è Battle Mode</button>
                <button class="settings-btn" onclick="openSettings()">‚öô Settings</button>
                <button class="badges-button" style="margin-top: 20px;" onclick="openBadgeModal()">
                    <div class="badge-notification">
                        üèÜ My Badges
                        <span class="badge-count" id="badge-count-menu">0</span>
                    </div>
                </button>
                <button class="reset-game-btn start-btn" onclick="showFullResetConfirmation()">üîÑ Reset All Progress</button>
            </div>
        </div>
    </div>

    <!-- BUSH HUNTING PAGE -->
    <div class="page" id="huntPage">
        <div class="bush-screen">
            <h2 id="bushHeader">üåø Choose a bush to search! üåø</h2>
            <div class="bushes-container">
                <div class="bush" id="bush-0" onclick="selectBush(0)">
                    <div class="bush-image">üå≥</div>
                    <div class="bush-label">Bush 1</div>
                </div>
                <div class="bush" id="bush-1" onclick="selectBush(1)">
                    <div class="bush-image">üå≥</div>
                    <div class="bush-label">Bush 2</div>
                </div>
                <div class="bush" id="bush-2" onclick="selectBush(2)">
                    <div class="bush-image">üå≥</div>
                    <div class="bush-label">Bush 3</div>
                </div>
            </div>
        </div>
    </div>

    <!-- BATTLE MODE PAGE -->
    <div class="page" id="battlePage">
        <div class="battle-screen">
            <div class="battle-container">
                <!-- Team Selection Screen -->
                <div id="teamSelectionScreen" class="team-selection">
                    <h2>‚öîÔ∏è Select Your Battle Team ‚öîÔ∏è</h2>
                    <p style="text-align: center; color: #666; margin-bottom: 20px;">
                        Choose 3 Pok√©mon from your collection to battle!
                    </p>
                    
                    <div class="selected-team" id="selectedTeamDisplay"></div>

                    <h3 style="text-align: center; margin: 20px 0;">Available Pok√©mon:</h3>
                    <div class="available-pokemon" id="availablePokemon"></div>

                    <button class="start-battle-btn" onclick="startBattleMode()" id="startBattleBtn" disabled>
                        ‚öîÔ∏è Start Battle!
                    </button>
                </div>

                <!-- Battle Arena Screen -->
                <div id="battleArenaScreen" style="display: none;">
                    <!-- Battle flash overlay -->
                    <div class="battle-flash" id="battleFlash"></div>
                    
                    <div class="battle-field" id="battleField">
                        <!-- Battle Status - Team Overview -->
                        <div class="battle-status">
                            <div class="trainer-side player">
                                <div class="trainer-name">üë§ YOUR TEAM</div>
                                <div class="team-pokemon-list" id="playerTeamList"></div>
                            </div>
                            <div class="trainer-side opponent">
                                <div class="trainer-name">RIVAL TRAINER ü§ñ</div>
                                <div class="team-pokemon-list" id="opponentTeamList"></div>
                            </div>
                        </div>

                        <!-- Pokemon Display - Main Battle Area -->
                        <div class="battle-pokemon-display">
                            <div class="battle-pokemon player-pokemon">
                                <div class="pokemon-name-battle" id="playerPokemonName">Your Pok√©mon</div>
                                <img class="battle-pokemon-sprite" id="playerSprite" src="" alt="">
                                <div class="pokemon-health-bar">
                                    <div class="health-fill" id="playerHealthFill" style="width: 100%;"></div>
                                </div>
                                <div class="pokemon-info-bar" id="playerHealthText">HP: 100/100</div>
                            </div>

                            <div class="battle-pokemon opponent-pokemon">
                                <div class="pokemon-name-battle" id="opponentPokemonName">Opponent Pok√©mon</div>
                                <img class="battle-pokemon-sprite" id="opponentSprite" src="" alt="">
                                <div class="pokemon-health-bar">
                                    <div class="health-fill" id="opponentHealthFill" style="width: 100%;"></div>
                                </div>
                                <div class="pokemon-info-bar" id="opponentHealthText">HP: 100/100</div>
                            </div>
                        </div>
                    </div>

                    <!-- Battle Controls -->
                    <div class="battle-controls">
                        <div class="battle-message" id="battleMessage">
                            Get ready to battle!
                        </div>

                        <div class="attack-display">
                            <div class="attack-name" id="attackNameDisplay"></div>
                            <div class="attack-type" id="attackTypeDisplay"></div>
                        </div>

                        <div class="battle-question" id="battleQuestionText"></div>
                        <div class="answer-section" style="text-align: center; margin-top: 20px;">
                            <input type="number" inputmode="numeric" pattern="[0-9]*" class="answer-input" id="battleAnswerInput" placeholder="Enter answer" style="font-size: 1.5em; padding: 15px; width: 200px;">
                            <br>
                            <button class="submit-btn" onclick="submitBattleAnswer()" style="margin-top: 15px; padding: 15px 40px; font-size: 1.2em;">‚öîÔ∏è Attack!</button>
                        </div>
                    </div>

                    <!-- Battle Log -->
                    <div class="battle-log" id="battleLog"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Battle Result Modal -->
    <div class="battle-result-modal" id="battleResultModal">
        <div class="battle-result-content" id="battleResultContent">
            <h2 id="battleResultTitle">Victory!</h2>
            <p id="battleResultMessage"></p>
            <div class="battle-reward" id="battleRewardDisplay" style="display: none;"></div>
            <button class="start-btn" onclick="closeBattleResult()" style="margin: 10px;">Battle Again</button>
            <button class="settings-btn" onclick="navigateTo('menu'); closeBattleResult();">Main Menu</button>
        </div>
    </div>

    <!-- POK√âDEX PAGE -->
    <div class="page" id="pokedexPage">
        <div class="page-content">
            <div class="pokedex-header">
                <img src="logo.png" alt="Pok√©dex" class="pokedex-title-logo">
                
                <div class="pokedex-controls">
                    <button class="mute-button" id="muteButton" onclick="toggleMute()" title="Toggle Sound">
                        üîä
                    </button>
                    <button class="reset-button" id="resetButton" onclick="showResetConfirmation()" title="Reset All Caught Pok√©mon">
                        üîÑ
                    </button>
                </div>

                <div class="stats-container" style="margin-bottom: 20px;">
                    <div class="stat-box stats">
                        <div class="stat-label">Pok√©mon Caught</div>
                        <div class="stat-value"><span id="caught-count">0</span> / 150</div>
                    </div>
                    <div class="stat-box stats">
                        <div class="stat-label">üî• Current Streak</div>
                        <div class="stat-value"><span id="streak-count">0</span></div>
                    </div>
                    <button class="badges-button" onclick="openBadgeModal()">
                        <div class="badge-notification">
                            üèÜ My Badges
                            <span class="badge-count" id="badge-count">0</span>
                        </div>
                    </button>
                </div>
            </div>

            <div class="container">
                <div class="pokemon-grid" id="pokemonGrid"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <button class="close-btn" onclick="closeSettings()">√ó</button>
            <h2>‚öôÔ∏è Game Settings</h2>
            
            <div class="setting-group">
                <label for="settingsGrade">üìö Grade Level</label>
                <select id="settingsGrade">
                    <option value="1">1st Grade (Age 6)</option>
                    <option value="2">2nd Grade (Age 7)</option>
                    <option value="3">3rd Grade (Age 8)</option>
                    <option value="4" selected>4th Grade (Age 9)</option>
                    <option value="5">5th Grade (Age 10)</option>
                    <option value="6">6th Grade (Age 11)</option>
                    <option value="7">7th Grade (Age 12)</option>
                    <option value="8">8th Grade (Age 13)</option>
                    <option value="9">9th Grade (Age 14)</option>
                    <option value="10">10th Grade (Age 15-16)</option>
                </select>
            </div>

            <div class="setting-group">
                <label>üé≤ Math Operations (Select at least one)</label>
                <div class="operation-settings">
                    <label class="operation-checkbox">
                        <input type="checkbox" id="opAddition" value="addition" checked>
                        <span>‚ûï Addition</span>
                    </label>
                    <label class="operation-checkbox">
                        <input type="checkbox" id="opSubtraction" value="subtraction" checked>
                        <span>‚ûñ Subtraction</span>
                    </label>
                    <label class="operation-checkbox">
                        <input type="checkbox" id="opMultiplication" value="multiplication" checked>
                        <span>‚úñÔ∏è Multiplication</span>
                    </label>
                    <label class="operation-checkbox">
                        <input type="checkbox" id="opDivision" value="division" checked>
                        <span>‚ûó Division</span>
                    </label>
                </div>
            </div>

            <button class="save-settings-btn" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <!-- Math Problem Modal -->
    <div class="modal" id="mathModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">√ó</button>
            
            <!-- Pokeball catch animation elements -->
            <div class="pokeball-container" id="pokeballContainer">
                <div class="pokeball" id="pokeball"></div>
            </div>
            <div class="flash-overlay" id="flashOverlay"></div>
            
            <div class="pokemon-display">
                <img class="pokemon-modal-sprite" id="modalSprite" src="" alt="">
                <div class="speech-bubble">
                    <div class="math-problem" id="mathProblem"></div>
                </div>
            </div>

            <div class="answer-section">
                <input type="number" inputmode="numeric" pattern="[0-9]*" class="answer-input" id="answerInput" placeholder="Answer">
                <br>
                <button class="submit-btn" id="submitBtn" onclick="checkAnswer()">Catch Pok√©mon!</button>
                <div class="feedback" id="feedback"></div>
                <div class="celebration" id="celebration">üéâ Pok√©mon Caught! üéâ</div>
            </div>
        </div>
    </div>

    <!-- Empty Bush Message -->
    <div class="empty-bush-message" id="emptyBushMessage">
        üçÉ Nothing here... Try another bush! üçÉ
    </div>

    <!-- Ran Away Notification -->
    <div class="ran-away-notification" id="ranAwayNotification">
        üí® <span id="pokemonName"></span> ran away! üí®
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h2>‚ö†Ô∏è Reset Progress?</h2>
            <p>Are you sure you want to reset all caught Pok√©mon? This will release all <strong><span id="confirmCount">0</span> Pok√©mon</strong> you've caught and you'll start over from the beginning.</p>
            <p><strong>This action cannot be undone!</strong></p>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="closeResetConfirmation()">Cancel</button>
                <button class="confirm-btn confirm" onclick="confirmReset()">Reset Pok√©mon</button>
            </div>
        </div>
    </div>

    <!-- Full Game Reset Confirmation Modal -->
    <div class="confirm-modal" id="fullResetModal">
        <div class="confirm-content">
            <h2>‚ö†Ô∏è RESET EVERYTHING?</h2>
            <p style="color: #ef4444; font-weight: bold;">This will delete ALL your progress including:</p>
            <ul style="text-align: left; margin: 20px 40px; color: #666;">
                <li>All <strong><span id="fullResetCount">0</span> caught Pok√©mon</strong></li>
                <li>All <strong><span id="fullResetBadges">0</span> unlocked badges</strong></li>
                <li>All stats and streak records</li>
                <li>Settings will be reset to defaults</li>
            </ul>
            <p><strong>THIS CANNOT BE UNDONE!</strong></p>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="closeFullResetConfirmation()">Cancel</button>
                <button class="confirm-btn confirm" onclick="confirmFullReset()">Delete Everything</button>
            </div>
        </div>
    </div>

    <!-- Badge Modal -->
    <div class="badge-modal" id="badgeModal">
        <div class="badge-modal-content">
            <button class="close-btn" onclick="closeBadgeModal()">√ó</button>
            <h2>üèÜ Achievement Badges</h2>
            <p class="subtitle">Unlock badges by catching Pok√©mon and solving math problems!</p>
            
            <div class="badges-grid" id="badgesGrid"></div>
            
            <div class="stats-section">
                <h3>üìä Your Stats</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-item-label">Total Problems Solved</div>
                        <div class="stat-item-value" id="total-problems">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Accuracy Rate</div>
                        <div class="stat-item-value" id="accuracy-rate">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Best Streak</div>
                        <div class="stat-item-value" id="best-streak">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Favorite Operation</div>
                        <div class="stat-item-value" id="favorite-operation">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Badge Popup -->
    <div class="new-badge-popup" id="newBadgePopup">
        <h3>üéâ Badge Unlocked! üéâ</h3>
        <div class="badge-icon" id="newBadgeIcon"></div>
        <div class="badge-name" id="newBadgeName"></div>
    </div>

    <!-- Pokemon Info Modal -->
    <div class="pokemon-info-modal" id="pokemonInfoModal">
        <div class="pokemon-info-content">
            <button class="close-btn" onclick="closePokemonInfo()">√ó</button>
            
            <div id="pokemonInfoLoading" class="loading-spinner">
                Loading... ‚ö°
            </div>
            
            <div id="pokemonInfoDisplay" style="display: none;">
                <div class="pokemon-info-header">
                    <img class="pokemon-info-sprite" id="infoSprite" src="" alt="">
                    <div class="pokemon-info-title">
                        <h2 id="infoName"></h2>
                        <div class="pokemon-info-number" id="infoNumber"></div>
                    </div>
                </div>

                <div class="pokemon-info-section">
                    <h3>üìä Type</h3>
                    <div class="pokemon-types" id="infoTypes"></div>
                </div>

                <div class="pokemon-info-section">
                    <h3>üìè Physical Stats</h3>
                    <div class="pokemon-stats">
                        <div class="stat-item">
                            <div class="stat-label">Height</div>
                            <div class="stat-value" id="infoHeight"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Weight</div>
                            <div class="stat-value" id="infoWeight"></div>
                        </div>
                    </div>
                </div>

                <div class="pokemon-info-section">
                    <h3>üåç Habitat</h3>
                    <div class="stat-item">
                        <div class="stat-value" id="infoHabitat"></div>
                    </div>
                </div>

                <div class="pokemon-info-section">
                    <h3>üìñ Story</h3>
                    <div class="pokemon-story" id="infoStory"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Kanto Pok√©mon (1-150)
        const pokemon = [
            "Bulbasaur", "Ivysaur", "Venusaur", "Charmander", "Charmeleon", "Charizard", 
            "Squirtle", "Wartortle", "Blastoise", "Caterpie", "Metapod", "Butterfree",
            "Weedle", "Kakuna", "Beedrill", "Pidgey", "Pidgeotto", "Pidgeot",
            "Rattata", "Raticate", "Spearow", "Fearow", "Ekans", "Arbok",
            "Pikachu", "Raichu", "Sandshrew", "Sandslash", "Nidoran‚ôÄ", "Nidorina",
            "Nidoqueen", "Nidoran‚ôÇ", "Nidorino", "Nidoking", "Clefairy", "Clefable",
            "Vulpix", "Ninetales", "Jigglypuff", "Wigglytuff", "Zubat", "Golbat",
            "Oddish", "Gloom", "Vileplume", "Paras", "Parasect", "Venonat",
            "Venomoth", "Diglett", "Dugtrio", "Meowth", "Persian", "Psyduck",
            "Golduck", "Mankey", "Primeape", "Growlithe", "Arcanine", "Poliwag",
            "Poliwhirl", "Poliwrath", "Abra", "Kadabra", "Alakazam", "Machop",
            "Machoke", "Machamp", "Bellsprout", "Weepinbell", "Victreebel", "Tentacool",
            "Tentacruel", "Geodude", "Graveler", "Golem", "Ponyta", "Rapidash",
            "Slowpoke", "Slowbro", "Magnemite", "Magneton", "Farfetch'd", "Doduo",
            "Dodrio", "Seel", "Dewgong", "Grimer", "Muk", "Shellder",
            "Cloyster", "Gastly", "Haunter", "Gengar", "Onix", "Drowzee",
            "Hypno", "Krabby", "Kingler", "Voltorb", "Electrode", "Exeggcute",
            "Exeggutor", "Cubone", "Marowak", "Hitmonlee", "Hitmonchan", "Lickitung",
            "Koffing", "Weezing", "Rhyhorn", "Rhydon", "Chansey", "Tangela",
            "Kangaskhan", "Horsea", "Seadra", "Goldeen", "Seaking", "Staryu",
            "Starmie", "Mr. Mime", "Scyther", "Jynx", "Electabuzz", "Magmar",
            "Pinsir", "Tauros", "Magikarp", "Gyarados", "Lapras", "Ditto",
            "Eevee", "Vaporeon", "Jolteon", "Flareon", "Porygon", "Omanyte",
            "Omastar", "Kabuto", "Kabutops", "Aerodactyl", "Snorlax", "Articuno",
            "Zapdos", "Moltres", "Dratini", "Dragonair", "Dragonite", "Mewtwo", "Mew"
        ];

        let caughtPokemon = JSON.parse(localStorage.getItem('caughtPokemon')) || {};
        let currentPokemon = null;
        let currentAnswer = 0;
        let isMuted = JSON.parse(localStorage.getItem('isMuted')) || false;
        let operationMode = localStorage.getItem('operationMode') || 'random';
        let gradeLevel = parseInt(localStorage.getItem('gradeLevel')) || 4;
        let allowedOperations = JSON.parse(localStorage.getItem('allowedOperations')) || ['addition', 'subtraction', 'multiplication', 'division'];
        let selectedBush = null;
        let pokemonInBush = false;
        let checkedBushes = []; // Track which bushes have been checked
        
        // Sound system
        let currentMusic = null;
        let isMusicPlaying = false;
        
        // Music tracks
        const musicTracks = {
            menu: '03 ~Opening~.mp3',
            hunt: '06 Pallet Town Theme.mp3',
            battle: '03 ~Opening~.mp3',
            pokedex: '03 ~Opening~.mp3',
            catchFanfare: '14 Fanfare Item Get 1.mp3'
        };
        
        // ===== POKEBALL CATCH ANIMATION =====
        function playPokeballCatchAnimation(pokemonType = 'normal') {
            const container = document.getElementById('pokeballContainer');
            const pokeball = document.getElementById('pokeball');
            const flashOverlay = document.getElementById('flashOverlay');
            const modalSprite = document.getElementById('modalSprite');
            
            // Get type color for particles
            const typeColors = {
                fire: '#ff4500',
                water: '#4da6ff',
                electric: '#ffeb3b',
                grass: '#4CAF50',
                ice: '#87CEEB',
                fighting: '#C03028',
                poison: '#A040A0',
                ground: '#E0C068',
                flying: '#A890F0',
                psychic: '#F85888',
                bug: '#A8B820',
                rock: '#B8A038',
                ghost: '#705898',
                dragon: '#7038F8',
                dark: '#705848',
                steel: '#B8B8D0',
                fairy: '#EE99AC',
                normal: '#A8A878'
            };
            
            const color = typeColors[pokemonType] || '#ff0000';
            
            // Step 1: Show pokeball and throw it
            container.classList.add('active');
            pokeball.className = 'pokeball throwing';
            
            // Step 2: Flash and shrink Pokemon into ball
            setTimeout(() => {
                flashOverlay.classList.add('active');
                modalSprite.style.transition = 'transform 0.2s ease-out, opacity 0.2s';
                modalSprite.style.transform = 'scale(0)';
                modalSprite.style.opacity = '0';
                
                setTimeout(() => {
                    flashOverlay.classList.remove('active');
                }, 300);
            }, 800);
            
            // Step 3: Ball shakes 3 times
            setTimeout(() => {
                pokeball.className = 'pokeball shaking';
                
                // Create star particles during shakes
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        createParticle('star', '‚≠ê', color, container);
                    }, i * 300);
                }
            }, 1000);
            
            // Step 4: Ball opens - CAUGHT!
            setTimeout(() => {
                pokeball.className = 'pokeball opening';
                flashOverlay.classList.add('active');
                
                // Create particle explosion
                setTimeout(() => {
                    createParticleExplosion(color, container);
                    flashOverlay.classList.remove('active');
                    
                    // Make sprite visible again and bring Pokemon back (zooming in)
                    modalSprite.style.visibility = 'visible';
                    modalSprite.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s';
                    modalSprite.style.transform = 'scale(1.2)';
                    modalSprite.style.opacity = '1';
                    
                    setTimeout(() => {
                        modalSprite.style.transform = 'scale(1)';
                    }, 100);
                }, 200);
            }, 3400);
            
            // Step 5: Cleanup
            setTimeout(() => {
                container.classList.remove('active');
                pokeball.className = 'pokeball';
                modalSprite.style.transform = '';
                modalSprite.style.opacity = '';
                modalSprite.style.transition = '';
            }, 4200);
        }

        function createParticle(type, emoji, color, container) {
            const particle = document.createElement('div');
            particle.className = `particle ${type}-particle`;
            particle.textContent = emoji;
            particle.style.color = color;
            particle.style.left = '50%';
            particle.style.top = '50%';
            
            // Random direction
            const angle = Math.random() * Math.PI * 2;
            const distance = 50 + Math.random() * 100;
            const x = Math.cos(angle) * distance;
            const y = Math.sin(angle) * distance;
            
            particle.style.setProperty('--x', `${x}px`);
            particle.style.setProperty('--y', `${y}px`);
            
            container.appendChild(particle);
            
            setTimeout(() => particle.remove(), 1500);
        }

        function createParticleExplosion(color, container) {
            // Energy ring
            const ring = document.createElement('div');
            ring.className = 'energy-ring';
            ring.style.borderColor = color;
            container.appendChild(ring);
            setTimeout(() => ring.remove(), 800);
            
            // Confetti particles
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle confetti-particle';
                particle.style.backgroundColor = color;
                particle.style.left = '50%';
                particle.style.top = '50%';
                
                const angle = (i / 20) * Math.PI * 2;
                const distance = 80 + Math.random() * 120;
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                
                particle.style.setProperty('--x', `${x}px`);
                particle.style.setProperty('--y', `${y}px`);
                particle.style.animationDelay = `${Math.random() * 0.2}s`;
                
                container.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
            
            // Star particles
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    createParticle('star', '‚≠ê', '#FFD700', container);
                }, i * 50);
            }
            
            // Sparkle particles
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    createParticle('sparkle', '‚ú®', color, container);
                }, i * 80);
            }
        }
        // ===== END POKEBALL ANIMATION =====

        // ===== BATTLE ATTACK ANIMATION SYSTEM =====
        
        // Type color mapping for attacks
        const typeColors = {
            fire: '#ff4500',
            water: '#4da6ff',
            electric: '#ffeb3b',
            grass: '#4CAF50',
            ice: '#87CEEB',
            fighting: '#C03028',
            poison: '#A040A0',
            ground: '#E0C068',
            flying: '#A890F0',
            psychic: '#F85888',
            bug: '#A8B820',
            rock: '#B8A038',
            ghost: '#705898',
            dragon: '#7038F8',
            dark: '#705848',
            steel: '#B8B8D0',
            fairy: '#EE99AC',
            normal: '#A8A878'
        };

        function playBattleAttackAnimation(attackerSide, attackType, damage, isSuper, effectiveness) {
            const color = typeColors[attackType] || '#A8A878';
            const attackerSprite = document.getElementById(attackerSide === 'player' ? 'playerSprite' : 'opponentSprite');
            const defenderSprite = document.getElementById(attackerSide === 'player' ? 'opponentSprite' : 'playerSprite');
            const battleField = document.getElementById('battleField');
            const flash = document.getElementById('battleFlash');
            
            // Step 1: Charge up (0.3s)
            attackerSprite.style.setProperty('--attack-color', color);
            attackerSprite.classList.add('charging');
            
            setTimeout(() => {
                attackerSprite.classList.remove('charging');
                
                // Step 2: Launch attack (0.5s)
                createAttackProjectile(attackerSide, attackType, color);
                
                setTimeout(() => {
                    // Step 3: Impact (0.4s)
                    // Screen flash
                    flash.style.setProperty('--flash-color', color);
                    flash.classList.add('active');
                    setTimeout(() => flash.classList.remove('active'), 300);
                    
                    // Screen shake for big hits
                    if (isSuper || damage >= 30) {
                        battleField.classList.add('screen-shake');
                        setTimeout(() => battleField.classList.remove('screen-shake'), 300);
                    }
                    
                    // Impact burst
                    createImpactBurst(defenderSprite, color);
                    
                    // Particles
                    createAttackParticles(defenderSprite, attackType, color, 15);
                    
                    // Damage number
                    showDamageNumber(defenderSprite, damage, color, isSuper);
                    
                    // Defender hit animation
                    defenderSprite.classList.add('hit');
                    setTimeout(() => defenderSprite.classList.remove('hit'), 500);
                    
                }, 500);
            }, 300);
        }

        function createAttackProjectile(attackerSide, attackType, color) {
            const container = document.querySelector('.battle-pokemon-display');
            const attackerDiv = document.querySelector(`.battle-pokemon.${attackerSide}-pokemon`);
            const defenderDiv = document.querySelector(`.battle-pokemon.${attackerSide === 'player' ? 'opponent' : 'player'}-pokemon`);
            
            if (!container || !attackerDiv || !defenderDiv) return;
            
            const projectile = document.createElement('div');
            projectile.className = 'attack-projectile';
            
            const beam = document.createElement('div');
            beam.className = 'attack-beam launching';
            beam.style.setProperty('--attack-color', color);
            beam.style.setProperty('--beam-distance', attackerSide === 'player' ? '400px' : '-400px');
            
            // Position projectile at attacker
            const attackerRect = attackerDiv.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            projectile.style.position = 'absolute';
            projectile.style.left = `${attackerRect.left - containerRect.left + attackerRect.width / 2}px`;
            projectile.style.top = `${attackerRect.top - containerRect.top + attackerRect.height / 2}px`;
            projectile.style.transform = attackerSide === 'player' ? 'rotate(0deg)' : 'rotate(180deg)';
            
            projectile.appendChild(beam);
            container.appendChild(projectile);
            
            setTimeout(() => projectile.remove(), 600);
        }

        function createImpactBurst(targetElement, color) {
            const burst = document.createElement('div');
            burst.className = 'impact-burst exploding';
            burst.style.setProperty('--attack-color', color);
            
            const rect = targetElement.getBoundingClientRect();
            const parent = targetElement.parentElement;
            const parentRect = parent.getBoundingClientRect();
            
            burst.style.position = 'absolute';
            burst.style.left = `${rect.left - parentRect.left + rect.width / 2 - 75}px`;
            burst.style.top = `${rect.top - parentRect.top + rect.height / 2 - 75}px`;
            
            parent.appendChild(burst);
            setTimeout(() => burst.remove(), 400);
        }

        function createAttackParticles(targetElement, attackType, color, count) {
            const parent = targetElement.parentElement;
            const rect = targetElement.getBoundingClientRect();
            const parentRect = parent.getBoundingClientRect();
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = `attack-particle ${attackType}-particle burst`;
                
                const angle = (i / count) * Math.PI * 2;
                const distance = 60 + Math.random() * 80;
                const px = Math.cos(angle) * distance;
                const py = Math.sin(angle) * distance;
                
                particle.style.setProperty('--px', `${px}px`);
                particle.style.setProperty('--py', `${py}px`);
                particle.style.position = 'absolute';
                particle.style.left = `${rect.left - parentRect.left + rect.width / 2}px`;
                particle.style.top = `${rect.top - parentRect.top + rect.height / 2}px`;
                particle.style.animationDelay = `${Math.random() * 0.1}s`;
                
                parent.appendChild(particle);
                setTimeout(() => particle.remove(), 900);
            }
        }

        function showDamageNumber(targetElement, damage, color, isSuper) {
            const dmgNum = document.createElement('div');
            dmgNum.className = 'damage-number float-up';
            dmgNum.textContent = `-${damage}`;
            dmgNum.style.setProperty('--damage-color', isSuper ? '#ff6b00' : color);
            
            const rect = targetElement.getBoundingClientRect();
            const parent = targetElement.parentElement;
            const parentRect = parent.getBoundingClientRect();
            
            dmgNum.style.position = 'absolute';
            dmgNum.style.left = `${rect.left - parentRect.left + rect.width / 2}px`;
            dmgNum.style.top = `${rect.top - parentRect.top}px`;
            dmgNum.style.transform = 'translateX(-50%)';
            
            if (isSuper) {
                dmgNum.textContent += ' ‚òÖ';
                dmgNum.style.fontSize = '3.5em';
            }
            
            parent.appendChild(dmgNum);
            setTimeout(() => dmgNum.remove(), 1200);
        }
        // ===== END BATTLE ATTACK ANIMATION SYSTEM =====

        // Play background music
        function playBackgroundMusic(track) {
            if (isMuted) return;
            
            // Stop current music if playing
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
            }
            
            // Create new audio element
            currentMusic = new Audio(musicTracks[track]);
            currentMusic.loop = true;
            currentMusic.volume = 0.3;
            
            currentMusic.play().catch(err => {
                console.log('Music playback prevented:', err);
            });
            
            isMusicPlaying = true;
        }

        function stopBackgroundMusic() {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
            }
            isMusicPlaying = false;
        }
        
        // Play catch fanfare (doesn't loop)
        function playCatchFanfare() {
            if (isMuted) return;
            
            const fanfare = new Audio(musicTracks.catchFanfare);
            fanfare.volume = 0.5;
            fanfare.play().catch(err => {
                console.log('Fanfare playback prevented:', err);
            });
        }
        
        // Legendary Pokemon (special fanfare)
        const legendaryPokemon = [144, 145, 146, 150, 151]; // Articuno, Zapdos, Moltres, Mewtwo, Mew
        
        // Battle system
        let selectedTeam = [];
        let currentBattle = null;
        let playerTeamIndex = 0;
        let opponentTeamIndex = 0;
        
        // Type advantage chart (simplified)
        const typeChart = {
            fire: { weak: ['water', 'rock', 'ground'], strong: ['grass', 'ice', 'bug'] },
            water: { weak: ['electric', 'grass'], strong: ['fire', 'ground', 'rock'] },
            electric: { weak: ['ground'], strong: ['water', 'flying'] },
            grass: { weak: ['fire', 'ice', 'poison', 'flying', 'bug'], strong: ['water', 'ground', 'rock'] },
            normal: { weak: ['fighting'], strong: [] },
            fighting: { weak: ['flying', 'psychic'], strong: ['normal', 'ice', 'rock'] },
            poison: { weak: ['ground', 'psychic'], strong: ['grass'] },
            ground: { weak: ['water', 'grass', 'ice'], strong: ['fire', 'electric', 'poison', 'rock'] },
            flying: { weak: ['electric', 'ice', 'rock'], strong: ['fighting', 'bug', 'grass'] },
            psychic: { weak: ['bug', 'ghost'], strong: ['fighting', 'poison'] },
            bug: { weak: ['fire', 'flying', 'rock'], strong: ['grass', 'psychic'] },
            rock: { weak: ['water', 'grass', 'fighting', 'ground'], strong: ['fire', 'ice', 'flying', 'bug'] },
            ghost: { weak: ['ghost'], strong: ['psychic', 'ghost'] },
            ice: { weak: ['fire', 'fighting', 'rock'], strong: ['grass', 'ground', 'flying'] },
            dragon: { weak: ['ice', 'dragon'], strong: ['dragon'] },
            dark: { weak: ['fighting', 'bug'], strong: ['psychic', 'ghost'] },
            steel: { weak: ['fire', 'fighting', 'ground'], strong: ['ice', 'rock'] },
            fairy: { weak: ['poison', 'steel'], strong: ['fighting', 'dragon', 'dark'] }
        };
        
        // Attack names by type
        const attacksByType = {
            fire: ['üî• Flamethrower', 'üî• Fire Blast', 'üî• Ember'],
            water: ['üíß Hydro Pump', 'üíß Water Gun', 'üíß Surf'],
            electric: ['‚ö° Thunderbolt', '‚ö° Thunder', '‚ö° Spark'],
            grass: ['üåø Razor Leaf', 'üåø Solar Beam', 'üåø Vine Whip'],
            normal: ['‚≠ê Tackle', '‚≠ê Quick Attack', '‚≠ê Body Slam'],
            fighting: ['üëä Karate Chop', 'üëä Low Kick', 'üëä Submission'],
            poison: ['‚ò†Ô∏è Poison Sting', '‚ò†Ô∏è Sludge Bomb', '‚ò†Ô∏è Acid'],
            ground: ['üåç Earthquake', 'üåç Dig', 'üåç Sand Attack'],
            flying: ['ü¶Ö Wing Attack', 'ü¶Ö Aerial Ace', 'ü¶Ö Gust'],
            psychic: ['üîÆ Psychic', 'üîÆ Confusion', 'üîÆ Psybeam'],
            bug: ['üêõ Bug Bite', 'üêõ String Shot', 'üêõ Twineedle'],
            rock: ['ü™® Rock Throw', 'ü™® Rock Slide', 'ü™® Stone Edge'],
            ghost: ['üëª Shadow Ball', 'üëª Lick', 'üëª Night Shade'],
            ice: ['‚ùÑÔ∏è Ice Beam', '‚ùÑÔ∏è Blizzard', '‚ùÑÔ∏è Powder Snow'],
            dragon: ['üêâ Dragon Rage', 'üêâ Outrage', 'üêâ Dragon Claw'],
            dark: ['üåë Bite', 'üåë Crunch', 'üåë Dark Pulse'],
            steel: ['‚öôÔ∏è Iron Tail', '‚öôÔ∏è Steel Wing', '‚öôÔ∏è Metal Claw'],
            fairy: ['‚ú® Moonblast', '‚ú® Dazzling Gleam', '‚ú® Fairy Wind']
        };
        
        // Badge and stats system
        let gameStats = JSON.parse(localStorage.getItem('gameStats')) || {
            totalProblems: 0,
            correctAnswers: 0,
            currentStreak: 0,
            bestStreak: 0,
            operationCounts: { addition: 0, subtraction: 0, multiplication: 0, division: 0 },
            unlockedBadges: [],
            battlesWon: 0
        };

        // Sound Effects using Web Audio API and generated tones
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();

        // Sound effect: Success chime
        function playSuccessSound() {
            if (isMuted) return;
            
            const notes = [523.25, 659.25, 783.99]; // C-E-G chord
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                
                const startTime = audioContext.currentTime + (index * 0.1);
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.5);
            });
        }

        // Sound effect: Failure sound
        function playFailureSound() {
            if (isMuted) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Sound effect: Bush rustling
        function playBushSound() {
            if (isMuted) return;
            
            // Create white noise for rustling effect
            const bufferSize = audioContext.sampleRate * 0.3;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            
            const noise = audioContext.createBufferSource();
            noise.buffer = buffer;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1000;
            
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            noise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            noise.start(audioContext.currentTime);
            noise.stop(audioContext.currentTime + 0.3);
        }

        // Sound effect: Legendary fanfare
        function playLegendaryFanfare() {
            if (isMuted) return;
            
            const fanfare = [
                {freq: 523.25, duration: 0.2}, // C
                {freq: 659.25, duration: 0.2}, // E
                {freq: 783.99, duration: 0.2}, // G
                {freq: 1046.50, duration: 0.4}, // C (high)
                {freq: 783.99, duration: 0.2}, // G
                {freq: 1046.50, duration: 0.6}, // C (high)
            ];
            
            let currentTime = audioContext.currentTime;
            
            fanfare.forEach((note) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = note.freq;
                oscillator.type = 'triangle';
                
                gainNode.gain.setValueAtTime(0.4, currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + note.duration);
                
                oscillator.start(currentTime);
                oscillator.stop(currentTime + note.duration);
                
                currentTime += note.duration;
            });
        }

        // Sound effect: Type-specific sounds
        function playTypeSound(types) {
            if (isMuted || !types || types.length === 0) return;
            
            const primaryType = types[0].type.name;
            
            switch(primaryType) {
                case 'electric':
                    // Electric zap - rapid frequency changes
                    for (let i = 0; i < 5; i++) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        const startTime = audioContext.currentTime + (i * 0.05);
                        oscillator.frequency.setValueAtTime(800 + Math.random() * 400, startTime);
                        oscillator.type = 'square';
                        
                        gainNode.gain.setValueAtTime(0.2, startTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.05);
                        
                        oscillator.start(startTime);
                        oscillator.stop(startTime + 0.05);
                    }
                    break;
                    
                case 'fire':
                    // Fire whoosh - rising tone
                    const fireOsc = audioContext.createOscillator();
                    const fireGain = audioContext.createGain();
                    
                    fireOsc.connect(fireGain);
                    fireGain.connect(audioContext.destination);
                    
                    fireOsc.frequency.setValueAtTime(200, audioContext.currentTime);
                    fireOsc.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.4);
                    fireOsc.type = 'sawtooth';
                    
                    fireGain.gain.setValueAtTime(0.3, audioContext.currentTime);
                    fireGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    
                    fireOsc.start(audioContext.currentTime);
                    fireOsc.stop(audioContext.currentTime + 0.4);
                    break;
                    
                case 'water':
                    // Water splash - low bubbling
                    for (let i = 0; i < 3; i++) {
                        const waterOsc = audioContext.createOscillator();
                        const waterGain = audioContext.createGain();
                        
                        waterOsc.connect(waterGain);
                        waterGain.connect(audioContext.destination);
                        
                        const startTime = audioContext.currentTime + (i * 0.1);
                        waterOsc.frequency.value = 150 + Math.random() * 100;
                        waterOsc.type = 'sine';
                        
                        waterGain.gain.setValueAtTime(0.2, startTime);
                        waterGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);
                        
                        waterOsc.start(startTime);
                        waterOsc.stop(startTime + 0.2);
                    }
                    break;
                    
                case 'grass':
                    // Grass rustle - soft noise
                    const bufferSize = audioContext.sampleRate * 0.3;
                    const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const output = buffer.getChannelData(0);
                    
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = (Math.random() * 2 - 1) * 0.5;
                    }
                    
                    const grassNoise = audioContext.createBufferSource();
                    grassNoise.buffer = buffer;
                    
                    const grassFilter = audioContext.createBiquadFilter();
                    grassFilter.type = 'lowpass';
                    grassFilter.frequency.value = 2000;
                    
                    const grassGain = audioContext.createGain();
                    grassGain.gain.setValueAtTime(0.15, audioContext.currentTime);
                    grassGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    grassNoise.connect(grassFilter);
                    grassFilter.connect(grassGain);
                    grassGain.connect(audioContext.destination);
                    
                    grassNoise.start(audioContext.currentTime);
                    grassNoise.stop(audioContext.currentTime + 0.3);
                    break;
                    
                default:
                    // Default sound for other types
                    playSuccessSound();
            }
        }

        // Routing system
        function navigateTo(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Show/hide nav bar
            if (page === 'menu') {
                document.getElementById('navBar').classList.add('hidden');
                document.getElementById('menuPage').classList.add('active');
                // Play menu music (Opening theme)
                if (!isMuted) {
                    playBackgroundMusic('menu');
                }
            } else {
                document.getElementById('navBar').classList.remove('hidden');
                
                // Update active nav button
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                
                if (page === 'hunt') {
                    document.getElementById('huntPage').classList.add('active');
                    document.querySelectorAll('.nav-btn')[1].classList.add('active');
                    resetBushes(); // Reset bushes when returning to hunt page
                    // Play hunt music (Pallet Town)
                    if (!isMuted) {
                        playBackgroundMusic('hunt');
                    }
                } else if (page === 'battle') {
                    document.getElementById('battlePage').classList.add('active');
                    document.querySelectorAll('.nav-btn')[2].classList.add('active');
                    initializeBattleMode(); // Initialize battle mode
                    // Play battle music (Opening theme)
                    if (!isMuted) {
                        playBackgroundMusic('battle');
                    }
                } else if (page === 'pokedex') {
                    document.getElementById('pokedexPage').classList.add('active');
                    document.querySelectorAll('.nav-btn')[3].classList.add('active');
                    initializeGrid(); // Refresh the grid when viewing
                    // Play pokedex music (Opening theme)
                    if (!isMuted) {
                        playBackgroundMusic('pokedex');
                    }
                }
            }
        }

        // Reset bushes for new round
        function resetBushes() {
            checkedBushes = [];
            document.querySelectorAll('.bush').forEach(bush => {
                bush.classList.remove('checked');
            });
            document.getElementById('bushHeader').textContent = 'üåø Choose a bush to search! üåø';
        }

        // Bush selection - ALWAYS show math problem
        function selectBush(bushIndex) {
            // Don't allow selecting already checked bushes
            if (checkedBushes.includes(bushIndex)) {
                return;
            }

            // Play bush rustling sound
            playBushSound();

            selectedBush = bushIndex;
            
            // Only 1 in 3 bushes has a Pok√©mon (33% chance)
            pokemonInBush = Math.random() < 0.33;
            
            if (pokemonInBush) {
                // Pok√©mon found! Pick random uncaught one
                const uncaught = [];
                for (let i = 1; i <= 150; i++) {
                    if (!caughtPokemon[i]) uncaught.push(i);
                }
                if (uncaught.length > 0) {
                    const randomIndex = Math.floor(Math.random() * uncaught.length);
                    const pokemonNumber = uncaught[randomIndex];
                    openModalWithPokemon(pokemonNumber, pokemon[pokemonNumber - 1]);
                } else {
                    // All caught!
                    alert('You\'ve caught all 150 Pok√©mon! üéâ');
                    navigateTo('pokedex');
                }
            } else {
                // Empty bush - but still show math problem!
                openModalWithoutPokemon();
            }
        }

        // Open modal with a Pok√©mon
        function openModalWithPokemon(number, name) {
            currentPokemon = { number, name };
            const mathData = generateMathProblem();
            currentAnswer = mathData.answer;

            // Play Pok√©mon cry sound
            playPokemonCry(number);

            document.getElementById('modalSprite').src = getPokemonSpriteUrl(number, false);
            document.getElementById('modalSprite').alt = name;
            document.getElementById('mathProblem').textContent = `${mathData.problem} = ?`;
            document.getElementById('submitBtn').textContent = 'Catch Pok√©mon!';
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('celebration').style.display = 'none';
            document.getElementById('mathModal').classList.add('active');
            document.getElementById('answerInput').focus();
        }

        // Open modal without a Pok√©mon (empty bush)
        function openModalWithoutPokemon() {
            currentPokemon = null; // No Pok√©mon in this bush
            const mathData = generateMathProblem();
            currentAnswer = mathData.answer;

            // Show question mark or empty bush sprite
            document.getElementById('modalSprite').src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';
            document.getElementById('modalSprite').alt = 'Empty';
            document.getElementById('mathProblem').textContent = `Nothing here... ${mathData.problem} = ?`;
            document.getElementById('submitBtn').textContent = 'Continue Searching';
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('celebration').style.display = 'none';
            document.getElementById('mathModal').classList.add('active');
            document.getElementById('answerInput').focus();
        }

        // Helper function to count Pokemon by type
        function countPokemonByType(typeName) {
            let count = 0;
            for (let pokemonNum in caughtPokemon) {
                // We'll need to fetch type data - for now use a simplified approach
                // This will be populated when we catch Pokemon
                if (pokemonTypeCache[pokemonNum] && pokemonTypeCache[pokemonNum].includes(typeName)) {
                    count++;
                }
            }
            return count;
        }
        
        // Cache for Pokemon types (populated as we catch them)
        let pokemonTypeCache = JSON.parse(localStorage.getItem('pokemonTypeCache')) || {};
        
        // Badge definitions
        const badges = [
            // TYPE MASTER BADGES (10 types with 10+ Pok√©mon in Gen 1)
            { id: 'flame_badge', name: 'Flame Badge', icon: 'üî•', description: 'Catch 10 Fire-type Pok√©mon', requirement: () => countPokemonByType('fire') >= 10 },
            { id: 'wave_badge', name: 'Wave Badge', icon: 'üíß', description: 'Catch 10 Water-type Pok√©mon', requirement: () => countPokemonByType('water') >= 10 },
            { id: 'leaf_badge', name: 'Leaf Badge', icon: 'üåø', description: 'Catch 10 Grass-type Pok√©mon', requirement: () => countPokemonByType('grass') >= 10 },
            { id: 'toxic_badge', name: 'Toxic Badge', icon: '‚ò†Ô∏è', description: 'Catch 10 Poison-type Pok√©mon', requirement: () => countPokemonByType('poison') >= 10 },
            { id: 'terra_badge', name: 'Terra Badge', icon: 'üåç', description: 'Catch 10 Ground-type Pok√©mon', requirement: () => countPokemonByType('ground') >= 10 },
            { id: 'sky_badge', name: 'Sky Badge', icon: 'ü¶Ö', description: 'Catch 10 Flying-type Pok√©mon', requirement: () => countPokemonByType('flying') >= 10 },
            { id: 'mind_badge', name: 'Mind Badge', icon: 'üîÆ', description: 'Catch 10 Psychic-type Pok√©mon', requirement: () => countPokemonByType('psychic') >= 10 },
            { id: 'swarm_badge', name: 'Swarm Badge', icon: 'üêõ', description: 'Catch 10 Bug-type Pok√©mon', requirement: () => countPokemonByType('bug') >= 10 },
            { id: 'stone_badge', name: 'Stone Badge', icon: 'ü™®', description: 'Catch 10 Rock-type Pok√©mon', requirement: () => countPokemonByType('rock') >= 10 },
            { id: 'hero_badge', name: 'Hero Badge', icon: '‚≠ê', description: 'Catch 10 Normal-type Pok√©mon', requirement: () => countPokemonByType('normal') >= 10 },
            
            // COLLECTION MILESTONE BADGES
            { id: 'explorer_badge', name: 'Explorer Badge', icon: 'üéí', description: 'Catch 25 different Pok√©mon', requirement: () => Object.keys(caughtPokemon).length >= 25 },
            { id: 'adventurer_badge', name: 'Adventurer Badge', icon: 'üó∫Ô∏è', description: 'Catch 50 different Pok√©mon', requirement: () => Object.keys(caughtPokemon).length >= 50 },
            { id: 'champion_badge', name: 'Champion Badge', icon: 'üèÖ', description: 'Catch 100 different Pok√©mon', requirement: () => Object.keys(caughtPokemon).length >= 100 },
            { id: 'master_trainer_badge', name: 'Master Trainer Badge', icon: 'üëë', description: 'Catch all 150 Pok√©mon', requirement: () => Object.keys(caughtPokemon).length >= 150 },
            
            // MATH MASTERY BADGES (Total correct answers, not streaks)
            { id: 'scholar_badge', name: 'Scholar Badge', icon: 'üìö', description: 'Answer 75 math problems correctly', requirement: () => gameStats.correctAnswers >= 75 },
            { id: 'mathematician_badge', name: 'Mathematician Badge', icon: 'üßÆ', description: 'Answer 150 math problems correctly', requirement: () => gameStats.correctAnswers >= 150 },
            { id: 'professor_badge', name: 'Professor Badge', icon: 'üéì', description: 'Answer 250 math problems correctly', requirement: () => gameStats.correctAnswers >= 250 },
            
            // PERFECT STREAK BADGES (Different from total count)
            { id: 'boulder_badge', name: 'Boulder Badge', icon: 'ü•â', description: 'Win 10 in a row', requirement: () => gameStats.currentStreak >= 10 },
            { id: 'cascade_badge', name: 'Cascade Badge', icon: 'ü•à', description: 'Win 25 in a row', requirement: () => gameStats.currentStreak >= 25 },
            { id: 'thunder_badge', name: 'Thunder Badge', icon: 'ü•á', description: 'Win 50 in a row', requirement: () => gameStats.currentStreak >= 50 },
            { id: 'rainbow_badge', name: 'Rainbow Badge', icon: 'üèÜ', description: 'Win 100 in a row', requirement: () => gameStats.currentStreak >= 100 },
            
            // BATTLE VICTORY BADGES
            { id: 'rookie_trainer', name: 'Rookie Trainer', icon: '‚öîÔ∏è', description: 'Win your first battle', requirement: () => (gameStats.battlesWon || 0) >= 1 },
            { id: 'experienced_trainer', name: 'Experienced Trainer', icon: 'üó°Ô∏è', description: 'Win 10 battles', requirement: () => (gameStats.battlesWon || 0) >= 10 },
            { id: 'veteran_trainer', name: 'Veteran Trainer', icon: 'üõ°Ô∏è', description: 'Win 25 battles', requirement: () => (gameStats.battlesWon || 0) >= 25 },
            { id: 'battle_master', name: 'Battle Master', icon: 'üëë', description: 'Win 50 battles', requirement: () => (gameStats.battlesWon || 0) >= 50 }
        ];

        // Set grade level
        function setGradeLevel(grade) {
            gradeLevel = parseInt(grade);
            localStorage.setItem('gradeLevel', gradeLevel);
        }

        // Save game stats
        function saveGameStats() {
            localStorage.setItem('gameStats', JSON.stringify(gameStats));
        }

        // Check and unlock badges
        function checkBadges() {
            const newlyUnlocked = [];
            
            badges.forEach(badge => {
                if (!gameStats.unlockedBadges.includes(badge.id) && badge.requirement()) {
                    gameStats.unlockedBadges.push(badge.id);
                    newlyUnlocked.push(badge);
                }
            });

            if (newlyUnlocked.length > 0) {
                saveGameStats();
                updateBadgeCount();
                // Show popup for first new badge
                showNewBadgePopup(newlyUnlocked[0]);
            }
        }

        // Show new badge popup
        function showNewBadgePopup(badge) {
            document.getElementById('newBadgeIcon').textContent = badge.icon;
            document.getElementById('newBadgeName').textContent = badge.name;
            const popup = document.getElementById('newBadgePopup');
            popup.style.display = 'block';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        // Update badge count display
        function updateBadgeCount() {
            const count = gameStats.unlockedBadges.length;
            document.getElementById('badge-count').textContent = count;
            document.getElementById('badge-count-menu').textContent = count;
        }

        // Update streak display
        function updateStreakDisplay() {
            document.getElementById('streak-count').textContent = gameStats.currentStreak;
        }

        // Track operation type from current problem
        let lastOperationType = null;

        // Set operation mode
        function setOperation(mode) {
            operationMode = mode;
            localStorage.setItem('operationMode', mode);
            
            // Update button states
            document.querySelectorAll('.operation-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-operation="${mode}"]`).classList.add('active');
        }

        // Toggle mute on/off
        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('isMuted', JSON.stringify(isMuted));
            updateMuteButton();
            
            // Handle background music
            if (isMuted) {
                stopBackgroundMusic();
            } else {
                // Resume audio context if needed
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }
        }

        // Update mute button appearance
        function updateMuteButton() {
            const button = document.getElementById('muteButton');
            if (isMuted) {
                button.textContent = 'üîá';
                button.classList.add('muted');
                button.title = 'Sound Off - Click to Unmute';
            } else {
                button.textContent = 'üîä';
                button.classList.remove('muted');
                button.title = 'Sound On - Click to Mute';
            }
        }

        // Generate grade-appropriate math problem
        function generateMathProblem() {
            // Define difficulty parameters by grade level
            const gradeDifficulty = {
                1: { // Age 6 - Very basic addition/subtraction
                    addition: { min: 1, max: 10 },
                    subtraction: { min: 1, max: 10 },
                    multiplication: null, // Not appropriate yet
                    division: null
                },
                2: { // Age 7 - Simple addition/subtraction
                    addition: { min: 1, max: 20 },
                    subtraction: { min: 1, max: 20 },
                    multiplication: { min: 1, max: 5, maxProduct: 25 },
                    division: null
                },
                3: { // Age 8 - Larger numbers, intro multiplication
                    addition: { min: 5, max: 50 },
                    subtraction: { min: 5, max: 50 },
                    multiplication: { min: 2, max: 10, maxProduct: 50 },
                    division: { divisor: [2, 3, 4, 5], quotient: [2, 10] }
                },
                4: { // Age 9 - Standard multiplication tables
                    addition: { min: 10, max: 100 },
                    subtraction: { min: 10, max: 100 },
                    multiplication: { min: 2, max: 12, maxProduct: 144 },
                    division: { divisor: [2, 12], quotient: [2, 12] }
                },
                5: { // Age 10 - Larger multiplication, division
                    addition: { min: 20, max: 200 },
                    subtraction: { min: 20, max: 200 },
                    multiplication: { min: 5, max: 15, maxProduct: 225 },
                    division: { divisor: [2, 15], quotient: [2, 15] }
                },
                6: { // Age 11 - Multi-digit operations
                    addition: { min: 50, max: 500 },
                    subtraction: { min: 50, max: 500 },
                    multiplication: { min: 10, max: 25, maxProduct: 625 },
                    division: { divisor: [5, 20], quotient: [5, 20] }
                },
                7: { // Age 12 - Larger numbers
                    addition: { min: 100, max: 1000 },
                    subtraction: { min: 100, max: 1000 },
                    multiplication: { min: 15, max: 35, maxProduct: 1225 },
                    division: { divisor: [10, 25], quotient: [10, 25] }
                },
                8: { // Age 13 - More complex
                    addition: { min: 200, max: 2000 },
                    subtraction: { min: 200, max: 2000 },
                    multiplication: { min: 20, max: 50, maxProduct: 2500 },
                    division: { divisor: [15, 35], quotient: [15, 35] }
                },
                9: { // Age 14 - Advanced
                    addition: { min: 500, max: 5000 },
                    subtraction: { min: 500, max: 5000 },
                    multiplication: { min: 25, max: 75, maxProduct: 5625 },
                    division: { divisor: [20, 50], quotient: [20, 50] }
                },
                10: { // Age 15-16 - Most challenging
                    addition: { min: 1000, max: 10000 },
                    subtraction: { min: 1000, max: 10000 },
                    multiplication: { min: 50, max: 100, maxProduct: 10000 },
                    division: { divisor: [25, 75], quotient: [25, 75] }
                }
            };

            const difficulty = gradeDifficulty[gradeLevel];

            const operations = {
                addition: () => {
                    if (!difficulty.addition) return null;
                    const a = Math.floor(Math.random() * (difficulty.addition.max - difficulty.addition.min + 1)) + difficulty.addition.min;
                    const b = Math.floor(Math.random() * (difficulty.addition.max - difficulty.addition.min + 1)) + difficulty.addition.min;
                    lastOperationType = 'addition';
                    return { problem: `${a} + ${b}`, answer: a + b };
                },
                subtraction: () => {
                    if (!difficulty.subtraction) return null;
                    const a = Math.floor(Math.random() * (difficulty.subtraction.max - difficulty.subtraction.min + 1)) + difficulty.subtraction.min;
                    const b = Math.floor(Math.random() * a) + 1; // Ensure b < a for positive result
                    lastOperationType = 'subtraction';
                    return { problem: `${a} - ${b}`, answer: a - b };
                },
                multiplication: () => {
                    if (!difficulty.multiplication) return null;
                    const a = Math.floor(Math.random() * (difficulty.multiplication.max - difficulty.multiplication.min + 1)) + difficulty.multiplication.min;
                    const b = Math.floor(Math.random() * (difficulty.multiplication.max - difficulty.multiplication.min + 1)) + difficulty.multiplication.min;
                    lastOperationType = 'multiplication';
                    return { problem: `${a} √ó ${b}`, answer: a * b };
                },
                division: () => {
                    if (!difficulty.division) return null;
                    const divisor = Math.floor(Math.random() * (difficulty.division.divisor[1] - difficulty.division.divisor[0] + 1)) + difficulty.division.divisor[0];
                    const quotient = Math.floor(Math.random() * (difficulty.division.quotient[1] - difficulty.division.quotient[0] + 1)) + difficulty.division.quotient[0];
                    const dividend = divisor * quotient;
                    lastOperationType = 'division';
                    return { problem: `${dividend} √∑ ${divisor}`, answer: quotient };
                }
            };

            // If random mode, pick a random operation that's available for this grade AND allowed in settings
            if (operationMode === 'random') {
                const availableOps = [];
                if (difficulty.addition && allowedOperations.includes('addition')) availableOps.push('addition');
                if (difficulty.subtraction && allowedOperations.includes('subtraction')) availableOps.push('subtraction');
                if (difficulty.multiplication && allowedOperations.includes('multiplication')) availableOps.push('multiplication');
                if (difficulty.division && allowedOperations.includes('division')) availableOps.push('division');
                
                if (availableOps.length === 0) {
                    // Fallback to addition if nothing available
                    return operations.addition();
                }
                
                const randomType = availableOps[Math.floor(Math.random() * availableOps.length)];
                return operations[randomType]();
            }

            // Otherwise use the selected operation (if available for this grade AND allowed)
            if (!allowedOperations.includes(operationMode)) {
                // If selected operation not allowed, pick from allowed ones
                const availableOps = [];
                if (difficulty.addition && allowedOperations.includes('addition')) availableOps.push('addition');
                if (difficulty.subtraction && allowedOperations.includes('subtraction')) availableOps.push('subtraction');
                if (difficulty.multiplication && allowedOperations.includes('multiplication')) availableOps.push('multiplication');
                if (difficulty.division && allowedOperations.includes('division')) availableOps.push('division');
                
                if (availableOps.length > 0) {
                    const randomType = availableOps[Math.floor(Math.random() * availableOps.length)];
                    return operations[randomType]();
                }
                return operations.addition();
            }
            
            const result = operations[operationMode]();
            
            // If operation not available for this grade, fall back to an allowed operation
            if (!result) {
                const availableOps = [];
                if (difficulty.addition && allowedOperations.includes('addition')) availableOps.push('addition');
                if (difficulty.subtraction && allowedOperations.includes('subtraction')) availableOps.push('subtraction');
                if (difficulty.multiplication && allowedOperations.includes('multiplication')) availableOps.push('multiplication');
                if (difficulty.division && allowedOperations.includes('division')) availableOps.push('division');
                
                if (availableOps.length > 0) {
                    const randomType = availableOps[Math.floor(Math.random() * availableOps.length)];
                    return operations[randomType]();
                }
                return operations.addition();
            }
            
            return result;
        }

        // Screen navigation
        function startGame() {
            // Resume audio context on user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // Start Pallet Town music for hunt screen
            if (!isMuted) {
                playBackgroundMusic('hunt');
            }
            
            navigateTo('hunt');
        }

        // Start battle mode from menu
        function startBattleFromMenu() {
            // Resume audio context on user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // Start battle music
            if (!isMuted) {
                playBackgroundMusic('battle');
            }
            
            navigateTo('battle');
        }

        function openSettings() {
            document.getElementById('settingsGrade').value = gradeLevel;
            document.getElementById('opAddition').checked = allowedOperations.includes('addition');
            document.getElementById('opSubtraction').checked = allowedOperations.includes('subtraction');
            document.getElementById('opMultiplication').checked = allowedOperations.includes('multiplication');
            document.getElementById('opDivision').checked = allowedOperations.includes('division');
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            gradeLevel = parseInt(document.getElementById('settingsGrade').value);
            localStorage.setItem('gradeLevel', gradeLevel);
            
            allowedOperations = [];
            if (document.getElementById('opAddition').checked) allowedOperations.push('addition');
            if (document.getElementById('opSubtraction').checked) allowedOperations.push('subtraction');
            if (document.getElementById('opMultiplication').checked) allowedOperations.push('multiplication');
            if (document.getElementById('opDivision').checked) allowedOperations.push('division');
            
            if (allowedOperations.length === 0) {
                alert('Please select at least one operation!');
                return;
            }
            
            localStorage.setItem('allowedOperations', JSON.stringify(allowedOperations));
            document.getElementById('settingsModal').classList.remove('active');
            
            // Update game screen dropdowns
            document.getElementById('gradeLevel').value = gradeLevel;
        }

        // Close modal
        function closeModal() {
            document.getElementById('mathModal').classList.remove('active');
        }

        // Show Pokemon info modal
        async function showPokemonInfo(number, name) {
            document.getElementById('pokemonInfoModal').classList.add('active');
            document.getElementById('pokemonInfoLoading').style.display = 'block';
            document.getElementById('pokemonInfoDisplay').style.display = 'none';

            try {
                // Fetch Pokemon data from PokeAPI
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${number}`);
                const data = await response.json();

                // Fetch species data for additional info
                const speciesResponse = await fetch(data.species.url);
                const speciesData = await speciesResponse.json();

                // Play type-specific sound
                playTypeSound(data.types);

                // Update modal with Pokemon data
                document.getElementById('infoSprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${number}.gif`;
                document.getElementById('infoName').textContent = name;
                document.getElementById('infoNumber').textContent = `#${String(number).padStart(3, '0')}`;

                // Types
                const typesContainer = document.getElementById('infoTypes');
                typesContainer.innerHTML = '';
                data.types.forEach(typeInfo => {
                    const typeEl = document.createElement('span');
                    typeEl.className = `type-badge type-${typeInfo.type.name}`;
                    typeEl.textContent = typeInfo.type.name;
                    typesContainer.appendChild(typeEl);
                });

                // Height and Weight (convert from decimeters and hectograms)
                const heightM = (data.height / 10).toFixed(1);
                const weightKg = (data.weight / 10).toFixed(1);
                document.getElementById('infoHeight').textContent = `${heightM} m`;
                document.getElementById('infoWeight').textContent = `${weightKg} kg`;

                // Habitat
                const habitat = speciesData.habitat ? speciesData.habitat.name : 'Unknown';
                document.getElementById('infoHabitat').textContent = habitat.charAt(0).toUpperCase() + habitat.slice(1);

                // Flavor text (story) - get English entry
                const flavorTexts = speciesData.flavor_text_entries.filter(entry => entry.language.name === 'en');
                let story = 'No description available.';
                if (flavorTexts.length > 0) {
                    // Get a random flavor text for variety
                    const randomIndex = Math.floor(Math.random() * Math.min(3, flavorTexts.length));
                    story = flavorTexts[randomIndex].flavor_text.replace(/\f/g, ' ').replace(/\n/g, ' ');
                }
                document.getElementById('infoStory').textContent = story;

                // Show the data
                document.getElementById('pokemonInfoLoading').style.display = 'none';
                document.getElementById('pokemonInfoDisplay').style.display = 'block';

            } catch (error) {
                console.error('Error fetching Pokemon data:', error);
                document.getElementById('pokemonInfoLoading').innerHTML = '‚ùå Error loading Pok√©mon data. Please try again.';
            }
        }

        // Close Pokemon info modal
        function closePokemonInfo() {
            document.getElementById('pokemonInfoModal').classList.remove('active');
        }

        // ========== BATTLE MODE FUNCTIONS ==========

        // Initialize battle mode
        function initializeBattleMode() {
            const caughtCount = Object.keys(caughtPokemon).length;
            
            if (caughtCount < 3) {
                alert(`You need at least 3 caught Pok√©mon to battle! You have ${caughtCount}. Keep catching!`);
                navigateTo('hunt');
                return;
            }
            
            selectedTeam = [];
            showTeamSelection();
        }

        // Show team selection screen
        function showTeamSelection() {
            document.getElementById('teamSelectionScreen').style.display = 'block';
            document.getElementById('battleArenaScreen').style.display = 'none';
            
            const container = document.getElementById('availablePokemon');
            container.innerHTML = '';
            
            pokemon.forEach((name, index) => {
                const number = index + 1;
                if (caughtPokemon[number]) {
                    const card = document.createElement('div');
                    card.className = 'selectable-pokemon';
                    card.id = `select-${number}`;
                    card.onclick = () => toggleTeamSelection(number, name);
                    
                    const sprite = document.createElement('img');
                    sprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${number}.gif`;
                    sprite.style.width = '60px';
                    sprite.style.height = '60px';
                    
                    const nameEl = document.createElement('div');
                    nameEl.style.fontSize = '0.8em';
                    nameEl.style.marginTop = '5px';
                    nameEl.textContent = name;
                    
                    card.appendChild(sprite);
                    card.appendChild(nameEl);
                    container.appendChild(card);
                }
            });
            
            updateSelectedTeamDisplay();
        }

        // Toggle Pokemon team selection
        function toggleTeamSelection(number, name) {
            const index = selectedTeam.findIndex(p => p.number === number);
            
            if (index > -1) {
                // Deselect
                selectedTeam.splice(index, 1);
                document.getElementById(`select-${number}`).classList.remove('selected');
            } else if (selectedTeam.length < 3) {
                // Select
                selectedTeam.push({ number, name });
                document.getElementById(`select-${number}`).classList.add('selected');
            }
            
            updateSelectedTeamDisplay();
        }

        // Update selected team display
        function updateSelectedTeamDisplay() {
            const container = document.getElementById('selectedTeamDisplay');
            container.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const slot = document.createElement('div');
                slot.className = 'team-slot';
                
                if (selectedTeam[i]) {
                    slot.classList.add('filled');
                    const sprite = document.createElement('img');
                    sprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${selectedTeam[i].number}.gif`;
                    const name = document.createElement('div');
                    name.className = 'slot-name';
                    name.textContent = selectedTeam[i].name;
                    slot.appendChild(sprite);
                    slot.appendChild(name);
                } else {
                    slot.textContent = '?';
                }
                
                container.appendChild(slot);
            }
            
            const startBtn = document.getElementById('startBattleBtn');
            if (selectedTeam.length === 3) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }

        // Start battle
        async function startBattleMode() {
            if (selectedTeam.length !== 3) return;
            
            try {
                // Show loading
                document.getElementById('battleMessage').textContent = 'Preparing battle...';
                
                console.log('Starting battle with team:', selectedTeam);
                
                // Fetch Pokemon data for selected team
                for (let p of selectedTeam) {
                    const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${p.number}`);
                    const data = await response.json();
                    p.types = data.types;
                    p.hp = 100;
                    p.maxHp = 100;
                    p.fainted = false;
                }
                
                console.log('Player team loaded');
                
                // Generate opponent team - AI gets access to ALL 150 Pokemon!
                const opponentTeam = [];
                const allPokemon = Array.from({length: 150}, (_, i) => i + 1); // 1-150
                
                // Shuffle and pick 3 random Pokemon for opponent
                const shuffled = allPokemon.sort(() => Math.random() - 0.5);
                const opponentPicks = shuffled.slice(0, 3);
                
                console.log('Opponent will use Pokemon:', opponentPicks);
                
                for (let pokemonNumber of opponentPicks) {
                    const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonNumber}`);
                    const data = await response.json();
                    
                    opponentTeam.push({
                        number: pokemonNumber,
                        name: pokemon[pokemonNumber - 1],
                        types: data.types,
                        hp: 100,
                        maxHp: 100,
                        fainted: false
                    });
                }
                
                console.log('Opponent team loaded:', opponentTeam);
                
                currentBattle = {
                    playerTeam: selectedTeam,
                    opponentTeam: opponentTeam,
                    playerIndex: 0,
                    opponentIndex: 0,
                    turn: 'player',
                    log: []
                };
                
                document.getElementById('teamSelectionScreen').style.display = 'none';
                document.getElementById('battleArenaScreen').style.display = 'block';
                
                console.log('Loading battle Pokemon...');
                loadBattlePokemon();
                addBattleLog('Battle Start!', '');
                startPlayerTurn();
                
            } catch (error) {
                console.error('Error starting battle:', error);
                alert('Error starting battle: ' + error.message + '\nPlease try again.');
                document.getElementById('battleMessage').textContent = 'Error starting battle. Please try again.';
            }
        }

        // Load Pokemon into battle arena
        function loadBattlePokemon() {
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            const opponentPokemon = currentBattle.opponentTeam[currentBattle.opponentIndex];
            
            // Player Pokemon
            document.getElementById('playerSprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${playerPokemon.number}.gif`;
            document.getElementById('playerPokemonName').textContent = playerPokemon.name;
            updateBattleHealth('player', playerPokemon.hp, playerPokemon.maxHp);
            
            // Opponent Pokemon
            document.getElementById('opponentSprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${opponentPokemon.number}.gif`;
            document.getElementById('opponentPokemonName').textContent = opponentPokemon.name;
            updateBattleHealth('opponent', opponentPokemon.hp, opponentPokemon.maxHp);
            
            // Update team display
            updateTeamDisplay();
            
            // Show player's Pokemon initially (it's their turn)
            showActivePokemon('player');
        }

        // Show the active Pokemon based on whose turn it is
        function showActivePokemon(side) {
            const playerDiv = document.querySelector('.battle-pokemon.player-pokemon');
            const opponentDiv = document.querySelector('.battle-pokemon.opponent-pokemon');
            
            playerDiv.classList.remove('active-turn');
            opponentDiv.classList.remove('active-turn');
            
            if (side === 'player') {
                playerDiv.classList.add('active-turn');
            } else {
                opponentDiv.classList.add('active-turn');
            }
        }

        // Update health bar
        function updateBattleHealth(side, hp, maxHp) {
            const healthBar = document.getElementById(`${side}HealthFill`);
            const healthText = document.getElementById(`${side}HealthText`);
            
            const percentage = Math.max(0, (hp / maxHp) * 100);
            healthBar.style.width = percentage + '%';
            healthText.textContent = `HP: ${Math.max(0, Math.floor(hp))}/${maxHp}`;
            
            healthBar.classList.remove('low', 'critical');
            if (percentage <= 20) {
                healthBar.classList.add('critical');
            } else if (percentage <= 50) {
                healthBar.classList.add('low');
            }
        }

        // Update team display
        function updateTeamDisplay() {
            const playerTeamEl = document.getElementById('playerTeamList');
            const opponentTeamEl = document.getElementById('opponentTeamList');
            
            playerTeamEl.innerHTML = currentBattle.playerTeam.map((p, i) => `
                <div class="team-pokemon-item ${i === currentBattle.playerIndex ? 'active' : ''} ${p.fainted ? 'fainted' : ''}">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.number}.gif">
                    <div style="font-size: 0.7em;">${p.name}</div>
                </div>
            `).join('');
            
            opponentTeamEl.innerHTML = currentBattle.opponentTeam.map((p, i) => `
                <div class="team-pokemon-item ${i === currentBattle.opponentIndex ? 'active' : ''} ${p.fainted ? 'fainted' : ''}">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.number}.gif">
                    <div style="font-size: 0.7em;">${p.name}</div>
                </div>
            `).join('');
        }

        // Start player turn
        function startPlayerTurn() {
            const mathData = generateMathProblem();
            currentBattle.currentQuestion = mathData.problem;
            currentBattle.currentAnswer = mathData.answer;
            currentBattle.turn = 'player';
            
            // Show player's Pokemon
            showActivePokemon('player');
            
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            const pokemonType = playerPokemon.types[0].type.name;
            const attacks = attacksByType[pokemonType] || attacksByType.normal;
            const attackName = attacks[Math.floor(Math.random() * attacks.length)];
            
            document.getElementById('attackNameDisplay').textContent = attackName;
            document.getElementById('attackTypeDisplay').textContent = pokemonType.toUpperCase();
            document.getElementById('attackTypeDisplay').className = `attack-type type-${pokemonType}`;
            
            document.getElementById('battleQuestionText').textContent = mathData.problem + ' = ?';
            document.getElementById('battleAnswerInput').value = '';
            document.getElementById('battleAnswerInput').focus();
            document.getElementById('battleMessage').textContent = `Use ${attackName}!`;
        }

        // Submit battle answer
        function submitBattleAnswer() {
            const userAnswer = parseInt(document.getElementById('battleAnswerInput').value);
            
            if (userAnswer === currentBattle.currentAnswer) {
                playSuccessSound();
                addBattleLog('Correct!', '');
                playerAttack();
            } else {
                playFailureSound();
                addBattleLog('Wrong answer!', 'damage');
                document.getElementById('battleMessage').textContent = 'Wrong answer! Opponent attacks!';
                setTimeout(() => opponentAttack(), 1500);
            }
        }

        // Player attacks
        function playerAttack() {
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            const opponentPokemon = currentBattle.opponentTeam[currentBattle.opponentIndex];
            
            const playerType = playerPokemon.types[0].type.name;
            const opponentType = opponentPokemon.types[0].type.name;
            
            let damage = 20;
            let effectiveness = 'normal';
            
            // Check type advantage
            if (typeChart[playerType]?.strong?.includes(opponentType)) {
                damage = 35;
                effectiveness = 'super';
            } else if (typeChart[playerType]?.weak?.includes(opponentType)) {
                damage = 10;
                effectiveness = 'weak';
            }
            
            const attacks = attacksByType[playerType] || attacksByType.normal;
            const attackName = attacks[Math.floor(Math.random() * attacks.length)];
            
            // Play epic attack animation!
            playBattleAttackAnimation('player', playerType, damage, effectiveness === 'super', effectiveness);
            
            setTimeout(() => {
                // Switch to show opponent getting hit
                showActivePokemon('opponent');
                
                opponentPokemon.hp -= damage;
                updateBattleHealth('opponent', opponentPokemon.hp, opponentPokemon.maxHp);
                
                let message = `${playerPokemon.name} used ${attackName}! ${damage} damage!`;
                if (effectiveness === 'super') {
                    message += ' Super effective!';
                    addBattleLog(message, 'super-effective');
                } else if (effectiveness === 'weak') {
                    message += ' Not very effective...';
                    addBattleLog(message, 'damage');
                } else {
                    addBattleLog(message, 'damage');
                }
                
                document.getElementById('battleMessage').textContent = message;
                
                setTimeout(() => {
                    if (opponentPokemon.hp <= 0) {
                        opponentPokemonFainted();
                    } else {
                        setTimeout(() => opponentAttack(), 1500);
                    }
                }, 800);
            }, 600);
        }

        // Opponent attacks
        function opponentAttack() {
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            const opponentPokemon = currentBattle.opponentTeam[currentBattle.opponentIndex];
            
            const opponentType = opponentPokemon.types[0].type.name;
            const playerType = playerPokemon.types[0].type.name;
            
            let damage = 15;
            let effectiveness = 'normal';
            
            if (typeChart[opponentType]?.strong?.includes(playerType)) {
                damage = 25;
                effectiveness = 'super';
            } else if (typeChart[opponentType]?.weak?.includes(playerType)) {
                damage = 8;
                effectiveness = 'weak';
            }
            
            const attacks = attacksByType[opponentType] || attacksByType.normal;
            const attackName = attacks[Math.floor(Math.random() * attacks.length)];
            
            // Play epic attack animation!
            playBattleAttackAnimation('opponent', opponentType, damage, effectiveness === 'super', effectiveness);
            
            setTimeout(() => {
                // Switch to show player getting hit
                showActivePokemon('player');
                
                playerPokemon.hp -= damage;
                updateBattleHealth('player', playerPokemon.hp, playerPokemon.maxHp);
                
                let message = `${opponentPokemon.name} used ${attackName}! ${damage} damage!`;
                if (effectiveness === 'super') {
                    message += ' Super effective!';
                }
                addBattleLog(message, 'damage');
                document.getElementById('battleMessage').textContent = message;
                
                setTimeout(() => {
                    if (playerPokemon.hp <= 0) {
                        playerPokemonFainted();
                    } else {
                        setTimeout(() => startPlayerTurn(), 1000);
                    }
                }, 800);
            }, 1200);
        }

        // Player Pokemon fainted
        function playerPokemonFainted() {
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            playerPokemon.fainted = true;
            
            document.getElementById('playerSprite').classList.add('fainted');
            addBattleLog(`${playerPokemon.name} fainted!`, 'damage');
            document.getElementById('battleMessage').textContent = `${playerPokemon.name} fainted!`;
            
            setTimeout(() => {
                // Check for next Pokemon
                currentBattle.playerIndex++;
                
                if (currentBattle.playerIndex >= currentBattle.playerTeam.length) {
                    endBattle(false);
                } else {
                    document.getElementById('playerSprite').classList.remove('fainted');
                    loadBattlePokemon();
                    addBattleLog(`Go! ${currentBattle.playerTeam[currentBattle.playerIndex].name}!`, '');
                    setTimeout(() => startPlayerTurn(), 1500);
                }
            }, 2000);
        }

        // Opponent Pokemon fainted
        function opponentPokemonFainted() {
            const opponentPokemon = currentBattle.opponentTeam[currentBattle.opponentIndex];
            opponentPokemon.fainted = true;
            
            document.getElementById('opponentSprite').classList.add('fainted');
            addBattleLog(`Enemy ${opponentPokemon.name} fainted!`, 'heal');
            document.getElementById('battleMessage').textContent = `Enemy ${opponentPokemon.name} fainted!`;
            playSuccessSound();
            
            setTimeout(() => {
                currentBattle.opponentIndex++;
                
                if (currentBattle.opponentIndex >= currentBattle.opponentTeam.length) {
                    endBattle(true);
                } else {
                    document.getElementById('opponentSprite').classList.remove('fainted');
                    loadBattlePokemon();
                    addBattleLog(`Opponent sent out ${currentBattle.opponentTeam[currentBattle.opponentIndex].name}!`, '');
                    setTimeout(() => startPlayerTurn(), 1500);
                }
            }, 2000);
        }

        // Add entry to battle log
        function addBattleLog(message, type) {
            const log = document.getElementById('battleLog');
            const entry = document.createElement('div');
            entry.className = `battle-log-entry ${type}`;
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // End battle
        function endBattle(playerWon) {
            const modal = document.getElementById('battleResultModal');
            const content = document.getElementById('battleResultContent');
            const title = document.getElementById('battleResultTitle');
            const message = document.getElementById('battleResultMessage');
            const reward = document.getElementById('battleRewardDisplay');
            
            modal.classList.add('active');
            
            if (playerWon) {
                content.className = 'battle-result-content victory';
                title.textContent = 'üèÜ VICTORY! üèÜ';
                message.textContent = 'You defeated the opponent trainer!';
                playLegendaryFanfare();
                
                // Increment battles won
                gameStats.battlesWon = (gameStats.battlesWon || 0) + 1;
                saveGameStats();
                checkBadges();
                
                // Check for new battle badges
                const newBadges = [];
                if (gameStats.battlesWon === 1 && !gameStats.unlockedBadges.includes('rookie_trainer')) {
                    newBadges.push({ id: 'rookie_trainer', name: 'Rookie Trainer', icon: '‚öîÔ∏è' });
                }
                if (gameStats.battlesWon === 10 && !gameStats.unlockedBadges.includes('experienced_trainer')) {
                    newBadges.push({ id: 'experienced_trainer', name: 'Experienced Trainer', icon: 'üó°Ô∏è' });
                }
                if (gameStats.battlesWon === 25 && !gameStats.unlockedBadges.includes('veteran_trainer')) {
                    newBadges.push({ id: 'veteran_trainer', name: 'Veteran Trainer', icon: 'üõ°Ô∏è' });
                }
                if (gameStats.battlesWon === 50 && !gameStats.unlockedBadges.includes('battle_master')) {
                    newBadges.push({ id: 'battle_master', name: 'Battle Master', icon: 'üëë' });
                }
                
                if (newBadges.length > 0) {
                    reward.style.display = 'block';
                    reward.innerHTML = newBadges.map(badge => `
                        <h3>üèÜ New Badge Unlocked!</h3>
                        <div style="font-size: 3em; margin: 10px 0;">${badge.icon}</div>
                        <div style="font-size: 1.3em; font-weight: bold;">${badge.name}</div>
                        <p>Battles Won: ${gameStats.battlesWon}</p>
                    `).join('<hr style="margin: 20px 0;">');
                } else {
                    reward.style.display = 'none';
                }
            } else {
                content.className = 'battle-result-content defeat';
                title.textContent = 'üíî DEFEAT üíî';
                message.textContent = 'You were defeated... Train harder and try again!';
                playFailureSound();
                reward.style.display = 'none';
            }
        }

        // Close battle result
        function closeBattleResult() {
            document.getElementById('battleResultModal').classList.remove('active');
            initializeBattleMode();
        }

        // Get Pok√©mon sprite URL from PokeAPI
        function getPokemonSpriteUrl(number, isCaught) {
            if (isCaught) {
                // Return pokeball sprite
                return 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';
            }
            // Return animated pokemon sprite from PokeAPI (Generation V Black/White animated sprites)
            return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${number}.gif`;
        }

        // Get Pok√©mon cry/sound URL from PokeAPI
        function getPokemonCryUrl(number) {
            return `https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/${number}.ogg`;
        }

        // Play Pok√©mon cry sound
        function playPokemonCry(number) {
            // Don't play if muted
            if (isMuted) {
                return;
            }
            
            const audio = new Audio(getPokemonCryUrl(number));
            audio.volume = 0.5; // Set volume to 50% so it's not too loud
            audio.play().catch(err => {
                console.log('Could not play cry:', err);
                // Fallback: Try legacy cry format
                const legacyAudio = new Audio(`https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/legacy/${number}.ogg`);
                legacyAudio.volume = 0.5;
                legacyAudio.play().catch(e => console.log('Legacy cry also failed:', e));
            });
        }

        // Initialize grid
        function initializeGrid() {
            const grid = document.getElementById('pokemonGrid');
            grid.innerHTML = '';

            pokemon.forEach((name, index) => {
                const number = index + 1;
                const isCaught = caughtPokemon[number];
                
                const card = document.createElement('div');
                card.className = `pokemon-card ${isCaught ? 'caught' : 'uncaught'}`;
                card.onclick = () => {
                    // Can view caught Pokemon info
                    if (isCaught) {
                        showPokemonInfo(number, name);
                    }
                };

                // Add pointer cursor for caught Pokemon
                if (isCaught) {
                    card.style.cursor = 'pointer';
                }

                const sprite = document.createElement('img');
                sprite.className = 'pokemon-sprite';
                // Show pokeball for uncaught, Pokemon sprite for caught
                sprite.src = isCaught ? getPokemonSpriteUrl(number, false) : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';
                sprite.alt = isCaught ? name : '???';

                const nameEl = document.createElement('div');
                nameEl.className = 'pokemon-name';
                nameEl.textContent = isCaught ? name : '???';

                const numberEl = document.createElement('div');
                numberEl.className = 'pokemon-number';
                numberEl.textContent = `#${String(number).padStart(3, '0')}`;

                card.appendChild(sprite);
                card.appendChild(nameEl);
                card.appendChild(numberEl);
                grid.appendChild(card);
            });

            updateStats();
        }

        // Close modal
        function closeModal() {
            const mathModal = document.getElementById('mathModal');
            mathModal.classList.remove('active');
            currentPokemon = null;
            
            // Reset UI elements that may have been hidden during pokeball animation
            mathModal.querySelector('#modalSprite').style.visibility = 'visible';
            mathModal.querySelector('.speech-bubble').style.display = 'block';
            mathModal.querySelector('.answer-section').style.display = 'block';
        }

        // Check answer
        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            const feedback = document.getElementById('feedback');
            const celebration = document.getElementById('celebration');
            const modalSprite = document.getElementById('modalSprite');

            gameStats.totalProblems++;
            
            if (userAnswer === currentAnswer) {
                feedback.textContent = '‚úì Correct!';
                feedback.className = 'feedback correct';

                // Play success sound
                playSuccessSound();

                // Update stats
                gameStats.correctAnswers++;
                gameStats.currentStreak++;
                if (gameStats.currentStreak > gameStats.bestStreak) {
                    gameStats.bestStreak = gameStats.currentStreak;
                }
                
                // Track operation type
                if (lastOperationType) {
                    gameStats.operationCounts[lastOperationType]++;
                }

                if (currentPokemon) {
                    // There was a Pok√©mon in this bush!
                    
                    // Hide modal UI for clean pokeball animation
                    const mathModal = document.getElementById('mathModal');
                    mathModal.querySelector('#modalSprite').style.visibility = 'hidden';
                    mathModal.querySelector('.speech-bubble').style.display = 'none';
                    mathModal.querySelector('.answer-section').style.display = 'none';
                    
                    // Trigger Pokeball catch animation!
                    const pokemonType = currentPokemon.types ? currentPokemon.types[0]?.type?.name : 'normal';
                    playPokeballCatchAnimation(pokemonType);
                    
                    // Check if legendary and play special fanfare
                    if (legendaryPokemon.includes(currentPokemon.number)) {
                        setTimeout(() => {
                            playLegendaryFanfare();
                            playCatchFanfare(); // Also play catch fanfare
                        }, 3400); // Synced with pokeball opening
                        celebration.textContent = 'üåü LEGENDARY POK√âMON CAUGHT! üåü';
                    } else {
                        // Play catch fanfare for normal Pokemon
                        setTimeout(() => {
                            playCatchFanfare();
                        }, 3400); // Synced with pokeball opening
                        celebration.textContent = 'üéâ Pok√©mon Caught! üéâ';
                    }
                    
                    setTimeout(() => {
                        celebration.style.display = 'block';
                    }, 3600); // Show celebration after pokeball opens

                    // Mark as caught
                    caughtPokemon[currentPokemon.number] = true;
                    localStorage.setItem('caughtPokemon', JSON.stringify(caughtPokemon));
                    
                    // Cache Pokemon types for badge tracking
                    fetch(`https://pokeapi.co/api/v2/pokemon/${currentPokemon.number}`)
                        .then(response => response.json())
                        .then(data => {
                            const types = data.types.map(t => t.type.name);
                            pokemonTypeCache[currentPokemon.number] = types;
                            localStorage.setItem('pokemonTypeCache', JSON.stringify(pokemonTypeCache));
                        })
                        .catch(err => console.log('Could not cache types:', err));
                    
                    saveGameStats();
                    updateStreakDisplay();
                    updateBadgeCount();
                    checkBadges();

                    // Store the caught Pokemon info for display
                    const caughtPokemonNumber = currentPokemon.number;
                    const caughtPokemonName = currentPokemon.name;

                    setTimeout(() => {
                        closeModal();
                        // Reset all bushes for new round after catching Pokemon
                        resetBushes();
                        
                        // Navigate to Pokedex and show the caught Pokemon info
                        setTimeout(() => {
                            navigateTo('pokedex');
                            // Wait for Pokedex to load, then show Pokemon info
                            setTimeout(() => {
                                showPokemonInfo(caughtPokemonNumber, caughtPokemonName);
                            }, 300);
                        }, 500);
                    }, 5000); // Extended to 5 seconds to show celebration
                } else {
                    // Empty bush - mark it as checked
                    celebration.textContent = '‚úì Bush checked! Try another!';
                    
                    setTimeout(() => {
                        celebration.style.display = 'block';
                        modalSprite.classList.remove('catching');
                    }, 800);
                    
                    saveGameStats();
                    updateStreakDisplay();
                    updateBadgeCount();
                    checkBadges();

                    // Mark this bush as checked
                    checkedBushes.push(selectedBush);
                    document.getElementById(`bush-${selectedBush}`).classList.add('checked');

                    setTimeout(() => {
                        closeModal();
                        
                        // Check if all bushes are checked
                        if (checkedBushes.length === 3) {
                            // All bushes checked, reset for new round
                            setTimeout(() => {
                                resetBushes();
                                document.getElementById('bushHeader').textContent = 'üåø No Pok√©mon this time! Try again! üåø';
                            }, 500);
                        }
                    }, 1500);
                }
            } else {
                // Wrong answer - Pokemon runs away or stays in bush
                feedback.textContent = '‚úó Wrong answer!';
                feedback.className = 'feedback incorrect';
                
                // Play failure sound
                playFailureSound();
                
                // Reset streak
                gameStats.currentStreak = 0;
                saveGameStats();
                updateStreakDisplay();
                
                if (currentPokemon) {
                    // Pokemon runs away - trigger run animation
                    modalSprite.classList.add('run-away');
                    
                    setTimeout(() => {
                        closeModal();
                        showRanAwayNotification(currentPokemon.name);
                        modalSprite.classList.remove('run-away');
                        // Reset bushes after Pokemon runs away
                        setTimeout(() => {
                            resetBushes();
                        }, 2000);
                    }, 800);
                } else {
                    // Empty bush - just close modal, don't mark as checked
                    setTimeout(() => {
                        closeModal();
                    }, 1500);
                }
            }
        }

        // Show ran away notification
        function showRanAwayNotification(pokemonName) {
            const notification = document.getElementById('ranAwayNotification');
            document.getElementById('pokemonName').textContent = pokemonName;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        // Show reset confirmation modal
        function showResetConfirmation() {
            const count = Object.keys(caughtPokemon).length;
            if (count === 0) {
                alert("You haven't caught any Pok√©mon yet!");
                return;
            }
            document.getElementById('confirmCount').textContent = count;
            document.getElementById('confirmModal').classList.add('active');
        }

        // Close reset confirmation modal
        function closeResetConfirmation() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        // Confirm and execute reset
        function confirmReset() {
            caughtPokemon = {};
            localStorage.setItem('caughtPokemon', JSON.stringify(caughtPokemon));
            closeResetConfirmation();
            initializeGrid();
            
            // Show success notification
            const notification = document.getElementById('ranAwayNotification');
            notification.innerHTML = 'üîÑ All Pok√©mon released! Start fresh! üîÑ';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
                notification.innerHTML = 'üí® <span id="pokemonName"></span> ran away! üí®';
            }, 2500);
        }

        // Show full game reset confirmation
        function showFullResetConfirmation() {
            const pokemonCount = Object.keys(caughtPokemon).length;
            const badgeCount = gameStats.unlockedBadges.length;
            
            document.getElementById('fullResetCount').textContent = pokemonCount;
            document.getElementById('fullResetBadges').textContent = badgeCount;
            document.getElementById('fullResetModal').classList.add('active');
        }

        // Close full game reset confirmation
        function closeFullResetConfirmation() {
            document.getElementById('fullResetModal').classList.remove('active');
        }

        // Confirm and execute full game reset
        function confirmFullReset() {
            // Clear all data
            localStorage.removeItem('caughtPokemon');
            localStorage.removeItem('gameStats');
            localStorage.removeItem('operationMode');
            localStorage.removeItem('gradeLevel');
            localStorage.removeItem('allowedOperations');
            localStorage.removeItem('isMuted');
            
            // Reset all variables to defaults
            caughtPokemon = {};
            gameStats = {
                totalProblems: 0,
                correctAnswers: 0,
                currentStreak: 0,
                bestStreak: 0,
                operationCounts: { addition: 0, subtraction: 0, multiplication: 0, division: 0 },
                unlockedBadges: []
            };
            operationMode = 'random';
            gradeLevel = 4;
            allowedOperations = ['addition', 'subtraction', 'multiplication', 'division'];
            isMuted = false;
            
            closeFullResetConfirmation();
            
            // Show success notification
            const notification = document.getElementById('ranAwayNotification');
            notification.innerHTML = '‚ú® Game completely reset! Welcome back, Trainer! ‚ú®';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
                notification.innerHTML = 'üí® <span id="pokemonName"></span> ran away! üí®';
            }, 3000);
            
            // Update all displays
            updateBadgeCount();
            updateStreakDisplay();
            updateMuteButton();
            setOperation('random');
            document.getElementById('gradeLevel').value = 4;
            initializeGrid();
        }

        // Open badge modal
        function openBadgeModal() {
            renderBadges();
            updateStatsDisplay();
            document.getElementById('badgeModal').classList.add('active');
        }

        // Close badge modal
        function closeBadgeModal() {
            document.getElementById('badgeModal').classList.remove('active');
        }

        // Render badges in modal
        function renderBadges() {
            const grid = document.getElementById('badgesGrid');
            grid.innerHTML = '';

            badges.forEach(badge => {
                const isUnlocked = gameStats.unlockedBadges.includes(badge.id);
                const progress = getBadgeProgress(badge);
                
                const badgeEl = document.createElement('div');
                badgeEl.className = `badge-item ${isUnlocked ? 'unlocked' : 'locked'}`;
                
                badgeEl.innerHTML = `
                    <div class="badge-icon">${badge.icon}</div>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                    ${!isUnlocked ? `<div class="badge-progress">${progress}</div>` : '<div class="badge-progress">‚úì Unlocked!</div>'}
                `;
                
                grid.appendChild(badgeEl);
            });
        }

        // Get badge progress text
        function getBadgeProgress(badge) {
            switch(badge.id) {
                case 'math_trainer':
                    return `${Object.keys(caughtPokemon).length}/10 caught`;
                case 'gym_leader':
                    return `${Object.keys(caughtPokemon).length}/50 caught`;
                case 'champion':
                    return `${Object.keys(caughtPokemon).length}/150 caught`;
                case 'no_mistakes':
                    return `${gameStats.currentStreak}/5 streak`;
                case 'operation_master_add':
                    return `${gameStats.operationCounts.addition}/20 completed`;
                case 'operation_master_sub':
                    return `${gameStats.operationCounts.subtraction}/20 completed`;
                case 'operation_master_mult':
                    return `${gameStats.operationCounts.multiplication}/20 completed`;
                case 'operation_master_div':
                    return `${gameStats.operationCounts.division}/20 completed`;
                case 'perfect_ten':
                    return `${gameStats.bestStreak}/10 best streak`;
                case 'scholar':
                    return `${gameStats.totalProblems}/100 solved`;
                case 'ace_student':
                    const accuracy = gameStats.totalProblems > 0 ? Math.round((gameStats.correctAnswers / gameStats.totalProblems) * 100) : 0;
                    return `${accuracy}% accuracy (need 90%)`;
                default:
                    return 'In progress...';
            }
        }

        // Update stats display in modal
        function updateStatsDisplay() {
            document.getElementById('total-problems').textContent = gameStats.totalProblems;
            
            const accuracy = gameStats.totalProblems > 0 
                ? Math.round((gameStats.correctAnswers / gameStats.totalProblems) * 100) 
                : 0;
            document.getElementById('accuracy-rate').textContent = accuracy + '%';
            
            document.getElementById('best-streak').textContent = gameStats.bestStreak;
            
            // Find favorite operation
            const ops = gameStats.operationCounts;
            const favorite = Object.keys(ops).reduce((a, b) => ops[a] > ops[b] ? a : b);
            const favoriteIcons = {
                addition: '‚ûï Addition',
                subtraction: '‚ûñ Subtraction',
                multiplication: '‚úñÔ∏è Multiplication',
                division: '‚ûó Division'
            };
            document.getElementById('favorite-operation').textContent = 
                ops[favorite] > 0 ? favoriteIcons[favorite] : '-';
        }

        // Update stats
        function updateStats() {
            const count = Object.keys(caughtPokemon).length;
            document.getElementById('caught-count').textContent = count;
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
            
            updateMuteButton(); // Initialize mute button state
            setOperation(operationMode); // Initialize operation mode button state
            document.getElementById('gradeLevel').value = gradeLevel; // Initialize grade level dropdown
            updateBadgeCount(); // Initialize badge count
            updateStreakDisplay(); // Initialize streak display
            initializeGrid();
        });
    </script>
</body>
</html>
