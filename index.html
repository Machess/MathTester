<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pok√©mon Math Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        /* Page Routing */
        .page {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .page.active {
            display: block;
        }

        /* Navigation Bar */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(59, 76, 202, 0.95);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .nav-bar.hidden {
            display: none;
        }

        .nav-brand {
            color: #ffcb05;
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 2px 2px 0 #3b4cca;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #ffcb05;
            color: #3b4cca;
            border-color: #ffcb05;
        }

        .page-content {
            margin-top: 80px;
        }

        /* Start Screen */
        .start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        .game-logo {
            background: linear-gradient(135deg, #ffcb05 0%, #ffd700 100%);
            border: 5px solid #3b4cca;
            border-radius: 30px;
            padding: 40px 60px;
            margin-bottom: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .game-logo h1 {
            font-size: 4em;
            color: #3b4cca;
            text-shadow: 3px 3px 0px #fff;
            margin-bottom: 10px;
        }

        .game-logo .subtitle {
            font-size: 1.5em;
            color: #3b4cca;
            font-weight: bold;
        }

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .start-btn, .settings-btn {
            background: #3b4cca;
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .start-btn:hover, .settings-btn:hover {
            background: #2a3799;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .settings-btn {
            background: #6b7280;
        }

        .settings-btn:hover {
            background: #4b5563;
        }

        .reset-game-btn {
            background: #ef4444;
        }

        .reset-game-btn:hover {
            background: #dc2626;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-content h2 {
            color: #3b4cca;
            margin-bottom: 30px;
            text-align: center;
        }

        .setting-group {
            margin-bottom: 25px;
        }

        .setting-group label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .setting-group select,
        .setting-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .operation-settings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .operation-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 8px;
        }

        .operation-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .save-settings-btn {
            width: 100%;
            background: #3b4cca;
            color: white;
            border: none;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
        }

        .save-settings-btn:hover {
            background: #2a3799;
        }

        /* Bush Selection Screen */
        .bush-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .bush-screen h2 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .bushes-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .bush {
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .bush:hover {
            transform: translateY(-10px) scale(1.05);
            animation: bushPulse 0.6s ease-in-out infinite;
        }

        @keyframes bushPulse {
            0%, 100% { transform: translateY(-10px) scale(1.05); }
            50% { transform: translateY(-15px) scale(1.1); }
        }

        .bush.checked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .bush.checked:hover {
            transform: none;
            animation: none;
        }

        .bush.checked .bush-image {
            filter: grayscale(1) drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }

        .bush.checked .bush-label {
            text-decoration: line-through;
        }

        .bush-image {
            width: 150px;
            height: 150px;
            font-size: 8em;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }

        .bush-label {
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
        }

        .empty-bush-message {
            display: none;
        }

        /* Game Screen */
        .game-screen {
            min-height: 100vh;
        }

        .pokedex-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .pokedex-title {
            font-size: 3em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .pokedex-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .pokedex-controls .reset-button,
        .pokedex-controls .mute-button {
            position: relative;
            top: auto;
            right: auto;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .pokedex-filters {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .mute-button {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255,255,255,0.2);
            border: 3px solid white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
        }

        .mute-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .mute-button.muted {
            background: rgba(255,0,0,0.3);
            border-color: #ff6b6b;
        }

        .reset-button {
            position: absolute;
            top: 0;
            right: 70px;
            background: rgba(255,0,0,0.3);
            border: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
        }

        .reset-button:hover {
            background: rgba(255,0,0,0.5);
            transform: scale(1.1);
        }

        h1 {
            font-size: 3em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .stats {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            display: inline-block;
            font-size: 1.2em;
            font-weight: bold;
        }

        .stats-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 15px 20px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 150px;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .badges-button {
            background: rgba(255,203,5,0.3);
            border: 3px solid #ffcb05;
            color: white;
            padding: 12px 24px;
            border-radius: 15px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badges-button:hover {
            background: rgba(255,203,5,0.5);
            transform: translateY(-2px);
        }

        .badge-notification {
            position: relative;
        }

        .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            border: 2px solid white;
        }

        /* Badge Modal */
        .badge-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .badge-modal.active {
            display: flex;
        }

        .badge-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .badge-modal-content h2 {
            color: #3b4cca;
            margin-bottom: 10px;
            text-align: center;
            font-size: 2em;
        }

        .badge-modal-content .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .badge-item {
            background: #f3f4f6;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .badge-item.unlocked {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #ffcb05;
            box-shadow: 0 4px 15px rgba(255, 203, 5, 0.3);
        }

        .badge-item.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .badge-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .badge-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .badge-description {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .badge-progress {
            font-size: 0.8em;
            color: #3b4cca;
            font-weight: bold;
        }

        .stats-section {
            background: #f3f4f6;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .stats-section h3 {
            color: #3b4cca;
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-item-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-item-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #3b4cca;
        }

        /* New Badge Popup */
        .new-badge-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            z-index: 3000;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: badgePopIn 0.5s ease;
        }

        @keyframes badgePopIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .new-badge-popup h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .new-badge-popup .badge-icon {
            font-size: 4em;
            margin: 20px 0;
        }

        .new-badge-popup .badge-name {
            font-size: 1.5em;
            color: #ffcb05;
        }

        /* Pokemon Info Modal */
        .pokemon-info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .pokemon-info-modal.active {
            display: flex;
        }

        .pokemon-info-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .pokemon-info-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #ffcb05;
        }

        .pokemon-info-sprite {
            width: 120px;
            height: 120px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .pokemon-info-title {
            flex: 1;
        }

        .pokemon-info-title h2 {
            color: #3b4cca;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .pokemon-info-number {
            color: #666;
            font-size: 1.2em;
        }

        .pokemon-info-section {
            margin-bottom: 25px;
        }

        .pokemon-info-section h3 {
            color: #3b4cca;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .pokemon-types {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pokemon-type {
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .type-normal { background: #A8A878; }
        .type-fire { background: #F08030; }
        .type-water { background: #6890F0; }
        .type-electric { background: #F8D030; color: #333; }
        .type-grass { background: #78C850; }
        .type-ice { background: #98D8D8; }
        .type-fighting { background: #C03028; }
        .type-poison { background: #A040A0; }
        .type-ground { background: #E0C068; }
        .type-flying { background: #A890F0; }
        .type-psychic { background: #F85888; }
        .type-bug { background: #A8B820; }
        .type-rock { background: #B8A038; }
        .type-ghost { background: #705898; }
        .type-dragon { background: #7038F8; }
        .type-dark { background: #705848; }
        .type-steel { background: #B8B8D0; }
        .type-fairy { background: #EE99AC; }

        .pokemon-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 10px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #3b4cca;
        }

        .pokemon-story {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 10px;
            line-height: 1.6;
            color: #333;
            font-style: italic;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            font-size: 2em;
        }

        /* Battle Mode Styles */
        .battle-screen {
            min-height: 100vh;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8D8 50%, #8B7355 100%);
            padding: 20px;
        }

        .battle-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .team-selection {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .team-selection h2 {
            color: #3b4cca;
            text-align: center;
            margin-bottom: 20px;
        }

        .available-pokemon {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .selectable-pokemon {
            background: #f3f4f6;
            border: 3px solid #ddd;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .selectable-pokemon:hover {
            transform: translateY(-5px);
            border-color: #ffcb05;
        }

        .selectable-pokemon.selected {
            border-color: #22c55e;
            background: #d1fae5;
        }

        .selectable-pokemon.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .selected-team {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .team-slot {
            width: 100px;
            height: 120px;
            border: 3px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            background: #f9fafb;
        }

        .team-slot.filled {
            border-style: solid;
            border-color: #22c55e;
            background: white;
            flex-direction: column;
            padding: 5px;
        }

        .team-slot img {
            width: 60px;
            height: 60px;
        }

        .team-slot .slot-name {
            font-size: 0.4em;
            margin-top: 5px;
        }

        .start-battle-btn {
            width: 100%;
            padding: 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-battle-btn:hover {
            background: #dc2626;
            transform: scale(1.02);
        }

        .start-battle-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* Battle Arena */
        .battle-arena {
            display: none;
        }

        .battle-arena.active {
            display: block;
        }

        .battle-field {
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8D8 50%, #8FBC8F 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 450px;
            position: relative;
        }

        .battle-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 20px;
        }

        .trainer-side {
            flex: 1;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .trainer-side.player {
            text-align: left;
            border: 3px solid #22c55e;
        }

        .trainer-side.opponent {
            text-align: right;
            border: 3px solid #ef4444;
        }

        .trainer-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .trainer-side.player .trainer-name {
            color: #22c55e;
        }

        .trainer-side.opponent .trainer-name {
            color: #ef4444;
        }

        .battle-pokemon-display {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 350px;
            position: relative;
        }

        .battle-pokemon {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        /* Hide Pokemon by default, show only during their turn */
        .battle-pokemon.player-pokemon {
            display: none;
        }

        .battle-pokemon.opponent-pokemon {
            display: none;
        }

        /* Show Pokemon when it's their turn */
        .battle-pokemon.player-pokemon.active-turn {
            display: block;
        }

        .battle-pokemon.opponent-pokemon.active-turn {
            display: block;
        }

        .battle-pokemon-sprite {
            width: 220px;
            height: 220px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            margin: 20px auto;
        }

        .battle-pokemon-sprite.attacking {
            animation: attackMove 0.6s ease;
        }

        @keyframes attackMove {
            0%, 100% { transform: translateX(0) scale(1); }
            50% { transform: translateX(40px) scale(1.2); }
        }

        .battle-pokemon.opponent-pokemon .battle-pokemon-sprite.attacking {
            animation: attackMoveLeft 0.6s ease;
        }

        @keyframes attackMoveLeft {
            0%, 100% { transform: translateX(0) scale(1); }
            50% { transform: translateX(-40px) scale(1.2); }
        }

        .battle-pokemon-sprite.hit {
            animation: hitShake 0.5s ease;
        }

        @keyframes hitShake {
            0%, 100% { transform: translateX(0); filter: brightness(1); }
            25%, 75% { transform: translateX(-10px); filter: brightness(2); }
            50% { transform: translateX(10px); filter: brightness(0.5); }
        }

        .battle-pokemon-sprite.fainted {
            animation: faint 1s ease forwards;
        }

        @keyframes faint {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(50px) scale(0.3); }
        }

        .pokemon-name-battle {
            font-size: 1.5em;
            font-weight: bold;
            color: #1f2937;
            margin: 10px 0;
        }

        .pokemon-health-bar {
            background: #e5e7eb;
            border-radius: 10px;
            height: 25px;
            margin: 10px auto;
            overflow: hidden;
            border: 3px solid #1f2937;
            max-width: 250px;
            position: relative;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(to right, #22c55e, #16a34a);
            transition: width 0.5s ease, background 0.3s ease;
            position: relative;
        }

        .health-fill.low {
            background: linear-gradient(to right, #f59e0b, #d97706);
        }

        .health-fill.critical {
            background: linear-gradient(to right, #ef4444, #dc2626);
        }

        .pokemon-info-bar {
            margin-top: 8px;
            font-size: 1em;
            font-weight: bold;
            color: #1f2937;
        }

        .battle-log {
            background: #1f2937;
            color: white;
            border-radius: 15px;
            padding: 20px;
            min-height: 120px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            border: 3px solid #374151;
        }

        .battle-log-entry {
            margin-bottom: 8px;
            padding: 6px 10px;
            border-left: 4px solid #3b82f6;
            padding-left: 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
        }

        .battle-log-entry.damage {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .battle-log-entry.heal {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .battle-log-entry.super-effective {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            font-weight: bold;
        }

        .battle-controls {
            background: white;
            border-radius: 20px;
            padding: 30px;
        }

        .attack-display {
            text-align: center;
            margin-bottom: 20px;
        }

        .attack-name {
            font-size: 2em;
            font-weight: bold;
            color: #3b4cca;
            margin-bottom: 10px;
        }

        .attack-type {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .team-pokemon-list {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .team-pokemon-item {
            width: 80px;
            padding: 10px;
            background: #f3f4f6;
            border: 3px solid #ddd;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .team-pokemon-item.active {
            border-color: #22c55e;
            background: #d1fae5;
        }

        .team-pokemon-item.fainted {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .team-pokemon-item img {
            width: 50px;
            height: 50px;
        }

        .battle-result-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .battle-result-modal.active {
            display: flex;
        }

        .battle-result-content {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
        }

        .battle-result-content h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .battle-result-content.victory h2 {
            color: #22c55e;
        }

        .battle-result-content.defeat h2 {
            color: #ef4444;
        }

        .battle-reward {
            background: #fef3c7;
            border: 3px solid #ffcb05;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .battle-reward h3 {
            color: #3b4cca;
            margin-bottom: 10px;
        }

        /* Battle Mode Styles */
        .battle-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            position: relative;
            overflow: hidden;
        }

        .battle-field {
            position: relative;
            height: 400px;
            margin: 20px auto;
            max-width: 800px;
            perspective: 1000px;
        }

        .battle-pokemon {
            position: absolute;
            text-align: center;
            transition: all 0.3s ease;
        }

        .battle-pokemon.player {
            bottom: 20px;
            left: 20px;
        }

        .battle-pokemon.opponent {
            top: 20px;
            right: 20px;
        }

        .battle-sprite {
            width: 150px;
            height: 150px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }

        .battle-sprite.attacking {
            animation: attack 0.6s ease;
        }

        @keyframes attack {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(30px) scale(1.2); }
        }

        .battle-sprite.hit {
            animation: hit 0.5s ease;
        }

        @keyframes hit {
            0%, 100% { transform: translateX(0); filter: brightness(1); }
            25%, 75% { transform: translateX(-10px); filter: brightness(2); }
            50% { transform: translateX(10px); filter: brightness(0.5); }
        }

        .battle-sprite.fainted {
            animation: faint 1s ease forwards;
        }

        @keyframes faint {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(50px) scale(0.5); }
        }

        .health-bar-container {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .pokemon-name-battle {
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
            margin-bottom: 5px;
        }

        .health-bar {
            width: 200px;
            height: 25px;
            background: #ddd;
            border-radius: 12px;
            overflow: hidden;
            border: 3px solid #333;
            position: relative;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            transition: width 0.5s ease, background 0.3s ease;
            position: relative;
        }

        .health-fill.low {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .health-fill.medium {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            z-index: 1;
        }

        .battle-controls {
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 20px;
            max-width: 800px;
            margin: 20px auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .battle-question {
            font-size: 1.8em;
            font-weight: bold;
            color: #3b4cca;
            margin-bottom: 20px;
            text-align: center;
        }

        .battle-message {
            background: #3b4cca;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.1em;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .attack-animation {
            position: absolute;
            font-size: 3em;
            pointer-events: none;
            z-index: 10;
        }

        .attack-animation.fire {
            animation: fireAttack 1s ease forwards;
        }

        @keyframes fireAttack {
            0% { opacity: 1; transform: scale(0.5) translate(0, 0); }
            50% { opacity: 1; transform: scale(1.5) translate(200px, -100px); }
            100% { opacity: 0; transform: scale(0.5) translate(400px, -200px); }
        }

        .attack-animation.water {
            animation: waterAttack 1s ease forwards;
        }

        @keyframes waterAttack {
            0% { opacity: 1; transform: scale(0.5) translate(0, 0); }
            50% { opacity: 1; transform: scale(1.5) translate(200px, -100px) rotate(180deg); }
            100% { opacity: 0; transform: scale(0.5) translate(400px, -200px) rotate(360deg); }
        }

        .attack-animation.electric {
            animation: electricAttack 0.6s ease forwards;
        }

        @keyframes electricAttack {
            0% { opacity: 1; transform: translate(0, 0); }
            100% { opacity: 0; transform: translate(400px, -200px); filter: brightness(3); }
        }

        .attack-animation.grass {
            animation: grassAttack 1s ease forwards;
        }

        @keyframes grassAttack {
            0% { opacity: 1; transform: scale(1) translate(0, 0); }
            50% { opacity: 1; transform: scale(1.2) translate(200px, -100px); }
            100% { opacity: 0; transform: scale(0.8) translate(400px, -200px); }
        }

        .team-selection {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 900px;
            margin: 20px auto;
        }

        .team-selection h2 {
            color: #3b4cca;
            text-align: center;
            margin-bottom: 20px;
        }

        .available-pokemon {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .selectable-pokemon {
            background: #f3f4f6;
            border: 3px solid transparent;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .selectable-pokemon:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .selectable-pokemon.selected {
            border-color: #3b4cca;
            background: #e0e7ff;
        }

        .selectable-pokemon.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .selected-team {
            background: #e0e7ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .selected-team h3 {
            color: #3b4cca;
            margin-bottom: 15px;
        }

        .team-display {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .battle-result {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            max-width: 600px;
            margin: 20px auto;
        }

        .battle-result h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .battle-result.victory h2 {
            color: #22c55e;
        }

        .battle-result.defeat h2 {
            color: #ef4444;
        }

        .battle-reward {
            background: #fef3c7;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 3px solid #ffcb05;
        }

        .operation-filters {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .operation-btn {
            background: rgba(255,255,255,0.3);
            border: 3px solid white;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .operation-btn:hover {
            background: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .operation-btn.active {
            background: #ffcb05;
            color: #3b4cca;
            border-color: #ffcb05;
            box-shadow: 0 4px 15px rgba(255, 203, 5, 0.4);
        }

        .grade-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 12px;
            border: 3px solid white;
        }

        .grade-selector label {
            color: white;
            font-weight: bold;
            font-size: 1em;
            white-space: nowrap;
        }

        .grade-selector select {
            background: white;
            color: #3b4cca;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            min-width: 120px;
        }

        .grade-selector select:focus {
            outline: 2px solid #ffcb05;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            background: rgba(255,255,255,0.9);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .pokemon-card {
            background: white;
            border: 3px solid #ffcb05;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .pokemon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .pokemon-card.caught {
            background: white;
            border-color: #22c55e;
        }

        .pokemon-card.uncaught {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .pokemon-card.uncaught .pokemon-sprite {
            filter: brightness(0.7);
        }

        .pokemon-sprite {
            width: 64px;
            height: 64px;
            margin: 0 auto;
            transition: transform 0.3s ease;
        }

        .pokemon-card:hover .pokemon-sprite {
            transform: scale(1.2) translateY(-5px);
            filter: brightness(1.1);
        }

        .pokemon-card.caught:hover .pokemon-sprite {
            animation: wiggle 0.5s ease infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: scale(1.2) translateY(-5px) rotate(0deg); }
            25% { transform: scale(1.2) translateY(-5px) rotate(-5deg); }
            75% { transform: scale(1.2) translateY(-5px) rotate(5deg); }
        }

        .pokemon-name {
            font-size: 0.75em;
            margin-top: 5px;
            font-weight: bold;
            color: #333;
        }

        .pokemon-number {
            font-size: 0.65em;
            color: #666;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }

        .close-btn:hover {
            color: #333;
        }

        .pokemon-display {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 30px;
        }

        .pokemon-modal-sprite {
            width: 120px;
            height: 120px;
            animation: pokemonEntrance 0.6s ease-out;
        }

        @keyframes pokemonEntrance {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }
            60% {
                transform: scale(1.1) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .pokemon-modal-sprite.catching {
            animation: catchShake 0.8s ease-in-out;
        }

        @keyframes catchShake {
            0%, 100% { transform: translateX(0) scale(1); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px) scale(1.05); }
            20%, 40%, 60%, 80% { transform: translateX(10px) scale(0.95); }
        }

        .pokemon-modal-sprite.caught-success {
            animation: caughtSuccess 1s ease-out;
        }

        @keyframes caughtSuccess {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3) rotate(360deg); opacity: 0.8; }
            100% { transform: scale(0.5); opacity: 0; }
        }

        .pokemon-modal-sprite.run-away {
            animation: runAway 0.6s ease-in;
        }

        @keyframes runAway {
            0% { transform: translateX(0) scale(1); opacity: 1; }
            100% { transform: translateX(200px) scale(0.3); opacity: 0; }
        }

        .speech-bubble {
            background: #fff;
            border: 3px solid #333;
            border-radius: 20px;
            padding: 20px;
            position: relative;
            flex: 1;
        }

        .speech-bubble:before {
            content: '';
            position: absolute;
            left: -20px;
            top: 30px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 20px 10px 0;
            border-color: transparent #333 transparent transparent;
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            left: -14px;
            top: 33px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 7px 14px 7px 0;
            border-color: transparent #fff transparent transparent;
        }

        .math-problem {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .answer-section {
            text-align: center;
        }

        .answer-input {
            font-size: 1.5em;
            padding: 15px;
            border: 3px solid #ffcb05;
            border-radius: 10px;
            width: 200px;
            text-align: center;
            margin-bottom: 20px;
        }

        .submit-btn {
            background: #3b4cca;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #2a3799;
            transform: scale(1.05);
        }

        .feedback {
            margin-top: 20px;
            font-size: 1.3em;
            font-weight: bold;
            min-height: 30px;
        }

        .feedback.correct {
            color: #22c55e;
        }

        .feedback.incorrect {
            color: #ef4444;
        }

        .celebration {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-size: 2em;
            animation: bounce 0.5s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .ran-away-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            z-index: 2000;
            display: none;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: fadeInOut 2s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        /* Confirmation Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal.active {
            display: flex;
        }

        .confirm-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .confirm-content h2 {
            color: #ef4444;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .confirm-content p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn.cancel {
            background: #6b7280;
            color: white;
        }

        .confirm-btn.cancel:hover {
            background: #4b5563;
        }

        .confirm-btn.confirm {
            background: #ef4444;
            color: white;
        }

        .confirm-btn.confirm:hover {
            background: #dc2626;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .page {
                padding: 10px;
            }

            .page-content {
                margin-top: 70px;
            }

            .nav-bar {
                padding: 10px 15px;
            }

            .nav-brand {
                font-size: 1.2em;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .game-logo h1 {
                font-size: 2.5em;
            }

            .game-logo .subtitle {
                font-size: 1.2em;
            }

            .game-logo {
                padding: 30px 40px;
            }

            .start-btn, .settings-btn {
                padding: 15px 40px;
                font-size: 1.2em;
            }

            .bush-screen h2 {
                font-size: 1.8em;
                margin-bottom: 30px;
            }

            .bushes-container {
                gap: 20px;
            }

            .bush-image {
                width: 100px;
                height: 100px;
                font-size: 5em;
            }

            .settings-content {
                padding: 30px 20px;
            }

            .operation-settings {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }

            .pokedex-title {
                font-size: 2em;
            }

            .pokedex-controls {
                gap: 10px;
            }

            .pokedex-controls .reset-button,
            .pokedex-controls .mute-button {
                width: 50px;
                height: 50px;
                font-size: 1.3em;
            }

            .pokedex-filters {
                padding: 15px;
            }

            .stats {
                font-size: 1em;
                padding: 10px;
            }

            .stats-container {
                gap: 10px;
            }

            .stat-box {
                padding: 10px 15px;
                min-width: 120px;
            }

            .stat-label {
                font-size: 0.75em;
            }

            .stat-value {
                font-size: 1.1em;
            }

            .badges-button {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .badge-count {
                width: 20px;
                height: 20px;
                font-size: 0.7em;
            }

            .badge-modal-content {
                padding: 20px;
            }

            .badge-modal-content h2 {
                font-size: 1.5em;
            }

            .badges-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }

            .badge-item {
                padding: 15px;
            }

            .badge-icon {
                font-size: 2.5em;
            }

            .badge-name {
                font-size: 1em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .new-badge-popup {
                padding: 30px 20px;
                width: 90%;
            }

            .new-badge-popup h3 {
                font-size: 1.4em;
            }

            .new-badge-popup .badge-icon {
                font-size: 3em;
            }

            .pokemon-info-content {
                padding: 30px 20px;
            }

            .pokemon-info-header {
                flex-direction: column;
                text-align: center;
            }

            .pokemon-info-sprite {
                width: 100px;
                height: 100px;
            }

            .pokemon-info-title h2 {
                font-size: 1.6em;
            }

            .pokemon-stats {
                grid-template-columns: 1fr;
            }

            .battle-field {
                height: auto;
                padding: 15px;
            }

            .battle-pokemon-sprite {
                width: 140px;
                height: 140px;
            }

            .battle-pokemon-display {
                flex-direction: column;
                padding: 0 10px;
                gap: 30px;
            }

            .battle-pokemon {
                max-width: 100%;
                width: 100%;
            }

            .battle-pokemon.player-pokemon,
            .battle-pokemon.opponent-pokemon {
                margin: 0;
            }

            .battle-status {
                flex-direction: column;
                gap: 10px;
            }

            .pokemon-health-bar {
                max-width: 250px;
                margin: 10px auto;
            }

            .attack-name {
                font-size: 1.3em;
            }

            .battle-controls {
                padding: 20px;
            }

            .battle-log {
                font-size: 0.85em;
                max-height: 100px;
                min-height: 80px;
            }

            .available-pokemon {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }

            .operation-filters {
                gap: 8px;
                margin-top: 15px;
            }

            .operation-btn {
                padding: 10px 16px;
                font-size: 0.9em;
                min-width: 80px;
                flex: 1 1 calc(50% - 8px);
                max-width: calc(50% - 8px);
            }

            .grade-selector {
                width: 100%;
                justify-content: center;
                padding: 10px;
            }

            .grade-selector label {
                font-size: 0.9em;
            }

            .grade-selector select {
                font-size: 0.9em;
                padding: 6px 10px;
                min-width: 100px;
            }

            .mute-button {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }

            .reset-button {
                width: 50px;
                height: 50px;
                font-size: 1.3em;
                right: 60px;
            }

            .pokemon-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 10px;
                padding: 15px;
            }

            .pokemon-card {
                padding: 8px;
            }

            .pokemon-sprite {
                width: 50px;
                height: 50px;
            }

            .pokemon-name {
                font-size: 0.65em;
            }

            .pokemon-number {
                font-size: 0.55em;
            }

            /* Mobile Modal Styles */
            .modal-content {
                padding: 20px;
                width: 95%;
                max-width: 95%;
                margin: 10px;
            }

            .close-btn {
                top: 10px;
                right: 10px;
                font-size: 1.5em;
            }

            .pokemon-display {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .pokemon-modal-sprite {
                width: 100px;
                height: 100px;
            }

            .speech-bubble {
                padding: 15px;
                width: 100%;
            }

            .speech-bubble:before,
            .speech-bubble:after {
                display: none; /* Hide speech bubble arrow on mobile for cleaner look */
            }

            .math-problem {
                font-size: 1.4em;
                margin-bottom: 15px;
            }

            .answer-input {
                font-size: 1.2em;
                padding: 12px;
                width: 100%;
                max-width: 250px;
            }

            .submit-btn {
                padding: 12px 30px;
                font-size: 1em;
                width: 100%;
                max-width: 250px;
            }

            .feedback {
                font-size: 1.1em;
            }

            .celebration {
                font-size: 1.5em;
            }

            .ran-away-notification {
                font-size: 1.3em;
                padding: 30px 40px;
                width: 90%;
            }

            .confirm-content {
                padding: 30px 20px;
            }

            .confirm-content h2 {
                font-size: 1.5em;
            }

            .confirm-content p {
                font-size: 1em;
            }

            .confirm-buttons {
                flex-direction: column;
            }

            .confirm-btn {
                width: 100%;
                padding: 12px 30px;
            }
        }

        /* Extra small mobile devices */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }

            .operation-btn {
                padding: 8px 12px;
                font-size: 0.85em;
                min-width: 70px;
            }

            .pokemon-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
                padding: 10px;
            }

            .pokemon-sprite {
                width: 45px;
                height: 45px;
            }

            .modal-content {
                padding: 15px;
            }

            .math-problem {
                font-size: 1.2em;
            }

            .answer-input {
                font-size: 1.1em;
                padding: 10px;
            }

            .submit-btn {
                font-size: 0.9em;
                padding: 10px 25px;
            }
        }

        /* Landscape mode on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }

            .pokemon-display {
                flex-direction: row;
                gap: 10px;
            }

            .pokemon-modal-sprite {
                width: 80px;
                height: 80px;
            }

            .speech-bubble {
                padding: 10px;
            }

            .math-problem {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar (hidden on start screen) -->
    <div class="nav-bar hidden" id="navBar">
        <div class="nav-brand">POK√âMON Math</div>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="navigateTo('menu')">üè† Menu</button>
            <button class="nav-btn" onclick="navigateTo('hunt')">üå≥ Hunt</button>
            <button class="nav-btn" onclick="navigateTo('battle')">‚öîÔ∏è Battle</button>
            <button class="nav-btn" onclick="navigateTo('pokedex')">üìñ Pok√©dex</button>
        </div>
    </div>

    <!-- START MENU PAGE -->
    <div class="page active" id="menuPage">
        <div class="start-screen">
            <div class="game-logo">
                <h1>POK√âMON</h1>
                <div class="subtitle">Math Challenge</div>
            </div>
            <div class="start-buttons">
                <button class="start-btn" onclick="startGame()">‚ñ∂ Start Game</button>
                <button class="start-btn" onclick="startBattleFromMenu()" style="background: #ef4444;">‚öîÔ∏è Battle Mode</button>
                <button class="settings-btn" onclick="openSettings()">‚öô Settings</button>
                <button class="badges-button" style="margin-top: 20px;" onclick="openBadgeModal()">
                    <div class="badge-notification">
                        üèÜ My Badges
                        <span class="badge-count" id="badge-count-menu">0</span>
                    </div>
                </button>
                <button class="reset-game-btn start-btn" onclick="showFullResetConfirmation()">üîÑ Reset All Progress</button>
            </div>
        </div>
    </div>

    <!-- BUSH HUNTING PAGE -->
    <div class="page" id="huntPage">
        <div class="bush-screen">
            <h2 id="bushHeader">üåø Choose a bush to search! üåø</h2>
            <div class="bushes-container">
                <div class="bush" id="bush-0" onclick="selectBush(0)">
                    <div class="bush-image">üå≥</div>
                    <div class="bush-label">Bush 1</div>
                </div>
                <div class="bush" id="bush-1" onclick="selectBush(1)">
                    <div class="bush-image">üå≥</div>
                    <div class="bush-label">Bush 2</div>
                </div>
                <div class="bush" id="bush-2" onclick="selectBush(2)">
                    <div class="bush-image">üå≥</div>
                    <div class="bush-label">Bush 3</div>
                </div>
            </div>
        </div>
    </div>

    <!-- BATTLE MODE PAGE -->
    <div class="page" id="battlePage">
        <div class="battle-screen">
            <div class="battle-container">
                <!-- Team Selection Screen -->
                <div id="teamSelectionScreen" class="team-selection">
                    <h2>‚öîÔ∏è Select Your Battle Team ‚öîÔ∏è</h2>
                    <p style="text-align: center; color: #666; margin-bottom: 20px;">
                        Choose 3 Pok√©mon from your collection to battle!
                    </p>
                    
                    <div class="selected-team" id="selectedTeamDisplay"></div>

                    <h3 style="text-align: center; margin: 20px 0;">Available Pok√©mon:</h3>
                    <div class="available-pokemon" id="availablePokemon"></div>

                    <button class="start-battle-btn" onclick="startBattleMode()" id="startBattleBtn" disabled>
                        ‚öîÔ∏è Start Battle!
                    </button>
                </div>

                <!-- Battle Arena Screen -->
                <div id="battleArenaScreen" style="display: none;">
                    <div class="battle-field">
                        <!-- Battle Status - Team Overview -->
                        <div class="battle-status">
                            <div class="trainer-side player">
                                <div class="trainer-name">üë§ YOUR TEAM</div>
                                <div class="team-pokemon-list" id="playerTeamList"></div>
                            </div>
                            <div class="trainer-side opponent">
                                <div class="trainer-name">RIVAL TRAINER ü§ñ</div>
                                <div class="team-pokemon-list" id="opponentTeamList"></div>
                            </div>
                        </div>

                        <!-- Pokemon Display - Main Battle Area -->
                        <div class="battle-pokemon-display">
                            <div class="battle-pokemon player-pokemon">
                                <div class="pokemon-name-battle" id="playerPokemonName">Your Pok√©mon</div>
                                <img class="battle-pokemon-sprite" id="playerSprite" src="" alt="">
                                <div class="pokemon-health-bar">
                                    <div class="health-fill" id="playerHealthFill" style="width: 100%;"></div>
                                </div>
                                <div class="pokemon-info-bar" id="playerHealthText">HP: 100/100</div>
                            </div>

                            <div class="battle-pokemon opponent-pokemon">
                                <div class="pokemon-name-battle" id="opponentPokemonName">Opponent Pok√©mon</div>
                                <img class="battle-pokemon-sprite" id="opponentSprite" src="" alt="">
                                <div class="pokemon-health-bar">
                                    <div class="health-fill" id="opponentHealthFill" style="width: 100%;"></div>
                                </div>
                                <div class="pokemon-info-bar" id="opponentHealthText">HP: 100/100</div>
                            </div>
                        </div>
                    </div>

                    <!-- Battle Controls -->
                    <div class="battle-controls">
                        <div class="battle-message" id="battleMessage">
                            Get ready to battle!
                        </div>

                        <div class="attack-display">
                            <div class="attack-name" id="attackNameDisplay"></div>
                            <div class="attack-type" id="attackTypeDisplay"></div>
                        </div>

                        <div class="battle-question" id="battleQuestionText"></div>
                        <div class="answer-section" style="text-align: center; margin-top: 20px;">
                            <input type="number" inputmode="numeric" pattern="[0-9]*" class="answer-input" id="battleAnswerInput" placeholder="Enter answer" style="font-size: 1.5em; padding: 15px; width: 200px;">
                            <br>
                            <button class="submit-btn" onclick="submitBattleAnswer()" style="margin-top: 15px; padding: 15px 40px; font-size: 1.2em;">‚öîÔ∏è Attack!</button>
                        </div>
                    </div>

                    <!-- Battle Log -->
                    <div class="battle-log" id="battleLog"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Battle Result Modal -->
    <div class="battle-result-modal" id="battleResultModal">
        <div class="battle-result-content" id="battleResultContent">
            <h2 id="battleResultTitle">Victory!</h2>
            <p id="battleResultMessage"></p>
            <div class="battle-reward" id="battleRewardDisplay" style="display: none;"></div>
            <button class="start-btn" onclick="closeBattleResult()" style="margin: 10px;">Battle Again</button>
            <button class="settings-btn" onclick="navigateTo('menu'); closeBattleResult();">Main Menu</button>
        </div>
    </div>

    <!-- POK√âDEX PAGE -->
    <div class="page" id="pokedexPage">
        <div class="page-content">
            <div class="pokedex-header">
                <h1 class="pokedex-title">üìñ Pok√©dex üìñ</h1>
                
                <div class="pokedex-controls">
                    <button class="mute-button" id="muteButton" onclick="toggleMute()" title="Toggle Sound">
                        üîä
                    </button>
                    <button class="reset-button" id="resetButton" onclick="showResetConfirmation()" title="Reset All Caught Pok√©mon">
                        üîÑ
                    </button>
                </div>

                <div class="stats-container" style="margin-bottom: 20px;">
                    <div class="stat-box stats">
                        <div class="stat-label">Pok√©mon Caught</div>
                        <div class="stat-value"><span id="caught-count">0</span> / 150</div>
                    </div>
                    <div class="stat-box stats">
                        <div class="stat-label">üî• Current Streak</div>
                        <div class="stat-value"><span id="streak-count">0</span></div>
                    </div>
                    <button class="badges-button" onclick="openBadgeModal()">
                        <div class="badge-notification">
                            üèÜ My Badges
                            <span class="badge-count" id="badge-count">0</span>
                        </div>
                    </button>
                </div>
            </div>

            <div class="container">
                <div class="pokedex-filters">
                    <div class="operation-filters">
                        <button class="operation-btn" onclick="setOperation('addition')" data-operation="addition">
                            ‚ûï Addition
                        </button>
                        <button class="operation-btn" onclick="setOperation('subtraction')" data-operation="subtraction">
                            ‚ûñ Subtraction
                        </button>
                        <button class="operation-btn" onclick="setOperation('multiplication')" data-operation="multiplication">
                            ‚úñÔ∏è Multiplication
                        </button>
                        <button class="operation-btn" onclick="setOperation('division')" data-operation="division">
                            ‚ûó Division
                        </button>
                        <button class="operation-btn active" onclick="setOperation('random')" data-operation="random">
                            üé≤ Random
                        </button>
                        <div class="grade-selector">
                            <label for="gradeLevel">üìö Grade:</label>
                            <select id="gradeLevel" onchange="setGradeLevel(this.value)">
                                <option value="1">1st Grade (Age 6)</option>
                                <option value="2">2nd Grade (Age 7)</option>
                                <option value="3">3rd Grade (Age 8)</option>
                                <option value="4" selected>4th Grade (Age 9)</option>
                                <option value="5">5th Grade (Age 10)</option>
                                <option value="6">6th Grade (Age 11)</option>
                                <option value="7">7th Grade (Age 12)</option>
                                <option value="8">8th Grade (Age 13)</option>
                                <option value="9">9th Grade (Age 14)</option>
                                <option value="10">10th Grade (Age 15-16)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="pokemon-grid" id="pokemonGrid"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <button class="close-btn" onclick="closeSettings()">√ó</button>
            <h2>‚öôÔ∏è Game Settings</h2>
            
            <div class="setting-group">
                <label for="settingsGrade">üìö Grade Level</label>
                <select id="settingsGrade">
                    <option value="1">1st Grade (Age 6)</option>
                    <option value="2">2nd Grade (Age 7)</option>
                    <option value="3">3rd Grade (Age 8)</option>
                    <option value="4" selected>4th Grade (Age 9)</option>
                    <option value="5">5th Grade (Age 10)</option>
                    <option value="6">6th Grade (Age 11)</option>
                    <option value="7">7th Grade (Age 12)</option>
                    <option value="8">8th Grade (Age 13)</option>
                    <option value="9">9th Grade (Age 14)</option>
                    <option value="10">10th Grade (Age 15-16)</option>
                </select>
            </div>

            <div class="setting-group">
                <label>üé≤ Math Operations (Select at least one)</label>
                <div class="operation-settings">
                    <label class="operation-checkbox">
                        <input type="checkbox" id="opAddition" value="addition" checked>
                        <span>‚ûï Addition</span>
                    </label>
                    <label class="operation-checkbox">
                        <input type="checkbox" id="opSubtraction" value="subtraction" checked>
                        <span>‚ûñ Subtraction</span>
                    </label>
                    <label class="operation-checkbox">
                        <input type="checkbox" id="opMultiplication" value="multiplication" checked>
                        <span>‚úñÔ∏è Multiplication</span>
                    </label>
                    <label class="operation-checkbox">
                        <input type="checkbox" id="opDivision" value="division" checked>
                        <span>‚ûó Division</span>
                    </label>
                </div>
            </div>

            <button class="save-settings-btn" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <!-- Math Problem Modal -->
    <div class="modal" id="mathModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">√ó</button>
            
            <div class="pokemon-display">
                <img class="pokemon-modal-sprite" id="modalSprite" src="" alt="">
                <div class="speech-bubble">
                    <div class="math-problem" id="mathProblem"></div>
                </div>
            </div>

            <div class="answer-section">
                <input type="number" inputmode="numeric" pattern="[0-9]*" class="answer-input" id="answerInput" placeholder="Answer">
                <br>
                <button class="submit-btn" id="submitBtn" onclick="checkAnswer()">Catch Pok√©mon!</button>
                <div class="feedback" id="feedback"></div>
                <div class="celebration" id="celebration">üéâ Pok√©mon Caught! üéâ</div>
            </div>
        </div>
    </div>

    <!-- Empty Bush Message -->
    <div class="empty-bush-message" id="emptyBushMessage">
        üçÉ Nothing here... Try another bush! üçÉ
    </div>

    <!-- Ran Away Notification -->
    <div class="ran-away-notification" id="ranAwayNotification">
        üí® <span id="pokemonName"></span> ran away! üí®
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h2>‚ö†Ô∏è Reset Progress?</h2>
            <p>Are you sure you want to reset all caught Pok√©mon? This will release all <strong><span id="confirmCount">0</span> Pok√©mon</strong> you've caught and you'll start over from the beginning.</p>
            <p><strong>This action cannot be undone!</strong></p>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="closeResetConfirmation()">Cancel</button>
                <button class="confirm-btn confirm" onclick="confirmReset()">Reset Pok√©mon</button>
            </div>
        </div>
    </div>

    <!-- Full Game Reset Confirmation Modal -->
    <div class="confirm-modal" id="fullResetModal">
        <div class="confirm-content">
            <h2>‚ö†Ô∏è RESET EVERYTHING?</h2>
            <p style="color: #ef4444; font-weight: bold;">This will delete ALL your progress including:</p>
            <ul style="text-align: left; margin: 20px 40px; color: #666;">
                <li>All <strong><span id="fullResetCount">0</span> caught Pok√©mon</strong></li>
                <li>All <strong><span id="fullResetBadges">0</span> unlocked badges</strong></li>
                <li>All stats and streak records</li>
                <li>Settings will be reset to defaults</li>
            </ul>
            <p><strong>THIS CANNOT BE UNDONE!</strong></p>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="closeFullResetConfirmation()">Cancel</button>
                <button class="confirm-btn confirm" onclick="confirmFullReset()">Delete Everything</button>
            </div>
        </div>
    </div>

    <!-- Badge Modal -->
    <div class="badge-modal" id="badgeModal">
        <div class="badge-modal-content">
            <button class="close-btn" onclick="closeBadgeModal()">√ó</button>
            <h2>üèÜ Achievement Badges</h2>
            <p class="subtitle">Unlock badges by catching Pok√©mon and solving math problems!</p>
            
            <div class="badges-grid" id="badgesGrid"></div>
            
            <div class="stats-section">
                <h3>üìä Your Stats</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-item-label">Total Problems Solved</div>
                        <div class="stat-item-value" id="total-problems">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Accuracy Rate</div>
                        <div class="stat-item-value" id="accuracy-rate">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Best Streak</div>
                        <div class="stat-item-value" id="best-streak">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Favorite Operation</div>
                        <div class="stat-item-value" id="favorite-operation">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Badge Popup -->
    <div class="new-badge-popup" id="newBadgePopup">
        <h3>üéâ Badge Unlocked! üéâ</h3>
        <div class="badge-icon" id="newBadgeIcon"></div>
        <div class="badge-name" id="newBadgeName"></div>
    </div>

    <!-- Pokemon Info Modal -->
    <div class="pokemon-info-modal" id="pokemonInfoModal">
        <div class="pokemon-info-content">
            <button class="close-btn" onclick="closePokemonInfo()">√ó</button>
            
            <div id="pokemonInfoLoading" class="loading-spinner">
                Loading... ‚ö°
            </div>
            
            <div id="pokemonInfoDisplay" style="display: none;">
                <div class="pokemon-info-header">
                    <img class="pokemon-info-sprite" id="infoSprite" src="" alt="">
                    <div class="pokemon-info-title">
                        <h2 id="infoName"></h2>
                        <div class="pokemon-info-number" id="infoNumber"></div>
                    </div>
                </div>

                <div class="pokemon-info-section">
                    <h3>üìä Type</h3>
                    <div class="pokemon-types" id="infoTypes"></div>
                </div>

                <div class="pokemon-info-section">
                    <h3>üìè Physical Stats</h3>
                    <div class="pokemon-stats">
                        <div class="stat-item">
                            <div class="stat-label">Height</div>
                            <div class="stat-value" id="infoHeight"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Weight</div>
                            <div class="stat-value" id="infoWeight"></div>
                        </div>
                    </div>
                </div>

                <div class="pokemon-info-section">
                    <h3>üåç Habitat</h3>
                    <div class="stat-item">
                        <div class="stat-value" id="infoHabitat"></div>
                    </div>
                </div>

                <div class="pokemon-info-section">
                    <h3>üìñ Story</h3>
                    <div class="pokemon-story" id="infoStory"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Kanto Pok√©mon (1-150)
        const pokemon = [
            "Bulbasaur", "Ivysaur", "Venusaur", "Charmander", "Charmeleon", "Charizard", 
            "Squirtle", "Wartortle", "Blastoise", "Caterpie", "Metapod", "Butterfree",
            "Weedle", "Kakuna", "Beedrill", "Pidgey", "Pidgeotto", "Pidgeot",
            "Rattata", "Raticate", "Spearow", "Fearow", "Ekans", "Arbok",
            "Pikachu", "Raichu", "Sandshrew", "Sandslash", "Nidoran‚ôÄ", "Nidorina",
            "Nidoqueen", "Nidoran‚ôÇ", "Nidorino", "Nidoking", "Clefairy", "Clefable",
            "Vulpix", "Ninetales", "Jigglypuff", "Wigglytuff", "Zubat", "Golbat",
            "Oddish", "Gloom", "Vileplume", "Paras", "Parasect", "Venonat",
            "Venomoth", "Diglett", "Dugtrio", "Meowth", "Persian", "Psyduck",
            "Golduck", "Mankey", "Primeape", "Growlithe", "Arcanine", "Poliwag",
            "Poliwhirl", "Poliwrath", "Abra", "Kadabra", "Alakazam", "Machop",
            "Machoke", "Machamp", "Bellsprout", "Weepinbell", "Victreebel", "Tentacool",
            "Tentacruel", "Geodude", "Graveler", "Golem", "Ponyta", "Rapidash",
            "Slowpoke", "Slowbro", "Magnemite", "Magneton", "Farfetch'd", "Doduo",
            "Dodrio", "Seel", "Dewgong", "Grimer", "Muk", "Shellder",
            "Cloyster", "Gastly", "Haunter", "Gengar", "Onix", "Drowzee",
            "Hypno", "Krabby", "Kingler", "Voltorb", "Electrode", "Exeggcute",
            "Exeggutor", "Cubone", "Marowak", "Hitmonlee", "Hitmonchan", "Lickitung",
            "Koffing", "Weezing", "Rhyhorn", "Rhydon", "Chansey", "Tangela",
            "Kangaskhan", "Horsea", "Seadra", "Goldeen", "Seaking", "Staryu",
            "Starmie", "Mr. Mime", "Scyther", "Jynx", "Electabuzz", "Magmar",
            "Pinsir", "Tauros", "Magikarp", "Gyarados", "Lapras", "Ditto",
            "Eevee", "Vaporeon", "Jolteon", "Flareon", "Porygon", "Omanyte",
            "Omastar", "Kabuto", "Kabutops", "Aerodactyl", "Snorlax", "Articuno",
            "Zapdos", "Moltres", "Dratini", "Dragonair", "Dragonite", "Mewtwo", "Mew"
        ];

        let caughtPokemon = JSON.parse(localStorage.getItem('caughtPokemon')) || {};
        let currentPokemon = null;
        let currentAnswer = 0;
        let isMuted = JSON.parse(localStorage.getItem('isMuted')) || false;
        let operationMode = localStorage.getItem('operationMode') || 'random';
        let gradeLevel = parseInt(localStorage.getItem('gradeLevel')) || 4;
        let allowedOperations = JSON.parse(localStorage.getItem('allowedOperations')) || ['addition', 'subtraction', 'multiplication', 'division'];
        let selectedBush = null;
        let pokemonInBush = false;
        let checkedBushes = []; // Track which bushes have been checked
        
        // Sound system
        let currentMusic = null;
        let isMusicPlaying = false;
        
        // Music tracks
        const musicTracks = {
            menu: '03__Opening_.mp3',
            hunt: '06_Pallet_Town_Theme.mp3',
            battle: '03__Opening_.mp3',
            pokedex: '03__Opening_.mp3',
            catchFanfare: '14_Fanfare_Item_Get_1.mp3'
        };
        
        // Play background music
        function playBackgroundMusic(track) {
            if (isMuted) return;
            
            // Stop current music if playing
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
            }
            
            // Create new audio element
            currentMusic = new Audio(musicTracks[track]);
            currentMusic.loop = true;
            currentMusic.volume = 0.3;
            
            currentMusic.play().catch(err => {
                console.log('Music playback prevented:', err);
            });
            
            isMusicPlaying = true;
        }

        function stopBackgroundMusic() {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
            }
            isMusicPlaying = false;
        }
        
        // Play catch fanfare (doesn't loop)
        function playCatchFanfare() {
            if (isMuted) return;
            
            const fanfare = new Audio(musicTracks.catchFanfare);
            fanfare.volume = 0.5;
            fanfare.play().catch(err => {
                console.log('Fanfare playback prevented:', err);
            });
        }
        
        // Legendary Pokemon (special fanfare)
        const legendaryPokemon = [144, 145, 146, 150, 151]; // Articuno, Zapdos, Moltres, Mewtwo, Mew
        
        // Battle system
        let selectedTeam = [];
        let currentBattle = null;
        let playerTeamIndex = 0;
        let opponentTeamIndex = 0;
        
        // Type advantage chart (simplified)
        const typeChart = {
            fire: { weak: ['water', 'rock', 'ground'], strong: ['grass', 'ice', 'bug'] },
            water: { weak: ['electric', 'grass'], strong: ['fire', 'ground', 'rock'] },
            electric: { weak: ['ground'], strong: ['water', 'flying'] },
            grass: { weak: ['fire', 'ice', 'poison', 'flying', 'bug'], strong: ['water', 'ground', 'rock'] },
            normal: { weak: ['fighting'], strong: [] },
            fighting: { weak: ['flying', 'psychic'], strong: ['normal', 'ice', 'rock'] },
            poison: { weak: ['ground', 'psychic'], strong: ['grass'] },
            ground: { weak: ['water', 'grass', 'ice'], strong: ['fire', 'electric', 'poison', 'rock'] },
            flying: { weak: ['electric', 'ice', 'rock'], strong: ['fighting', 'bug', 'grass'] },
            psychic: { weak: ['bug', 'ghost'], strong: ['fighting', 'poison'] },
            bug: { weak: ['fire', 'flying', 'rock'], strong: ['grass', 'psychic'] },
            rock: { weak: ['water', 'grass', 'fighting', 'ground'], strong: ['fire', 'ice', 'flying', 'bug'] },
            ghost: { weak: ['ghost'], strong: ['psychic', 'ghost'] },
            ice: { weak: ['fire', 'fighting', 'rock'], strong: ['grass', 'ground', 'flying'] },
            dragon: { weak: ['ice', 'dragon'], strong: ['dragon'] },
            dark: { weak: ['fighting', 'bug'], strong: ['psychic', 'ghost'] },
            steel: { weak: ['fire', 'fighting', 'ground'], strong: ['ice', 'rock'] },
            fairy: { weak: ['poison', 'steel'], strong: ['fighting', 'dragon', 'dark'] }
        };
        
        // Attack names by type
        const attacksByType = {
            fire: ['üî• Flamethrower', 'üî• Fire Blast', 'üî• Ember'],
            water: ['üíß Hydro Pump', 'üíß Water Gun', 'üíß Surf'],
            electric: ['‚ö° Thunderbolt', '‚ö° Thunder', '‚ö° Spark'],
            grass: ['üåø Razor Leaf', 'üåø Solar Beam', 'üåø Vine Whip'],
            normal: ['‚≠ê Tackle', '‚≠ê Quick Attack', '‚≠ê Body Slam'],
            fighting: ['üëä Karate Chop', 'üëä Low Kick', 'üëä Submission'],
            poison: ['‚ò†Ô∏è Poison Sting', '‚ò†Ô∏è Sludge Bomb', '‚ò†Ô∏è Acid'],
            ground: ['üåç Earthquake', 'üåç Dig', 'üåç Sand Attack'],
            flying: ['ü¶Ö Wing Attack', 'ü¶Ö Aerial Ace', 'ü¶Ö Gust'],
            psychic: ['üîÆ Psychic', 'üîÆ Confusion', 'üîÆ Psybeam'],
            bug: ['üêõ Bug Bite', 'üêõ String Shot', 'üêõ Twineedle'],
            rock: ['ü™® Rock Throw', 'ü™® Rock Slide', 'ü™® Stone Edge'],
            ghost: ['üëª Shadow Ball', 'üëª Lick', 'üëª Night Shade'],
            ice: ['‚ùÑÔ∏è Ice Beam', '‚ùÑÔ∏è Blizzard', '‚ùÑÔ∏è Powder Snow'],
            dragon: ['üêâ Dragon Rage', 'üêâ Outrage', 'üêâ Dragon Claw'],
            dark: ['üåë Bite', 'üåë Crunch', 'üåë Dark Pulse'],
            steel: ['‚öôÔ∏è Iron Tail', '‚öôÔ∏è Steel Wing', '‚öôÔ∏è Metal Claw'],
            fairy: ['‚ú® Moonblast', '‚ú® Dazzling Gleam', '‚ú® Fairy Wind']
        };
        
        // Badge and stats system
        let gameStats = JSON.parse(localStorage.getItem('gameStats')) || {
            totalProblems: 0,
            correctAnswers: 0,
            currentStreak: 0,
            bestStreak: 0,
            operationCounts: { addition: 0, subtraction: 0, multiplication: 0, division: 0 },
            unlockedBadges: []
        };

        // Sound Effects using Web Audio API and generated tones
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();

        // Sound effect: Success chime
        function playSuccessSound() {
            if (isMuted) return;
            
            const notes = [523.25, 659.25, 783.99]; // C-E-G chord
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                
                const startTime = audioContext.currentTime + (index * 0.1);
                gainNode.gain.setValueAtTime(0.3, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 0.5);
            });
        }

        // Sound effect: Failure sound
        function playFailureSound() {
            if (isMuted) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Sound effect: Bush rustling
        function playBushSound() {
            if (isMuted) return;
            
            // Create white noise for rustling effect
            const bufferSize = audioContext.sampleRate * 0.3;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            
            const noise = audioContext.createBufferSource();
            noise.buffer = buffer;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 1000;
            
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            noise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            noise.start(audioContext.currentTime);
            noise.stop(audioContext.currentTime + 0.3);
        }

        // Sound effect: Legendary fanfare
        function playLegendaryFanfare() {
            if (isMuted) return;
            
            const fanfare = [
                {freq: 523.25, duration: 0.2}, // C
                {freq: 659.25, duration: 0.2}, // E
                {freq: 783.99, duration: 0.2}, // G
                {freq: 1046.50, duration: 0.4}, // C (high)
                {freq: 783.99, duration: 0.2}, // G
                {freq: 1046.50, duration: 0.6}, // C (high)
            ];
            
            let currentTime = audioContext.currentTime;
            
            fanfare.forEach((note) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = note.freq;
                oscillator.type = 'triangle';
                
                gainNode.gain.setValueAtTime(0.4, currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + note.duration);
                
                oscillator.start(currentTime);
                oscillator.stop(currentTime + note.duration);
                
                currentTime += note.duration;
            });
        }

        // Sound effect: Type-specific sounds
        function playTypeSound(types) {
            if (isMuted || !types || types.length === 0) return;
            
            const primaryType = types[0].type.name;
            
            switch(primaryType) {
                case 'electric':
                    // Electric zap - rapid frequency changes
                    for (let i = 0; i < 5; i++) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        const startTime = audioContext.currentTime + (i * 0.05);
                        oscillator.frequency.setValueAtTime(800 + Math.random() * 400, startTime);
                        oscillator.type = 'square';
                        
                        gainNode.gain.setValueAtTime(0.2, startTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.05);
                        
                        oscillator.start(startTime);
                        oscillator.stop(startTime + 0.05);
                    }
                    break;
                    
                case 'fire':
                    // Fire whoosh - rising tone
                    const fireOsc = audioContext.createOscillator();
                    const fireGain = audioContext.createGain();
                    
                    fireOsc.connect(fireGain);
                    fireGain.connect(audioContext.destination);
                    
                    fireOsc.frequency.setValueAtTime(200, audioContext.currentTime);
                    fireOsc.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.4);
                    fireOsc.type = 'sawtooth';
                    
                    fireGain.gain.setValueAtTime(0.3, audioContext.currentTime);
                    fireGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    
                    fireOsc.start(audioContext.currentTime);
                    fireOsc.stop(audioContext.currentTime + 0.4);
                    break;
                    
                case 'water':
                    // Water splash - low bubbling
                    for (let i = 0; i < 3; i++) {
                        const waterOsc = audioContext.createOscillator();
                        const waterGain = audioContext.createGain();
                        
                        waterOsc.connect(waterGain);
                        waterGain.connect(audioContext.destination);
                        
                        const startTime = audioContext.currentTime + (i * 0.1);
                        waterOsc.frequency.value = 150 + Math.random() * 100;
                        waterOsc.type = 'sine';
                        
                        waterGain.gain.setValueAtTime(0.2, startTime);
                        waterGain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);
                        
                        waterOsc.start(startTime);
                        waterOsc.stop(startTime + 0.2);
                    }
                    break;
                    
                case 'grass':
                    // Grass rustle - soft noise
                    const bufferSize = audioContext.sampleRate * 0.3;
                    const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const output = buffer.getChannelData(0);
                    
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = (Math.random() * 2 - 1) * 0.5;
                    }
                    
                    const grassNoise = audioContext.createBufferSource();
                    grassNoise.buffer = buffer;
                    
                    const grassFilter = audioContext.createBiquadFilter();
                    grassFilter.type = 'lowpass';
                    grassFilter.frequency.value = 2000;
                    
                    const grassGain = audioContext.createGain();
                    grassGain.gain.setValueAtTime(0.15, audioContext.currentTime);
                    grassGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    grassNoise.connect(grassFilter);
                    grassFilter.connect(grassGain);
                    grassGain.connect(audioContext.destination);
                    
                    grassNoise.start(audioContext.currentTime);
                    grassNoise.stop(audioContext.currentTime + 0.3);
                    break;
                    
                default:
                    // Default sound for other types
                    playSuccessSound();
            }
        }

        // Routing system
        function navigateTo(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Show/hide nav bar
            if (page === 'menu') {
                document.getElementById('navBar').classList.add('hidden');
                document.getElementById('menuPage').classList.add('active');
                // Play menu music (Opening theme)
                if (!isMuted) {
                    playBackgroundMusic('menu');
                }
            } else {
                document.getElementById('navBar').classList.remove('hidden');
                
                // Update active nav button
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                
                if (page === 'hunt') {
                    document.getElementById('huntPage').classList.add('active');
                    document.querySelectorAll('.nav-btn')[1].classList.add('active');
                    resetBushes(); // Reset bushes when returning to hunt page
                    // Play hunt music (Pallet Town)
                    if (!isMuted) {
                        playBackgroundMusic('hunt');
                    }
                } else if (page === 'battle') {
                    document.getElementById('battlePage').classList.add('active');
                    document.querySelectorAll('.nav-btn')[2].classList.add('active');
                    initializeBattleMode(); // Initialize battle mode
                    // Play battle music (Opening theme)
                    if (!isMuted) {
                        playBackgroundMusic('battle');
                    }
                } else if (page === 'pokedex') {
                    document.getElementById('pokedexPage').classList.add('active');
                    document.querySelectorAll('.nav-btn')[3].classList.add('active');
                    initializeGrid(); // Refresh the grid when viewing
                    // Play pokedex music (Opening theme)
                    if (!isMuted) {
                        playBackgroundMusic('pokedex');
                    }
                }
            }
        }

        // Reset bushes for new round
        function resetBushes() {
            checkedBushes = [];
            document.querySelectorAll('.bush').forEach(bush => {
                bush.classList.remove('checked');
            });
            document.getElementById('bushHeader').textContent = 'üåø Choose a bush to search! üåø';
        }

        // Bush selection - ALWAYS show math problem
        function selectBush(bushIndex) {
            // Don't allow selecting already checked bushes
            if (checkedBushes.includes(bushIndex)) {
                return;
            }

            // Play bush rustling sound
            playBushSound();

            selectedBush = bushIndex;
            
            // Only 1 in 3 bushes has a Pok√©mon (33% chance)
            pokemonInBush = Math.random() < 0.33;
            
            if (pokemonInBush) {
                // Pok√©mon found! Pick random uncaught one
                const uncaught = [];
                for (let i = 1; i <= 150; i++) {
                    if (!caughtPokemon[i]) uncaught.push(i);
                }
                if (uncaught.length > 0) {
                    const randomIndex = Math.floor(Math.random() * uncaught.length);
                    const pokemonNumber = uncaught[randomIndex];
                    openModalWithPokemon(pokemonNumber, pokemon[pokemonNumber - 1]);
                } else {
                    // All caught!
                    alert('You\'ve caught all 150 Pok√©mon! üéâ');
                    navigateTo('pokedex');
                }
            } else {
                // Empty bush - but still show math problem!
                openModalWithoutPokemon();
            }
        }

        // Open modal with a Pok√©mon
        function openModalWithPokemon(number, name) {
            currentPokemon = { number, name };
            const mathData = generateMathProblem();
            currentAnswer = mathData.answer;

            // Play Pok√©mon cry sound
            playPokemonCry(number);

            document.getElementById('modalSprite').src = getPokemonSpriteUrl(number, false);
            document.getElementById('modalSprite').alt = name;
            document.getElementById('mathProblem').textContent = `Solve this to catch me: ${mathData.problem} = ?`;
            document.getElementById('submitBtn').textContent = 'Catch Pok√©mon!';
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('celebration').style.display = 'none';
            document.getElementById('mathModal').classList.add('active');
            document.getElementById('answerInput').focus();
        }

        // Open modal without a Pok√©mon (empty bush)
        function openModalWithoutPokemon() {
            currentPokemon = null; // No Pok√©mon in this bush
            const mathData = generateMathProblem();
            currentAnswer = mathData.answer;

            // Show question mark or empty bush sprite
            document.getElementById('modalSprite').src = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';
            document.getElementById('modalSprite').alt = 'Empty';
            document.getElementById('mathProblem').textContent = `Nothing here... but solve this anyway: ${mathData.problem} = ?`;
            document.getElementById('submitBtn').textContent = 'Continue Searching';
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('celebration').style.display = 'none';
            document.getElementById('mathModal').classList.add('active');
            document.getElementById('answerInput').focus();
        }

        // Badge definitions
        const badges = [
            {
                id: 'math_trainer',
                name: 'Math Trainer',
                description: 'Catch 10 Pok√©mon',
                icon: 'üéñÔ∏è',
                requirement: () => Object.keys(caughtPokemon).length >= 10
            },
            {
                id: 'gym_leader',
                name: 'Gym Leader',
                description: 'Catch 50 Pok√©mon',
                icon: '‚≠ê',
                requirement: () => Object.keys(caughtPokemon).length >= 50
            },
            {
                id: 'champion',
                name: 'Champion',
                description: 'Catch all 150 Pok√©mon',
                icon: 'üëë',
                requirement: () => Object.keys(caughtPokemon).length >= 150
            },
            {
                id: 'speed_demon',
                name: 'Speed Demon',
                description: 'Answer 5 in a row correctly',
                icon: '‚ö°',
                requirement: () => gameStats.currentStreak >= 5
            },
            {
                id: 'no_mistakes',
                name: 'No Mistakes',
                description: 'Catch 5 without any running away',
                icon: 'üíØ',
                requirement: () => gameStats.currentStreak >= 5
            },
            {
                id: 'operation_master_add',
                name: 'Addition Master',
                description: 'Complete 20 addition problems',
                icon: '‚ûï',
                requirement: () => gameStats.operationCounts.addition >= 20
            },
            {
                id: 'operation_master_sub',
                name: 'Subtraction Master',
                description: 'Complete 20 subtraction problems',
                icon: '‚ûñ',
                requirement: () => gameStats.operationCounts.subtraction >= 20
            },
            {
                id: 'operation_master_mult',
                name: 'Multiplication Master',
                description: 'Complete 20 multiplication problems',
                icon: '‚úñÔ∏è',
                requirement: () => gameStats.operationCounts.multiplication >= 20
            },
            {
                id: 'operation_master_div',
                name: 'Division Master',
                description: 'Complete 20 division problems',
                icon: '‚ûó',
                requirement: () => gameStats.operationCounts.division >= 20
            },
            {
                id: 'perfect_ten',
                name: 'Perfect Ten',
                description: 'Get 10 problems correct in a row',
                icon: 'üî•',
                requirement: () => gameStats.bestStreak >= 10
            },
            {
                id: 'scholar',
                name: 'Scholar',
                description: 'Solve 100 total problems',
                icon: 'üìö',
                requirement: () => gameStats.totalProblems >= 100
            },
            {
                id: 'ace_student',
                name: 'Ace Student',
                description: 'Maintain 90% accuracy over 20+ problems',
                icon: 'üåü',
                requirement: () => gameStats.totalProblems >= 20 && (gameStats.correctAnswers / gameStats.totalProblems) >= 0.9
            }
        ];

        // Set grade level
        function setGradeLevel(grade) {
            gradeLevel = parseInt(grade);
            localStorage.setItem('gradeLevel', gradeLevel);
        }

        // Save game stats
        function saveGameStats() {
            localStorage.setItem('gameStats', JSON.stringify(gameStats));
        }

        // Check and unlock badges
        function checkBadges() {
            const newlyUnlocked = [];
            
            badges.forEach(badge => {
                if (!gameStats.unlockedBadges.includes(badge.id) && badge.requirement()) {
                    gameStats.unlockedBadges.push(badge.id);
                    newlyUnlocked.push(badge);
                }
            });

            if (newlyUnlocked.length > 0) {
                saveGameStats();
                updateBadgeCount();
                // Show popup for first new badge
                showNewBadgePopup(newlyUnlocked[0]);
            }
        }

        // Show new badge popup
        function showNewBadgePopup(badge) {
            document.getElementById('newBadgeIcon').textContent = badge.icon;
            document.getElementById('newBadgeName').textContent = badge.name;
            const popup = document.getElementById('newBadgePopup');
            popup.style.display = 'block';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        // Update badge count display
        function updateBadgeCount() {
            const count = gameStats.unlockedBadges.length;
            document.getElementById('badge-count').textContent = count;
            document.getElementById('badge-count-menu').textContent = count;
        }

        // Update streak display
        function updateStreakDisplay() {
            document.getElementById('streak-count').textContent = gameStats.currentStreak;
        }

        // Track operation type from current problem
        let lastOperationType = null;

        // Set operation mode
        function setOperation(mode) {
            operationMode = mode;
            localStorage.setItem('operationMode', mode);
            
            // Update button states
            document.querySelectorAll('.operation-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-operation="${mode}"]`).classList.add('active');
        }

        // Toggle mute on/off
        function toggleMute() {
            isMuted = !isMuted;
            localStorage.setItem('isMuted', JSON.stringify(isMuted));
            updateMuteButton();
            
            // Handle background music
            if (isMuted) {
                stopBackgroundMusic();
            } else {
                // Resume audio context if needed
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }
        }

        // Update mute button appearance
        function updateMuteButton() {
            const button = document.getElementById('muteButton');
            if (isMuted) {
                button.textContent = 'üîá';
                button.classList.add('muted');
                button.title = 'Sound Off - Click to Unmute';
            } else {
                button.textContent = 'üîä';
                button.classList.remove('muted');
                button.title = 'Sound On - Click to Mute';
            }
        }

        // Generate grade-appropriate math problem
        function generateMathProblem() {
            // Define difficulty parameters by grade level
            const gradeDifficulty = {
                1: { // Age 6 - Very basic addition/subtraction
                    addition: { min: 1, max: 10 },
                    subtraction: { min: 1, max: 10 },
                    multiplication: null, // Not appropriate yet
                    division: null
                },
                2: { // Age 7 - Simple addition/subtraction
                    addition: { min: 1, max: 20 },
                    subtraction: { min: 1, max: 20 },
                    multiplication: { min: 1, max: 5, maxProduct: 25 },
                    division: null
                },
                3: { // Age 8 - Larger numbers, intro multiplication
                    addition: { min: 5, max: 50 },
                    subtraction: { min: 5, max: 50 },
                    multiplication: { min: 2, max: 10, maxProduct: 50 },
                    division: { divisor: [2, 3, 4, 5], quotient: [2, 10] }
                },
                4: { // Age 9 - Standard multiplication tables
                    addition: { min: 10, max: 100 },
                    subtraction: { min: 10, max: 100 },
                    multiplication: { min: 2, max: 12, maxProduct: 144 },
                    division: { divisor: [2, 12], quotient: [2, 12] }
                },
                5: { // Age 10 - Larger multiplication, division
                    addition: { min: 20, max: 200 },
                    subtraction: { min: 20, max: 200 },
                    multiplication: { min: 5, max: 15, maxProduct: 225 },
                    division: { divisor: [2, 15], quotient: [2, 15] }
                },
                6: { // Age 11 - Multi-digit operations
                    addition: { min: 50, max: 500 },
                    subtraction: { min: 50, max: 500 },
                    multiplication: { min: 10, max: 25, maxProduct: 625 },
                    division: { divisor: [5, 20], quotient: [5, 20] }
                },
                7: { // Age 12 - Larger numbers
                    addition: { min: 100, max: 1000 },
                    subtraction: { min: 100, max: 1000 },
                    multiplication: { min: 15, max: 35, maxProduct: 1225 },
                    division: { divisor: [10, 25], quotient: [10, 25] }
                },
                8: { // Age 13 - More complex
                    addition: { min: 200, max: 2000 },
                    subtraction: { min: 200, max: 2000 },
                    multiplication: { min: 20, max: 50, maxProduct: 2500 },
                    division: { divisor: [15, 35], quotient: [15, 35] }
                },
                9: { // Age 14 - Advanced
                    addition: { min: 500, max: 5000 },
                    subtraction: { min: 500, max: 5000 },
                    multiplication: { min: 25, max: 75, maxProduct: 5625 },
                    division: { divisor: [20, 50], quotient: [20, 50] }
                },
                10: { // Age 15-16 - Most challenging
                    addition: { min: 1000, max: 10000 },
                    subtraction: { min: 1000, max: 10000 },
                    multiplication: { min: 50, max: 100, maxProduct: 10000 },
                    division: { divisor: [25, 75], quotient: [25, 75] }
                }
            };

            const difficulty = gradeDifficulty[gradeLevel];

            const operations = {
                addition: () => {
                    if (!difficulty.addition) return null;
                    const a = Math.floor(Math.random() * (difficulty.addition.max - difficulty.addition.min + 1)) + difficulty.addition.min;
                    const b = Math.floor(Math.random() * (difficulty.addition.max - difficulty.addition.min + 1)) + difficulty.addition.min;
                    lastOperationType = 'addition';
                    return { problem: `${a} + ${b}`, answer: a + b };
                },
                subtraction: () => {
                    if (!difficulty.subtraction) return null;
                    const a = Math.floor(Math.random() * (difficulty.subtraction.max - difficulty.subtraction.min + 1)) + difficulty.subtraction.min;
                    const b = Math.floor(Math.random() * a) + 1; // Ensure b < a for positive result
                    lastOperationType = 'subtraction';
                    return { problem: `${a} - ${b}`, answer: a - b };
                },
                multiplication: () => {
                    if (!difficulty.multiplication) return null;
                    const a = Math.floor(Math.random() * (difficulty.multiplication.max - difficulty.multiplication.min + 1)) + difficulty.multiplication.min;
                    const b = Math.floor(Math.random() * (difficulty.multiplication.max - difficulty.multiplication.min + 1)) + difficulty.multiplication.min;
                    lastOperationType = 'multiplication';
                    return { problem: `${a} √ó ${b}`, answer: a * b };
                },
                division: () => {
                    if (!difficulty.division) return null;
                    const divisor = Math.floor(Math.random() * (difficulty.division.divisor[1] - difficulty.division.divisor[0] + 1)) + difficulty.division.divisor[0];
                    const quotient = Math.floor(Math.random() * (difficulty.division.quotient[1] - difficulty.division.quotient[0] + 1)) + difficulty.division.quotient[0];
                    const dividend = divisor * quotient;
                    lastOperationType = 'division';
                    return { problem: `${dividend} √∑ ${divisor}`, answer: quotient };
                }
            };

            // If random mode, pick a random operation that's available for this grade AND allowed in settings
            if (operationMode === 'random') {
                const availableOps = [];
                if (difficulty.addition && allowedOperations.includes('addition')) availableOps.push('addition');
                if (difficulty.subtraction && allowedOperations.includes('subtraction')) availableOps.push('subtraction');
                if (difficulty.multiplication && allowedOperations.includes('multiplication')) availableOps.push('multiplication');
                if (difficulty.division && allowedOperations.includes('division')) availableOps.push('division');
                
                if (availableOps.length === 0) {
                    // Fallback to addition if nothing available
                    return operations.addition();
                }
                
                const randomType = availableOps[Math.floor(Math.random() * availableOps.length)];
                return operations[randomType]();
            }

            // Otherwise use the selected operation (if available for this grade AND allowed)
            if (!allowedOperations.includes(operationMode)) {
                // If selected operation not allowed, pick from allowed ones
                const availableOps = [];
                if (difficulty.addition && allowedOperations.includes('addition')) availableOps.push('addition');
                if (difficulty.subtraction && allowedOperations.includes('subtraction')) availableOps.push('subtraction');
                if (difficulty.multiplication && allowedOperations.includes('multiplication')) availableOps.push('multiplication');
                if (difficulty.division && allowedOperations.includes('division')) availableOps.push('division');
                
                if (availableOps.length > 0) {
                    const randomType = availableOps[Math.floor(Math.random() * availableOps.length)];
                    return operations[randomType]();
                }
                return operations.addition();
            }
            
            const result = operations[operationMode]();
            
            // If operation not available for this grade, fall back to an allowed operation
            if (!result) {
                const availableOps = [];
                if (difficulty.addition && allowedOperations.includes('addition')) availableOps.push('addition');
                if (difficulty.subtraction && allowedOperations.includes('subtraction')) availableOps.push('subtraction');
                if (difficulty.multiplication && allowedOperations.includes('multiplication')) availableOps.push('multiplication');
                if (difficulty.division && allowedOperations.includes('division')) availableOps.push('division');
                
                if (availableOps.length > 0) {
                    const randomType = availableOps[Math.floor(Math.random() * availableOps.length)];
                    return operations[randomType]();
                }
                return operations.addition();
            }
            
            return result;
        }

        // Screen navigation
        function startGame() {
            // Resume audio context on user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // Start Pallet Town music for hunt screen
            if (!isMuted) {
                playBackgroundMusic('hunt');
            }
            
            navigateTo('hunt');
        }

        // Start battle mode from menu
        function startBattleFromMenu() {
            // Resume audio context on user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // Start battle music
            if (!isMuted) {
                playBackgroundMusic('battle');
            }
            
            navigateTo('battle');
        }

        function openSettings() {
            document.getElementById('settingsGrade').value = gradeLevel;
            document.getElementById('opAddition').checked = allowedOperations.includes('addition');
            document.getElementById('opSubtraction').checked = allowedOperations.includes('subtraction');
            document.getElementById('opMultiplication').checked = allowedOperations.includes('multiplication');
            document.getElementById('opDivision').checked = allowedOperations.includes('division');
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            gradeLevel = parseInt(document.getElementById('settingsGrade').value);
            localStorage.setItem('gradeLevel', gradeLevel);
            
            allowedOperations = [];
            if (document.getElementById('opAddition').checked) allowedOperations.push('addition');
            if (document.getElementById('opSubtraction').checked) allowedOperations.push('subtraction');
            if (document.getElementById('opMultiplication').checked) allowedOperations.push('multiplication');
            if (document.getElementById('opDivision').checked) allowedOperations.push('division');
            
            if (allowedOperations.length === 0) {
                alert('Please select at least one operation!');
                return;
            }
            
            localStorage.setItem('allowedOperations', JSON.stringify(allowedOperations));
            document.getElementById('settingsModal').classList.remove('active');
            
            // Update game screen dropdowns
            document.getElementById('gradeLevel').value = gradeLevel;
        }

        // Close modal
        function closeModal() {
            document.getElementById('mathModal').classList.remove('active');
        }

        // Show Pokemon info modal
        async function showPokemonInfo(number, name) {
            document.getElementById('pokemonInfoModal').classList.add('active');
            document.getElementById('pokemonInfoLoading').style.display = 'block';
            document.getElementById('pokemonInfoDisplay').style.display = 'none';

            try {
                // Fetch Pokemon data from PokeAPI
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${number}`);
                const data = await response.json();

                // Fetch species data for additional info
                const speciesResponse = await fetch(data.species.url);
                const speciesData = await speciesResponse.json();

                // Play type-specific sound
                playTypeSound(data.types);

                // Update modal with Pokemon data
                document.getElementById('infoSprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${number}.gif`;
                document.getElementById('infoName').textContent = name;
                document.getElementById('infoNumber').textContent = `#${String(number).padStart(3, '0')}`;

                // Types
                const typesContainer = document.getElementById('infoTypes');
                typesContainer.innerHTML = '';
                data.types.forEach(typeInfo => {
                    const typeEl = document.createElement('span');
                    typeEl.className = `pokemon-type type-${typeInfo.type.name}`;
                    typeEl.textContent = typeInfo.type.name;
                    typesContainer.appendChild(typeEl);
                });

                // Height and Weight (convert from decimeters and hectograms)
                const heightM = (data.height / 10).toFixed(1);
                const weightKg = (data.weight / 10).toFixed(1);
                document.getElementById('infoHeight').textContent = `${heightM} m`;
                document.getElementById('infoWeight').textContent = `${weightKg} kg`;

                // Habitat
                const habitat = speciesData.habitat ? speciesData.habitat.name : 'Unknown';
                document.getElementById('infoHabitat').textContent = habitat.charAt(0).toUpperCase() + habitat.slice(1);

                // Flavor text (story) - get English entry
                const flavorTexts = speciesData.flavor_text_entries.filter(entry => entry.language.name === 'en');
                let story = 'No description available.';
                if (flavorTexts.length > 0) {
                    // Get a random flavor text for variety
                    const randomIndex = Math.floor(Math.random() * Math.min(3, flavorTexts.length));
                    story = flavorTexts[randomIndex].flavor_text.replace(/\f/g, ' ').replace(/\n/g, ' ');
                }
                document.getElementById('infoStory').textContent = story;

                // Show the data
                document.getElementById('pokemonInfoLoading').style.display = 'none';
                document.getElementById('pokemonInfoDisplay').style.display = 'block';

            } catch (error) {
                console.error('Error fetching Pokemon data:', error);
                document.getElementById('pokemonInfoLoading').innerHTML = '‚ùå Error loading Pok√©mon data. Please try again.';
            }
        }

        // Close Pokemon info modal
        function closePokemonInfo() {
            document.getElementById('pokemonInfoModal').classList.remove('active');
        }

        // ========== BATTLE MODE FUNCTIONS ==========

        // Initialize battle mode
        function initializeBattleMode() {
            const caughtCount = Object.keys(caughtPokemon).length;
            
            if (caughtCount < 3) {
                alert(`You need at least 3 caught Pok√©mon to battle! You have ${caughtCount}. Keep catching!`);
                navigateTo('hunt');
                return;
            }
            
            selectedTeam = [];
            showTeamSelection();
        }

        // Show team selection screen
        function showTeamSelection() {
            document.getElementById('teamSelectionScreen').style.display = 'block';
            document.getElementById('battleArenaScreen').style.display = 'none';
            
            const container = document.getElementById('availablePokemon');
            container.innerHTML = '';
            
            pokemon.forEach((name, index) => {
                const number = index + 1;
                if (caughtPokemon[number]) {
                    const card = document.createElement('div');
                    card.className = 'selectable-pokemon';
                    card.id = `select-${number}`;
                    card.onclick = () => toggleTeamSelection(number, name);
                    
                    const sprite = document.createElement('img');
                    sprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${number}.gif`;
                    sprite.style.width = '60px';
                    sprite.style.height = '60px';
                    
                    const nameEl = document.createElement('div');
                    nameEl.style.fontSize = '0.8em';
                    nameEl.style.marginTop = '5px';
                    nameEl.textContent = name;
                    
                    card.appendChild(sprite);
                    card.appendChild(nameEl);
                    container.appendChild(card);
                }
            });
            
            updateSelectedTeamDisplay();
        }

        // Toggle Pokemon team selection
        function toggleTeamSelection(number, name) {
            const index = selectedTeam.findIndex(p => p.number === number);
            
            if (index > -1) {
                // Deselect
                selectedTeam.splice(index, 1);
                document.getElementById(`select-${number}`).classList.remove('selected');
            } else if (selectedTeam.length < 3) {
                // Select
                selectedTeam.push({ number, name });
                document.getElementById(`select-${number}`).classList.add('selected');
            }
            
            updateSelectedTeamDisplay();
        }

        // Update selected team display
        function updateSelectedTeamDisplay() {
            const container = document.getElementById('selectedTeamDisplay');
            container.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const slot = document.createElement('div');
                slot.className = 'team-slot';
                
                if (selectedTeam[i]) {
                    slot.classList.add('filled');
                    const sprite = document.createElement('img');
                    sprite.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${selectedTeam[i].number}.gif`;
                    const name = document.createElement('div');
                    name.className = 'slot-name';
                    name.textContent = selectedTeam[i].name;
                    slot.appendChild(sprite);
                    slot.appendChild(name);
                } else {
                    slot.textContent = '?';
                }
                
                container.appendChild(slot);
            }
            
            const startBtn = document.getElementById('startBattleBtn');
            if (selectedTeam.length === 3) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }

        // Start battle
        async function startBattleMode() {
            if (selectedTeam.length !== 3) return;
            
            try {
                // Show loading
                document.getElementById('battleMessage').textContent = 'Preparing battle...';
                
                console.log('Starting battle with team:', selectedTeam);
                
                // Fetch Pokemon data for selected team
                for (let p of selectedTeam) {
                    const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${p.number}`);
                    const data = await response.json();
                    p.types = data.types;
                    p.hp = 100;
                    p.maxHp = 100;
                    p.fainted = false;
                }
                
                console.log('Player team loaded');
                
                // Generate opponent team - AI gets access to ALL 150 Pokemon!
                const opponentTeam = [];
                const allPokemon = Array.from({length: 150}, (_, i) => i + 1); // 1-150
                
                // Shuffle and pick 3 random Pokemon for opponent
                const shuffled = allPokemon.sort(() => Math.random() - 0.5);
                const opponentPicks = shuffled.slice(0, 3);
                
                console.log('Opponent will use Pokemon:', opponentPicks);
                
                for (let pokemonNumber of opponentPicks) {
                    const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonNumber}`);
                    const data = await response.json();
                    
                    opponentTeam.push({
                        number: pokemonNumber,
                        name: pokemon[pokemonNumber - 1],
                        types: data.types,
                        hp: 100,
                        maxHp: 100,
                        fainted: false
                    });
                }
                
                console.log('Opponent team loaded:', opponentTeam);
                
                currentBattle = {
                    playerTeam: selectedTeam,
                    opponentTeam: opponentTeam,
                    playerIndex: 0,
                    opponentIndex: 0,
                    turn: 'player',
                    log: []
                };
                
                document.getElementById('teamSelectionScreen').style.display = 'none';
                document.getElementById('battleArenaScreen').style.display = 'block';
                
                console.log('Loading battle Pokemon...');
                loadBattlePokemon();
                addBattleLog('Battle Start!', '');
                startPlayerTurn();
                
            } catch (error) {
                console.error('Error starting battle:', error);
                alert('Error starting battle: ' + error.message + '\nPlease try again.');
                document.getElementById('battleMessage').textContent = 'Error starting battle. Please try again.';
            }
        }

        // Load Pokemon into battle arena
        function loadBattlePokemon() {
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            const opponentPokemon = currentBattle.opponentTeam[currentBattle.opponentIndex];
            
            // Player Pokemon
            document.getElementById('playerSprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${playerPokemon.number}.gif`;
            document.getElementById('playerPokemonName').textContent = playerPokemon.name;
            updateBattleHealth('player', playerPokemon.hp, playerPokemon.maxHp);
            
            // Opponent Pokemon
            document.getElementById('opponentSprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${opponentPokemon.number}.gif`;
            document.getElementById('opponentPokemonName').textContent = opponentPokemon.name;
            updateBattleHealth('opponent', opponentPokemon.hp, opponentPokemon.maxHp);
            
            // Update team display
            updateTeamDisplay();
            
            // Show player's Pokemon initially (it's their turn)
            showActivePokemon('player');
        }

        // Show the active Pokemon based on whose turn it is
        function showActivePokemon(side) {
            const playerDiv = document.querySelector('.battle-pokemon.player-pokemon');
            const opponentDiv = document.querySelector('.battle-pokemon.opponent-pokemon');
            
            playerDiv.classList.remove('active-turn');
            opponentDiv.classList.remove('active-turn');
            
            if (side === 'player') {
                playerDiv.classList.add('active-turn');
            } else {
                opponentDiv.classList.add('active-turn');
            }
        }

        // Update health bar
        function updateBattleHealth(side, hp, maxHp) {
            const healthBar = document.getElementById(`${side}HealthFill`);
            const healthText = document.getElementById(`${side}HealthText`);
            
            const percentage = Math.max(0, (hp / maxHp) * 100);
            healthBar.style.width = percentage + '%';
            healthText.textContent = `HP: ${Math.max(0, Math.floor(hp))}/${maxHp}`;
            
            healthBar.classList.remove('low', 'critical');
            if (percentage <= 20) {
                healthBar.classList.add('critical');
            } else if (percentage <= 50) {
                healthBar.classList.add('low');
            }
        }

        // Update team display
        function updateTeamDisplay() {
            const playerTeamEl = document.getElementById('playerTeamList');
            const opponentTeamEl = document.getElementById('opponentTeamList');
            
            playerTeamEl.innerHTML = currentBattle.playerTeam.map((p, i) => `
                <div class="team-pokemon-item ${i === currentBattle.playerIndex ? 'active' : ''} ${p.fainted ? 'fainted' : ''}">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.number}.gif">
                    <div style="font-size: 0.7em;">${p.name}</div>
                </div>
            `).join('');
            
            opponentTeamEl.innerHTML = currentBattle.opponentTeam.map((p, i) => `
                <div class="team-pokemon-item ${i === currentBattle.opponentIndex ? 'active' : ''} ${p.fainted ? 'fainted' : ''}">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${p.number}.gif">
                    <div style="font-size: 0.7em;">${p.name}</div>
                </div>
            `).join('');
        }

        // Start player turn
        function startPlayerTurn() {
            const mathData = generateMathProblem();
            currentBattle.currentQuestion = mathData.problem;
            currentBattle.currentAnswer = mathData.answer;
            currentBattle.turn = 'player';
            
            // Show player's Pokemon
            showActivePokemon('player');
            
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            const pokemonType = playerPokemon.types[0].type.name;
            const attacks = attacksByType[pokemonType] || attacksByType.normal;
            const attackName = attacks[Math.floor(Math.random() * attacks.length)];
            
            document.getElementById('attackNameDisplay').textContent = attackName;
            document.getElementById('attackTypeDisplay').textContent = pokemonType.toUpperCase();
            document.getElementById('attackTypeDisplay').className = `attack-type type-${pokemonType}`;
            
            document.getElementById('battleQuestionText').textContent = mathData.problem + ' = ?';
            document.getElementById('battleAnswerInput').value = '';
            document.getElementById('battleAnswerInput').focus();
            document.getElementById('battleMessage').textContent = `Solve the problem to use ${attackName}!`;
        }

        // Submit battle answer
        function submitBattleAnswer() {
            const userAnswer = parseInt(document.getElementById('battleAnswerInput').value);
            
            if (userAnswer === currentBattle.currentAnswer) {
                playSuccessSound();
                addBattleLog('Correct!', '');
                playerAttack();
            } else {
                playFailureSound();
                addBattleLog('Wrong answer!', 'damage');
                document.getElementById('battleMessage').textContent = 'Wrong answer! Opponent attacks!';
                setTimeout(() => opponentAttack(), 1500);
            }
        }

        // Player attacks
        function playerAttack() {
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            const opponentPokemon = currentBattle.opponentTeam[currentBattle.opponentIndex];
            
            const playerType = playerPokemon.types[0].type.name;
            const opponentType = opponentPokemon.types[0].type.name;
            
            let damage = 20;
            let effectiveness = 'normal';
            
            // Check type advantage
            if (typeChart[playerType]?.strong?.includes(opponentType)) {
                damage = 35;
                effectiveness = 'super';
            } else if (typeChart[playerType]?.weak?.includes(opponentType)) {
                damage = 10;
                effectiveness = 'weak';
            }
            
            const attacks = attacksByType[playerType] || attacksByType.normal;
            const attackName = attacks[Math.floor(Math.random() * attacks.length)];
            
            document.getElementById('playerSprite').classList.add('attacking');
            
            setTimeout(() => {
                document.getElementById('playerSprite').classList.remove('attacking');
                
                // Switch to show opponent getting hit
                showActivePokemon('opponent');
                document.getElementById('opponentSprite').classList.add('hit');
                
                opponentPokemon.hp -= damage;
                updateBattleHealth('opponent', opponentPokemon.hp, opponentPokemon.maxHp);
                
                let message = `${playerPokemon.name} used ${attackName}! ${damage} damage!`;
                if (effectiveness === 'super') {
                    message += ' Super effective!';
                    addBattleLog(message, 'super-effective');
                } else if (effectiveness === 'weak') {
                    message += ' Not very effective...';
                    addBattleLog(message, 'damage');
                } else {
                    addBattleLog(message, 'damage');
                }
                
                document.getElementById('battleMessage').textContent = message;
                
                setTimeout(() => {
                    document.getElementById('opponentSprite').classList.remove('hit');
                    
                    if (opponentPokemon.hp <= 0) {
                        opponentPokemonFainted();
                    } else {
                        setTimeout(() => opponentAttack(), 1500);
                    }
                }, 500);
            }, 600);
        }

        // Opponent attacks
        function opponentAttack() {
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            const opponentPokemon = currentBattle.opponentTeam[currentBattle.opponentIndex];
            
            const opponentType = opponentPokemon.types[0].type.name;
            const playerType = playerPokemon.types[0].type.name;
            
            let damage = 15;
            
            if (typeChart[opponentType]?.strong?.includes(playerType)) {
                damage = 25;
            } else if (typeChart[opponentType]?.weak?.includes(playerType)) {
                damage = 8;
            }
            
            const attacks = attacksByType[opponentType] || attacksByType.normal;
            const attackName = attacks[Math.floor(Math.random() * attacks.length)];
            
            document.getElementById('opponentSprite').classList.add('attacking');
            
            setTimeout(() => {
                document.getElementById('opponentSprite').classList.remove('attacking');
                
                // Switch to show player getting hit
                showActivePokemon('player');
                document.getElementById('playerSprite').classList.add('hit');
                
                playerPokemon.hp -= damage;
                updateBattleHealth('player', playerPokemon.hp, playerPokemon.maxHp);
                
                const message = `${opponentPokemon.name} used ${attackName}! ${damage} damage!`;
                addBattleLog(message, 'damage');
                document.getElementById('battleMessage').textContent = message;
                
                setTimeout(() => {
                    document.getElementById('playerSprite').classList.remove('hit');
                    
                    if (playerPokemon.hp <= 0) {
                        playerPokemonFainted();
                    } else {
                        setTimeout(() => startPlayerTurn(), 1000);
                    }
                }, 500);
            }, 600);
        }

        // Player Pokemon fainted
        function playerPokemonFainted() {
            const playerPokemon = currentBattle.playerTeam[currentBattle.playerIndex];
            playerPokemon.fainted = true;
            
            document.getElementById('playerSprite').classList.add('fainted');
            addBattleLog(`${playerPokemon.name} fainted!`, 'damage');
            document.getElementById('battleMessage').textContent = `${playerPokemon.name} fainted!`;
            
            setTimeout(() => {
                // Check for next Pokemon
                currentBattle.playerIndex++;
                
                if (currentBattle.playerIndex >= currentBattle.playerTeam.length) {
                    endBattle(false);
                } else {
                    document.getElementById('playerSprite').classList.remove('fainted');
                    loadBattlePokemon();
                    addBattleLog(`Go! ${currentBattle.playerTeam[currentBattle.playerIndex].name}!`, '');
                    setTimeout(() => startPlayerTurn(), 1500);
                }
            }, 2000);
        }

        // Opponent Pokemon fainted
        function opponentPokemonFainted() {
            const opponentPokemon = currentBattle.opponentTeam[currentBattle.opponentIndex];
            opponentPokemon.fainted = true;
            
            document.getElementById('opponentSprite').classList.add('fainted');
            addBattleLog(`Enemy ${opponentPokemon.name} fainted!`, 'heal');
            document.getElementById('battleMessage').textContent = `Enemy ${opponentPokemon.name} fainted!`;
            playSuccessSound();
            
            setTimeout(() => {
                currentBattle.opponentIndex++;
                
                if (currentBattle.opponentIndex >= currentBattle.opponentTeam.length) {
                    endBattle(true);
                } else {
                    document.getElementById('opponentSprite').classList.remove('fainted');
                    loadBattlePokemon();
                    addBattleLog(`Opponent sent out ${currentBattle.opponentTeam[currentBattle.opponentIndex].name}!`, '');
                    setTimeout(() => startPlayerTurn(), 1500);
                }
            }, 2000);
        }

        // Add entry to battle log
        function addBattleLog(message, type) {
            const log = document.getElementById('battleLog');
            const entry = document.createElement('div');
            entry.className = `battle-log-entry ${type}`;
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // End battle
        function endBattle(playerWon) {
            const modal = document.getElementById('battleResultModal');
            const content = document.getElementById('battleResultContent');
            const title = document.getElementById('battleResultTitle');
            const message = document.getElementById('battleResultMessage');
            const reward = document.getElementById('battleRewardDisplay');
            
            modal.classList.add('active');
            
            if (playerWon) {
                content.className = 'battle-result-content victory';
                title.textContent = 'üèÜ VICTORY! üèÜ';
                message.textContent = 'You defeated the opponent trainer!';
                playLegendaryFanfare();
                
                // Award Battle Master badge
                const battleBadgeId = 'battle_master';
                if (!gameStats.unlockedBadges.includes(battleBadgeId)) {
                    gameStats.unlockedBadges.push(battleBadgeId);
                    saveGameStats();
                    updateBadgeCount();
                    
                    reward.style.display = 'block';
                    reward.innerHTML = `
                        <h3>üèÜ New Badge Unlocked!</h3>
                        <div style="font-size: 3em; margin: 10px 0;">‚öîÔ∏è</div>
                        <div style="font-size: 1.3em; font-weight: bold;">Battle Master</div>
                        <p>Won your first Pok√©mon battle!</p>
                    `;
                } else {
                    reward.style.display = 'none';
                }
            } else {
                content.className = 'battle-result-content defeat';
                title.textContent = 'üíî DEFEAT üíî';
                message.textContent = 'You were defeated... Train harder and try again!';
                playFailureSound();
                reward.style.display = 'none';
            }
        }

        // Close battle result
        function closeBattleResult() {
            document.getElementById('battleResultModal').classList.remove('active');
            initializeBattleMode();
        }

        // Get Pok√©mon sprite URL from PokeAPI
        function getPokemonSpriteUrl(number, isCaught) {
            if (isCaught) {
                // Return pokeball sprite
                return 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';
            }
            // Return animated pokemon sprite from PokeAPI (Generation V Black/White animated sprites)
            return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/versions/generation-v/black-white/animated/${number}.gif`;
        }

        // Get Pok√©mon cry/sound URL from PokeAPI
        function getPokemonCryUrl(number) {
            return `https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/${number}.ogg`;
        }

        // Play Pok√©mon cry sound
        function playPokemonCry(number) {
            // Don't play if muted
            if (isMuted) {
                return;
            }
            
            const audio = new Audio(getPokemonCryUrl(number));
            audio.volume = 0.5; // Set volume to 50% so it's not too loud
            audio.play().catch(err => {
                console.log('Could not play cry:', err);
                // Fallback: Try legacy cry format
                const legacyAudio = new Audio(`https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/legacy/${number}.ogg`);
                legacyAudio.volume = 0.5;
                legacyAudio.play().catch(e => console.log('Legacy cry also failed:', e));
            });
        }

        // Initialize grid
        function initializeGrid() {
            const grid = document.getElementById('pokemonGrid');
            grid.innerHTML = '';

            pokemon.forEach((name, index) => {
                const number = index + 1;
                const isCaught = caughtPokemon[number];
                
                const card = document.createElement('div');
                card.className = `pokemon-card ${isCaught ? 'caught' : 'uncaught'}`;
                card.onclick = () => {
                    // Can view caught Pokemon info
                    if (isCaught) {
                        showPokemonInfo(number, name);
                    }
                };

                // Add pointer cursor for caught Pokemon
                if (isCaught) {
                    card.style.cursor = 'pointer';
                }

                const sprite = document.createElement('img');
                sprite.className = 'pokemon-sprite';
                // Show pokeball for uncaught, Pokemon sprite for caught
                sprite.src = isCaught ? getPokemonSpriteUrl(number, false) : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png';
                sprite.alt = isCaught ? name : '???';

                const nameEl = document.createElement('div');
                nameEl.className = 'pokemon-name';
                nameEl.textContent = isCaught ? name : '???';

                const numberEl = document.createElement('div');
                numberEl.className = 'pokemon-number';
                numberEl.textContent = `#${String(number).padStart(3, '0')}`;

                card.appendChild(sprite);
                card.appendChild(nameEl);
                card.appendChild(numberEl);
                grid.appendChild(card);
            });

            updateStats();
        }

        // Close modal
        function closeModal() {
            document.getElementById('mathModal').classList.remove('active');
            currentPokemon = null;
        }

        // Check answer
        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('answerInput').value);
            const feedback = document.getElementById('feedback');
            const celebration = document.getElementById('celebration');
            const modalSprite = document.getElementById('modalSprite');

            gameStats.totalProblems++;
            
            if (userAnswer === currentAnswer) {
                feedback.textContent = '‚úì Correct!';
                feedback.className = 'feedback correct';

                // Play success sound
                playSuccessSound();

                // Trigger catch shake animation
                modalSprite.classList.add('catching');

                // Update stats
                gameStats.correctAnswers++;
                gameStats.currentStreak++;
                if (gameStats.currentStreak > gameStats.bestStreak) {
                    gameStats.bestStreak = gameStats.currentStreak;
                }
                
                // Track operation type
                if (lastOperationType) {
                    gameStats.operationCounts[lastOperationType]++;
                }

                if (currentPokemon) {
                    // There was a Pok√©mon in this bush!
                    
                    // Check if legendary and play special fanfare
                    if (legendaryPokemon.includes(currentPokemon.number)) {
                        setTimeout(() => {
                            playLegendaryFanfare();
                            playCatchFanfare(); // Also play catch fanfare
                        }, 800);
                        celebration.textContent = 'üåü LEGENDARY POK√âMON CAUGHT! üåü';
                    } else {
                        // Play catch fanfare for normal Pokemon
                        setTimeout(() => {
                            playCatchFanfare();
                        }, 800);
                        celebration.textContent = 'üéâ Pok√©mon Caught! üéâ';
                    }
                    
                    setTimeout(() => {
                        celebration.style.display = 'block';
                        // Trigger success animation
                        modalSprite.classList.remove('catching');
                        modalSprite.classList.add('caught-success');
                    }, 800);

                    // Mark as caught
                    caughtPokemon[currentPokemon.number] = true;
                    localStorage.setItem('caughtPokemon', JSON.stringify(caughtPokemon));
                    
                    saveGameStats();
                    updateStreakDisplay();
                    updateBadgeCount();
                    checkBadges();

                    setTimeout(() => {
                        modalSprite.classList.remove('caught-success');
                        closeModal();
                        // Reset all bushes for new round after catching Pokemon
                        resetBushes();
                    }, 2000);
                } else {
                    // Empty bush - mark it as checked
                    celebration.textContent = '‚úì Bush checked! Try another!';
                    
                    setTimeout(() => {
                        celebration.style.display = 'block';
                        modalSprite.classList.remove('catching');
                    }, 800);
                    
                    saveGameStats();
                    updateStreakDisplay();
                    updateBadgeCount();
                    checkBadges();

                    // Mark this bush as checked
                    checkedBushes.push(selectedBush);
                    document.getElementById(`bush-${selectedBush}`).classList.add('checked');

                    setTimeout(() => {
                        closeModal();
                        
                        // Check if all bushes are checked
                        if (checkedBushes.length === 3) {
                            // All bushes checked, reset for new round
                            setTimeout(() => {
                                resetBushes();
                                document.getElementById('bushHeader').textContent = 'üåø No Pok√©mon this time! Try again! üåø';
                            }, 500);
                        }
                    }, 1500);
                }
            } else {
                // Wrong answer - Pokemon runs away or stays in bush
                feedback.textContent = '‚úó Wrong answer!';
                feedback.className = 'feedback incorrect';
                
                // Play failure sound
                playFailureSound();
                
                // Reset streak
                gameStats.currentStreak = 0;
                saveGameStats();
                updateStreakDisplay();
                
                if (currentPokemon) {
                    // Pokemon runs away - trigger run animation
                    modalSprite.classList.add('run-away');
                    
                    setTimeout(() => {
                        closeModal();
                        showRanAwayNotification(currentPokemon.name);
                        modalSprite.classList.remove('run-away');
                        // Reset bushes after Pokemon runs away
                        setTimeout(() => {
                            resetBushes();
                        }, 2000);
                    }, 800);
                } else {
                    // Empty bush - just close modal, don't mark as checked
                    setTimeout(() => {
                        closeModal();
                    }, 1500);
                }
            }
        }

        // Show ran away notification
        function showRanAwayNotification(pokemonName) {
            const notification = document.getElementById('ranAwayNotification');
            document.getElementById('pokemonName').textContent = pokemonName;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        // Show reset confirmation modal
        function showResetConfirmation() {
            const count = Object.keys(caughtPokemon).length;
            if (count === 0) {
                alert("You haven't caught any Pok√©mon yet!");
                return;
            }
            document.getElementById('confirmCount').textContent = count;
            document.getElementById('confirmModal').classList.add('active');
        }

        // Close reset confirmation modal
        function closeResetConfirmation() {
            document.getElementById('confirmModal').classList.remove('active');
        }

        // Confirm and execute reset
        function confirmReset() {
            caughtPokemon = {};
            localStorage.setItem('caughtPokemon', JSON.stringify(caughtPokemon));
            closeResetConfirmation();
            initializeGrid();
            
            // Show success notification
            const notification = document.getElementById('ranAwayNotification');
            notification.innerHTML = 'üîÑ All Pok√©mon released! Start fresh! üîÑ';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
                notification.innerHTML = 'üí® <span id="pokemonName"></span> ran away! üí®';
            }, 2500);
        }

        // Show full game reset confirmation
        function showFullResetConfirmation() {
            const pokemonCount = Object.keys(caughtPokemon).length;
            const badgeCount = gameStats.unlockedBadges.length;
            
            document.getElementById('fullResetCount').textContent = pokemonCount;
            document.getElementById('fullResetBadges').textContent = badgeCount;
            document.getElementById('fullResetModal').classList.add('active');
        }

        // Close full game reset confirmation
        function closeFullResetConfirmation() {
            document.getElementById('fullResetModal').classList.remove('active');
        }

        // Confirm and execute full game reset
        function confirmFullReset() {
            // Clear all data
            localStorage.removeItem('caughtPokemon');
            localStorage.removeItem('gameStats');
            localStorage.removeItem('operationMode');
            localStorage.removeItem('gradeLevel');
            localStorage.removeItem('allowedOperations');
            localStorage.removeItem('isMuted');
            
            // Reset all variables to defaults
            caughtPokemon = {};
            gameStats = {
                totalProblems: 0,
                correctAnswers: 0,
                currentStreak: 0,
                bestStreak: 0,
                operationCounts: { addition: 0, subtraction: 0, multiplication: 0, division: 0 },
                unlockedBadges: []
            };
            operationMode = 'random';
            gradeLevel = 4;
            allowedOperations = ['addition', 'subtraction', 'multiplication', 'division'];
            isMuted = false;
            
            closeFullResetConfirmation();
            
            // Show success notification
            const notification = document.getElementById('ranAwayNotification');
            notification.innerHTML = '‚ú® Game completely reset! Welcome back, Trainer! ‚ú®';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
                notification.innerHTML = 'üí® <span id="pokemonName"></span> ran away! üí®';
            }, 3000);
            
            // Update all displays
            updateBadgeCount();
            updateStreakDisplay();
            updateMuteButton();
            setOperation('random');
            document.getElementById('gradeLevel').value = 4;
            initializeGrid();
        }

        // Open badge modal
        function openBadgeModal() {
            renderBadges();
            updateStatsDisplay();
            document.getElementById('badgeModal').classList.add('active');
        }

        // Close badge modal
        function closeBadgeModal() {
            document.getElementById('badgeModal').classList.remove('active');
        }

        // Render badges in modal
        function renderBadges() {
            const grid = document.getElementById('badgesGrid');
            grid.innerHTML = '';

            badges.forEach(badge => {
                const isUnlocked = gameStats.unlockedBadges.includes(badge.id);
                const progress = getBadgeProgress(badge);
                
                const badgeEl = document.createElement('div');
                badgeEl.className = `badge-item ${isUnlocked ? 'unlocked' : 'locked'}`;
                
                badgeEl.innerHTML = `
                    <div class="badge-icon">${badge.icon}</div>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                    ${!isUnlocked ? `<div class="badge-progress">${progress}</div>` : '<div class="badge-progress">‚úì Unlocked!</div>'}
                `;
                
                grid.appendChild(badgeEl);
            });
        }

        // Get badge progress text
        function getBadgeProgress(badge) {
            switch(badge.id) {
                case 'math_trainer':
                    return `${Object.keys(caughtPokemon).length}/10 caught`;
                case 'gym_leader':
                    return `${Object.keys(caughtPokemon).length}/50 caught`;
                case 'champion':
                    return `${Object.keys(caughtPokemon).length}/150 caught`;
                case 'speed_demon':
                case 'no_mistakes':
                    return `${gameStats.currentStreak}/5 streak`;
                case 'operation_master_add':
                    return `${gameStats.operationCounts.addition}/20 completed`;
                case 'operation_master_sub':
                    return `${gameStats.operationCounts.subtraction}/20 completed`;
                case 'operation_master_mult':
                    return `${gameStats.operationCounts.multiplication}/20 completed`;
                case 'operation_master_div':
                    return `${gameStats.operationCounts.division}/20 completed`;
                case 'perfect_ten':
                    return `${gameStats.bestStreak}/10 best streak`;
                case 'scholar':
                    return `${gameStats.totalProblems}/100 solved`;
                case 'ace_student':
                    const accuracy = gameStats.totalProblems > 0 ? Math.round((gameStats.correctAnswers / gameStats.totalProblems) * 100) : 0;
                    return `${accuracy}% accuracy (need 90%)`;
                default:
                    return 'In progress...';
            }
        }

        // Update stats display in modal
        function updateStatsDisplay() {
            document.getElementById('total-problems').textContent = gameStats.totalProblems;
            
            const accuracy = gameStats.totalProblems > 0 
                ? Math.round((gameStats.correctAnswers / gameStats.totalProblems) * 100) 
                : 0;
            document.getElementById('accuracy-rate').textContent = accuracy + '%';
            
            document.getElementById('best-streak').textContent = gameStats.bestStreak;
            
            // Find favorite operation
            const ops = gameStats.operationCounts;
            const favorite = Object.keys(ops).reduce((a, b) => ops[a] > ops[b] ? a : b);
            const favoriteIcons = {
                addition: '‚ûï Addition',
                subtraction: '‚ûñ Subtraction',
                multiplication: '‚úñÔ∏è Multiplication',
                division: '‚ûó Division'
            };
            document.getElementById('favorite-operation').textContent = 
                ops[favorite] > 0 ? favoriteIcons[favorite] : '-';
        }

        // Update stats
        function updateStats() {
            const count = Object.keys(caughtPokemon).length;
            document.getElementById('caught-count').textContent = count;
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('answerInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });
            
            updateMuteButton(); // Initialize mute button state
            setOperation(operationMode); // Initialize operation mode button state
            document.getElementById('gradeLevel').value = gradeLevel; // Initialize grade level dropdown
            updateBadgeCount(); // Initialize badge count
            updateStreakDisplay(); // Initialize streak display
            initializeGrid();
        });
    </script>
</body>
</html>
